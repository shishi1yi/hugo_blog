<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>消息中间件之ActiveMQ | 十十乙的博客</title>
<meta name="keywords" content="ActiveMQ">
<meta name="description" content="ActiveMQ的应用">
<meta name="author" content="
作者:&nbsp;十十乙">
<link rel="canonical" href="http://shaoyi.cc/posts/blog/mq/activemq/activemq/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.bb3fd15879e1b070bc3f661ad98fef35fef1f31a23b6bec0b04e5cb164937952.css" integrity="sha256-uz/RWHnhsHC8P2Ya2Y/vNf7x8xojtr7AsE5csWSTeVI=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="http://shaoyi.cc/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://shaoyi.cc/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://shaoyi.cc/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://shaoyi.cc/apple-touch-icon.png">
<link rel="mask-icon" href="http://shaoyi.cc/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="消息中间件之ActiveMQ" />
<meta property="og:description" content="ActiveMQ的应用" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://shaoyi.cc/posts/blog/mq/activemq/activemq/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-03T19:18:23&#43;08:00" />
<meta property="article:modified_time" content="2022-07-04T19:18:23&#43;08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="消息中间件之ActiveMQ"/>
<meta name="twitter:description" content="ActiveMQ的应用"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "📚文章",
      "item": "http://shaoyi.cc/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "📕技术",
      "item": "http://shaoyi.cc/posts/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "消息中间件之ActiveMQ",
      "item": "http://shaoyi.cc/posts/blog/mq/activemq/activemq/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "消息中间件之ActiveMQ",
  "name": "消息中间件之ActiveMQ",
  "description": "ActiveMQ的应用",
  "keywords": [
    "ActiveMQ"
  ],
  "articleBody": "ActiveMQ安装（Docker环境下） 首先在docker搜索ActiveMQ，发现webcenter/activemq 这个版本使用是最多的\n然后选择版本，下载activeMQ\n查看镜像，配置好activemq容器的后台端口（61616）和前台端口（8161）的映射关系，并启动它\n浏览器访问，如下图，便安装完成\nJMS实现消息的生产者和消费者 队列的方式 生产者：\nimport org.apache.activemq.ActiveMQConnectionFactory; import javax.jms.*; public class JmsProduce { private static final String ACTIVEMQ_URL=\"tcp://服务器公网ip:后台映射端口号\"; private static final String QUEUE_NAME=\"myQueue\"; public static void main(String[] args) throws JMSException { //创建连接工厂，指定active的url链接，不指定用户名和密码就是默认的。 ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(ACTIVEMQ_URL); //创建工厂后获取链接，并启动 Connection connection = connectionFactory.createConnection(); connection.start(); //创建会话，有两个参数，分别是事务和签收机制 Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE); //创建目的地（这里为队列方式） Destination destination = session.createQueue(QUEUE_NAME); //创建消息的生产者 MessageProducer messageProducer = session.createProducer(destination); //生产4条消息 for (int i = 1; i \u003c 5; i++) { //创建消息内容 TextMessage message = session.createTextMessage(\"第\" + i + \"条消息\"); //发送消息 messageProducer.send(message); } //关闭资源 messageProducer.close(); session.close(); connection.close(); System.out.println(\"消息发送完成！\"); } } 执行后的结果：\n消费者（receive()方法获取信息）：\nimport org.apache.activemq.ActiveMQConnectionFactory; import javax.jms.*; public class JmsConsumer { private static final String ACTIVEMQ_URL=\"tcp://服务器公网ip:后台映射端口号\"; private static final String QUEUE_NAME=\"myQueue\"; public static void main(String[] args) throws JMSException { //创建连接工厂，指定active的url链接，不指定用户名和密码就是默认的。 ActiveMQConnectionFactory activeMQConnectionFactory = new ActiveMQConnectionFactory(ACTIVEMQ_URL); //创建工厂后获取链接，并启动 Connection connection = activeMQConnectionFactory.createConnection(); connection.start(); //创建会话，有两个参数，分别是事务和签收机制 Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE); //创建目的地(这里为队列方式) Destination destination = session.createQueue(QUEUE_NAME); //创建消息的生产者 MessageConsumer messageConsumer = session.createConsumer(destination); while (true){ //读取消息 TextMessage textMessage = (TextMessage)messageConsumer.receive(); if (null !=textMessage){ //获取消息内容并打印 System.out.println(\"消费者接受的消息: \"+textMessage.getText()); }else { break; } } //关闭资源 messageConsumer.close(); session.close(); connection.close(); } } 执行结果：\n消费者（监听器MessageListener方式获取信息）\nimport org.apache.activemq.ActiveMQConnectionFactory; import javax.jms.*; import java.io.IOException; public class JmsConsumer02 { private static final String ACTIVEMQ_URL=\"tcp://服务器公网ip:后台映射端口号\"; private static final String QUEUE_NAME=\"myQueue\"; public static void main(String[] args) throws JMSException, IOException { //创建连接工厂，指定active的url链接，不指定用户名和密码就是默认的。 ActiveMQConnectionFactory activeMQConnectionFactory = new ActiveMQConnectionFactory(ACTIVEMQ_URL); //创建工厂后获取链接，并启动 Connection connection = activeMQConnectionFactory.createConnection(); connection.start(); //创建会话，有两个参数，分别是事务和签收机制 Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE); //创建目的地(这里为队列方式) Destination destination = session.createQueue(QUEUE_NAME); //创建消息的生产者 MessageConsumer messageConsumer = session.createConsumer(destination); messageConsumer.setMessageListener((message) -\u003e { if (null != message \u0026\u0026 message instanceof TextMessage){ TextMessage textMessage = (TextMessage) message; try { System.out.println(\"消费者接受的消息: \"+textMessage.getText()); } catch (JMSException e) { e.printStackTrace(); } } }); System.in.read(); //防止消息还没有读取到就关闭资源了 //关闭资源 messageConsumer.close(); session.close(); connection.close(); } } 消费者获取消息的方式\nreceive() 方法：该方法是同步阻塞的，如果调用者（队列或者订阅方）没有接受到消息，就会一直等待\n除此之外它有一个重载方法 receive(long timeout) ，参数表示的是 等待的超时时间（毫秒），在等待时间内没有接受到消息就自动停止\nsetMessageListener(MessageListener listener) 方法：该方法是异步非阻塞的，而方法参数类型是MessageListener接口，这个接口里只定义了一个用于处理接收到的消息的onMessage方法，该方法只接收一个Message参数监听器。当消息到达之后，会自动调用onMessage方法获取信息\n消费者的三种情况\n先启动生产者，生产消息，然后再启动一个消费者，是否可以正常消费信息 ？\n答案：可以的 还是先启动生产者，生产消息，再分别启动两个消费者，后一个启动的消费者可以消费到消息吗 ？\n答案：否，后一个启动的消费者是消费不到的消息，消息都被前一个启动的消息者消费完了 先启动两个消费者，再启动生产者生产6条消息，结果如何 ？\n答案：消息被平分，两个消费者一人一半，分别消费3条消息 发布订阅方式 生产者：\nimport org.apache.activemq.ActiveMQConnectionFactory; import javax.jms.*; public class JmsProduce_Topic { private static final String ACTIVEMQ_URL=\"tcp://服务器公网ip:后台映射端口号\"; private static final String TOPIC_NAME=\"myTopic\"; public static void main(String[] args) throws JMSException { //创建连接工厂，指定active的url链接，不指定用户名和密码就是默认的。 ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(ACTIVEMQ_URL); //创建工厂后获取链接，并启动 Connection connection = connectionFactory.createConnection(); connection.start(); //创建会话，有两个参数，分别是事务和签收机制 Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE); //创建目的地（这里为发布订阅方式） Destination destination = session.createTopic(TOPIC_NAME); //创建消息的生产者 MessageProducer messageProducer = session.createProducer(destination); //生产4条消息 for (int i = 1; i \u003c 5; i++) { //创建消息内容 TextMessage message = session.createTextMessage(\"第\" + i + \"条消息\"); //发送消息 messageProducer.send(message); } //关闭资源 messageProducer.close(); session.close(); connection.close(); System.out.println(\"消息发送完成！\"); } } ​\t发布订阅的方式和队列方式， 从生产者的代码可以发现，两者是一样的，唯一不同的就是，创建目的地的方法不一样，队列是createQueue(String queueName)，而发布订阅是createTopic(String topicName)。同样的，消费者的代码和队列也是一样的\n消费者\nimport org.apache.activemq.ActiveMQConnectionFactory; import javax.jms.*; import java.io.IOException; public class JmsConsumer_Topic { private static final String ACTIVEMQ_URL=\"tcp://服务器公网ip:后台映射端口号\"; private static final String TOPIC_NAME=\"myTopic\"; public static void main(String[] args) throws JMSException, IOException { //创建连接工厂，指定active的url链接，不指定用户名和密码就是默认的。 ActiveMQConnectionFactory activeMQConnectionFactory = new ActiveMQConnectionFactory(); //创建工厂后获取链接，并启动 Connection connection = activeMQConnectionFactory.createConnection(); connection.start(); //创建会话，有两个参数，分别是事务和签收机制 Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE); //创建目的地（这里为发布订阅方式） Destination destination = session.createTopic(TOPIC_NAME); //创建消息的生产者 MessageConsumer messageConsumer = session.createConsumer(destination); //通过监听器，接受消息 messageConsumer.setMessageListener((message) -\u003e { if (null != message \u0026\u0026 message instanceof TextMessage) { try { TextMessage textMessage = (TextMessage) message; System.out.println(\"消费者接受的消息: \" + textMessage.getText()); } catch (JMSException e) { e.printStackTrace(); } } }); System.in.read();//阻塞等待 //关闭资源 messageConsumer.close(); session.close(); connection.close(); } } ​\t不过要注意的是，发布订阅的模式，要先启用订阅方，也就是消费者方，再启动发布方（生产者）。否则，就类似微信公众号一样，没有人订阅，生产方发布消息是没有人接受的到，会被丢弃。这种则是废消息。\n队列和发布订阅两者对比 比 较 项 目 Topic （发布订阅）模式 Queue （队列）模式 工 作 模 式 “订阅-发布”模式，如果当前没有订阅 者，消息将会被丢弃，如果有多个订阅 者，那么这些订阅者都会收到消息。 负载均衡 模式，如果当前没有消费者，消息也不会丢弃，如果有多个消费者，那么一条消息 也只会发送给其中一个消费者，并且要求消费者ack信息 有 无 状 态 无状态 Queue 数据默认会在 mq 服务器上以文件形式 保存，比如 Active MQ 一般保存在 $AMQ_HOME\\data\\kr-store\\data下面，也可 以配置成DB存储 传 递 完 整 性 如果没有订阅者，消息会被丢弃 消息不会丢弃 处 理 效 率 由于消息要按照订阅者的数量进行复 制，所以处理性能会随着订阅者的增加 而明显降低，并且还要结合不同消息协 议自身的性能差异 由于一条消息只发送给一个消费者，所以就算 消费者再多，性能也不会有明显降低。当然不 同消息协议的具体性能也是有差异的。 JMS ​\tJMS是Java EE的一个面向消息中间件的一套规范，具体需要靠厂商的产品实现\n消息的三种部分 消息头 在生产者方，消息的API看出可以针对每一条消息设置不同的消息头属性 如果不想为每一条消息单独设置消息头属性，可以通过Send()方法的重载，批处理消息的消息头属性 从批处理消息头属性和单独设置消息头属性两者结合来看，主要介绍五个消息头属性： JMSDestination： 消息发送的目的地，主要是指 Queue 和 Topic\nJMSDeliveryMode： 持久模式和非持久模式，可设置的参数为DeliveryMode.NON_PERSISTENT(非持久) 和 DeliveryMode.PERSISTENT(持久)\n一条持久性的消息：应该被传送 “一次仅仅一次”，这就意味着如果JMS 提供者出现故障，该消息并不会丢失，它会在服务器恢复之后再次传递消息。 一条非持久的消息：多会传送一次，这意味着服务器出现故障，该消息将永久丢失。\nJMSPriority ： 消息优先级，从0 ~ 9 十个级别，0 ~ 4 是普通消息，5 ~ 9是加急消息。\nJMS 不要求 MQ 严格按照这十个优先级发送消息，但必须保证加急消息要先于普通消息到达，默认是4 级。\nJMSExpiration： 可以设置消息在一定时间后过期，默认是永不过期。消息过期时间，等于Destination的send方法中的timeToLive值加上发送时刻的GMT时间\n值。 如果timeToLive值等于零，则 JMSExpiration 被设为零，表示该消息永不过期。如果发送后，在消息过期时间之后消息还没有被发送到目的地，则该消息被清除。\nJMSMessageID ： 唯一识别每个消息的标识，由MQ产生。\n消息体 封装具体的消息数据，发送和接收的消息体类型必须一致对应！\n五种消息体格式：\nTextMessage： 普通字符串消息，包含一个String 。\nMapMessage： 一个Map类型的消息，key为String类型，而值为Java的基本类型。\nBytesMessage ： 二进制数组消息，包含一个byte[] 。\nStreamMessage ： Java数据流消息，用标准流操作来顺序的填充和读取。\nObjectMessage ：对象消息，包含一个可序列化的 Java 对象。\n消息属性 如果需要除消息头字段以外的值，那么可以使用消息属性！\n识别、去重、重点标注等操作非常有用的方法！\n消息属性是以属性名和属性值对的形式指定的。可以将属性是为消息头的扩展，属性指定一些消息头没有包括的附加信息，比如可以在属性里指定消息选择器。\n以Property结尾：\n消息的可靠性 持久性 队列 //创建目的地（这里为队列方式） Destination destination = session.createQueue(QUEUE_NAME); //创建消息的生产者 MessageProducer messageProducer = session.createProducer(destination); // 非持久化 ：服务器宕机，则消息不能恢复 messageProducer.setDeliveryMode(DeliveryMode.NON_PERSISTENT); // 持久化 ：服务器宕机，消息可以恢复 messageProducer.setDeliveryMode(DeliveryMode.PERSISTENT); 队列是否设置为持久，可以通过setDeliveryMode(int deliveryMode)方法设置，默认为持久\n持久性 发布订阅 发布方（生产者），顺序与之前有一点不同，需要设定先持久化，在启动连接\n测试代码：\nimport org.apache.activemq.ActiveMQConnectionFactory; import javax.jms.*; public class JmsProduce_Topic_DeliveryMode { private static final String ACTIVEMQ_URL=\"tcp://服务器公网ip:后台映射端口号\"; private static final String TOPIC_NAME=\"my_topic_persist\"; public static void main(String[] args) throws JMSException { ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(ACTIVEMQ_URL); Connection connection = connectionFactory.createConnection(); Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE); Topic topic = session.createTopic(TOPIC_NAME); MessageProducer messageProducer = session.createProducer(topic); //设置发布方为 持久 messageProducer.setDeliveryMode(DeliveryMode.PERSISTENT); //设定为持久后，然后连接 connection.start(); for (int i = 1; i \u003c=3; i++) { TextMessage message = session.createTextMessage(\"第\" + i + \"条消息\"); messageProducer.send(message); } //关闭资源 messageProducer.close(); session.close(); connection.close(); System.out.println(\"消息发送完成！\"); } } 订阅方（消费者）测试代码：\nimport org.apache.activemq.ActiveMQConnectionFactory; import javax.jms.*; public class JmsConsumer_Topic_DeliveryMode { private static final String ACTIVEMQ_URL=\"tcp://服务器公网ip:后台映射端口号\"; private static final String TOPIC_NAME=\"my_topic_persist\"; public static void main(String[] args) throws JMSException { ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(ACTIVEMQ_URL); Connection connection = connectionFactory.createConnection(); //订阅方的id connection.setClientID(\"001\"); Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE); Topic topic = session.createTopic(TOPIC_NAME); //创建持久的订阅方 TopicSubscriber topicSubscriber = session.createDurableSubscriber(topic, \"十十乙\"); //持久化后，再进行连接 connection.start(); Message message = topicSubscriber.receive(); while (null != message){ TextMessage textMessage = (TextMessage)message; System.out.println(\"订阅方收到的消息：\"+textMessage.getText()); message = topicSubscriber.receive(3000L); } topicSubscriber.close(); session.close(); connection.close(); } } 先启动订阅方，再启动发布方，到ActiveMQ前台的Subscribers查看\n启动前情况：\n启动订阅方后情况：\n启动生产方 后：\n订阅方停止后，会被列 离线的一栏去：\n如果这时，发布者再次发布消息，订阅方重启启动是否能接收到消息\n再次启动订阅方(不停止)后\n小结：\n​\t第一次，一定要先启动订阅方，之后启动发布方，发布消息。这时不论订阅方在不在线，都可以接受到消息，不在线，重新启动后会接受没有收到过的消息接受下来\n事务 事务偏向于生产者、签收偏向于消费者\n//创建会话，有两个参数，分别是事务和签收机制 Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE); 事务只有两个值，true和false\n生产者一方\n当值为false时，消息会被自动发送到目的地\n当值为true时，需要在调用send()方法后，调用commit()方法，手动提交\n消费者一方\n当值为false时，消息只会被消费一次\n当值为true时，消息会被重复消费，且在目的地中，消息不会出队的，即未被消费\n测试：\n//创建会话，开启事务 Session session = connection.createSession(true, Session.AUTO_ACKNOWLEDGE); try { //OK,就提交 session.commit(); } catch (JMSException e) { //error,就回滚 session.rollback(); }finally { //关闭资源 } 签收机制 签收针对的是消费者一方，分为以下四种\npublic interface Session extends Runnable { static final int AUTO_ACKNOWLEDGE = 1; //自动签收（默认） static final int CLIENT_ACKNOWLEDGE = 2;\t//手动签收，需要调用 message.acknowledge(); 进行签收，否则也会导致重复消费 static final int DUPS_OK_ACKNOWLEDGE = 3;\t//自动批量确认 static final int SESSION_TRANSACTED = 0;\t//这个是配合事务，当事务开启则选择这个，主要是一个语法的一个规范而已 当事务没有开启时 ： 即非事务，消息的确认情况 则以签收机制为主\n当事务开始时 ： 即事务情况下，消息的确认以事务为主，即是否commit的为主，不用管签收机制的情况。\n注：常用的签收模式 主要以自动签收（AUTO_ACKNOWLEDGE）和手动签收（CLIENT_ACKNOWLEDGE）为主\nSpringBoot结合ACtiveMQ 队列模式 1、导入maven依赖\norg.springframework.boot spring-boot-starter-web org.springframework.boot spring-boot-starter-activemq 2、编写application.properties配置文件\nserver.port=8888 # 配置activemq的链接，用户名和密码 spring.activemq.broker-url=tcp://服务器公网ip:端口号 spring.activemq.user=admin spring.activemq.password=admin #配置是否为发布订阅模式 #false为队列（默认） #ture为发布订阅 spring.jms.pub-sub-domain=false #队列名称（自定义标签） myqueue=activemq_springboot_queue 3、编写配置类\npackage com.shishiyi.config; import org.apache.activemq.command.ActiveMQQueue; import org.springframework.beans.factory.annotation.Value; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import javax.jms.Queue; @Configuration public class ActiveMQConfig { //注入队列名称 @Value(\"${myqueue}\") private String myQueue_name; //向spring容器导入队列对象 @Bean public Queue queue(){ return new ActiveMQQueue(myQueue_name); } } 4、编写队列的消息生产者Produce\npackage com.shishiyi.queue; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.jms.core.JmsMessagingTemplate; import org.springframework.stereotype.Component; import javax.jms.Queue; @Component public class QueueProduce { @Autowired private JmsMessagingTemplate jmsMessagingTemplate; @Autowired private Queue queue_name; public void produceSend(){ //发送消息 jmsMessagingTemplate.convertAndSend(queue_name,\"生产者生产消息\"); } } 5、编写controller类，并访问接口\npackage com.shishiyi.controller; import com.shishiyi.queue.QueueProduce; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RestController; @RestController public class QueueProduceController { @Autowired private QueueProduce queueProduce; @GetMapping(\"/queuesend\") public void queueSend(){ queueProduce.produceSend(); System.out.println(\"消息发送成功\"); } } 查看ActiveMQ的前台，消息已经发送到队列了\n6、编写队列的消费者\npackage com.shishiyi.queue; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.jms.annotation.JmsListener; import org.springframework.jms.core.JmsMessagingTemplate; import org.springframework.stereotype.Component; import javax.jms.JMSException; import javax.jms.Message; import javax.jms.TextMessage; @Component public class QueueConsumer { @Autowired private JmsMessagingTemplate jmsMessagingTemplate; //采用监听器的方式获取消息 @JmsListener(destination = \"${myqueue}\") public void receive(Message message) throws JMSException { if (null !=message \u0026\u0026 message instanceof TextMessage){ TextMessage textMessage = (TextMessage)message; System.out.println(\"消费者已经接受到了\"+textMessage.getText()); } } } 删除之前入队的信息，然后重新启动 启动类，再次访问接口，并查看ActiveMQ的前台和打印台\n订阅发布模式 1、导入maven依赖\norg.springframework.boot spring-boot-starter-web org.springframework.boot spring-boot-starter-activemq 2、编写application.properties配置文件\nserver.port=7777 # 配置activemq的链接，用户名和密码 spring.activemq.broker-url=tcp://服务器公网ip:端口号 spring.activemq.user=admin spring.activemq.password=admin #配置是否为发布订阅模式 #false为队列（默认） #ture为发布订阅 spring.jms.pub-sub-domain=true #topic名称 mytopic=activemq_springboot_topic 3、编写配置类\npackage com.shishiyi.config; import org.apache.activemq.command.ActiveMQTopic; import org.springframework.beans.factory.annotation.Value; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import javax.jms.Topic; @Configuration public class ActiveMQConfig { @Value(\"${mytopic}\") private String myTopic; @Bean public Topic topic(){ return new ActiveMQTopic(myTopic); } } 4、编写主题的消息生产者（发布方）\npackage com.shishiyi.topic; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.jms.core.JmsMessagingTemplate; import org.springframework.stereotype.Component; import javax.jms.Topic; @Component public class TopicProduce { @Autowired private JmsMessagingTemplate jmsMessagingTemplate; @Autowired private Topic topic; public void topicSend(){ jmsMessagingTemplate.convertAndSend(topic,\"发布方向主题发布的消息\"); System.out.println(\"消息发送成功\"); } } 5、编写controller类\npackage com.shishiyi.controller; import com.shishiyi.topic.TopicProduce; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RestController; @RestController public class TopicProduceController { @Autowired private TopicProduce topicProduce; @GetMapping(\"/topicSend\") public void topicSend(){ topicProduce.topicSend(); } } 6、编写主题的消费者（订阅方）\npackage com.shishiyi.topic; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.jms.annotation.JmsListener; import org.springframework.jms.core.JmsMessagingTemplate; import org.springframework.stereotype.Component; import javax.jms.*; @Component public class TopicConsumer { @Autowired private JmsMessagingTemplate jmsMessagingTemplate; @JmsListener(destination = \"${mytopic}\") public void receive(Message message) throws JMSException { if (null != message \u0026\u0026 message instanceof TextMessage){ TextMessage textMessage = (TextMessage) message; System.out.println(\"订阅方收到的消息：\"+textMessage.getText()); } } } 7、启动主启动类，访问接口，让发布方生产消息，并查看ActiveMQ的前台和打印台\n定时的订阅发布模式\n让发布方每过5秒，发送一次消息\n//创建定时任务 package com.shishiyi.topic; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.jms.core.JmsMessagingTemplate; import org.springframework.scheduling.annotation.Scheduled; import org.springframework.stereotype.Component; import javax.jms.Topic; @Component public class TopicProduce { @Autowired private JmsMessagingTemplate jmsMessagingTemplate; @Autowired private Topic topic; public void topicSend(){ jmsMessagingTemplate.convertAndSend(topic,\"发布方向主题发布的消息\"); System.out.println(\"消息发送成功\"); } //创建定时任务，每隔5秒发布消息 @Scheduled(fixedRate = 5000L) public void scheduled(){ topicSend(); } } 添加 @EnableScheduling 注解，发现定时任务让它后台执行\n修改主题的消费者（订阅方），添加LocalDateTime.now()方法，方便在控制台查看\npackage com.shishiyi.topic; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.jms.annotation.JmsListener; import org.springframework.jms.core.JmsMessagingTemplate; import org.springframework.stereotype.Component; import javax.jms.*; import java.time.LocalDateTime; @Component public class TopicConsumer { @Autowired private JmsMessagingTemplate jmsMessagingTemplate; @JmsListener(destination = \"${mytopic}\") public void receive(Message message) throws JMSException { if (null != message \u0026\u0026 message instanceof TextMessage){ TextMessage textMessage = (TextMessage) message; System.out.println(\"订阅方收到的消息：\"+textMessage.getText()+ \"时间为：\" +LocalDateTime.now()); } } } 启动程序，查看控制台打印内容，以及（同一时间点内）查看ActiveMQ的前台\nActiveMQ传输协议 在连接activemq时，默认是用TCP连接，那Activemq是否还支持其它协议吗？\n查看activemq的conf文件夹下的activemq.xml\n可以看出，除了支持默认的TCP协议，还支持 amqp ，stomp，mqtt，ws等协议，而且协议对应的端口号也不一样，这就是用TCP连接时，端口号是61616的原因了。\n从activemq前台也可以查看出来\n如果想配置其它协议，可以查看官网的文档\nhttp://activemq.apache.org/configuring-version-5-transports\n配置NIO协议 从官网的文档得知，配置NIO协议，只需要修改activemq.xml文件\n",
  "wordCount" : "9357",
  "inLanguage": "zh",
  "datePublished": "2020-07-03T19:18:23+08:00",
  "dateModified": "2022-07-04T19:18:23+08:00",
  "author":[{
    "@type": "Person",
    "name": "十十乙"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://shaoyi.cc/posts/blog/mq/activemq/activemq/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "十十乙的博客",
    "logo": {
      "@type": "ImageObject",
      "url": "http://shaoyi.cc/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://shaoyi.cc/" accesskey="h" title="十十乙的博客 (Alt + H)">十十乙的博客</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://shaoyi.cc/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="http://shaoyi.cc/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="http://shaoyi.cc/search" title="🔍 搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍 搜索</span>
                </a>
            </li>
            <li>
                <a href="http://shaoyi.cc/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="http://shaoyi.cc/tags/" title="🧩标签">
                    <span>🧩标签</span>
                </a>
            </li>
            <li>
                <a href="http://shaoyi.cc/about" title="🙋🏻‍♂️关于">
                    <span>🙋🏻‍♂️关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://shaoyi.cc/">主页</a>&nbsp;»&nbsp;<a href="http://shaoyi.cc/posts/">📚文章</a>&nbsp;»&nbsp;<a href="http://shaoyi.cc/posts/blog/">📕技术</a></div>
    <h1 class="post-title">
      消息中间件之ActiveMQ
    </h1>
    <div class="post-description">
      ActiveMQ的应用
    </div>
    <div class="post-meta">









创建:&nbsp;<span title='2020-07-03 19:18:23 +0800 CST'>2020-07-03</span>&nbsp;·&nbsp;更新:&nbsp;2022-07-04&nbsp;·&nbsp;字数:&nbsp;9357字&nbsp;·&nbsp;
作者:&nbsp;十十乙

</div>
  </header> <aside id="toc-container" class="toc-container wide">
        <div class="toc">
            <details  open>
                <summary accesskey="c" title="(Alt + C)">
                    <span class="details">目录</span>
                </summary>

                <div class="inner"><ul>
                        <li>
                            <a href="#activemq%e5%ae%89%e8%a3%85docker%e7%8e%af%e5%a2%83%e4%b8%8b" aria-label="ActiveMQ安装（Docker环境下）">ActiveMQ安装（Docker环境下）</a></li>
                        <li>
                            <a href="#jms%e5%ae%9e%e7%8e%b0%e6%b6%88%e6%81%af%e7%9a%84%e7%94%9f%e4%ba%a7%e8%80%85%e5%92%8c%e6%b6%88%e8%b4%b9%e8%80%85" aria-label="JMS实现消息的生产者和消费者">JMS实现消息的生产者和消费者</a><ul>
                                    
                        <li>
                            <a href="#%e9%98%9f%e5%88%97%e7%9a%84%e6%96%b9%e5%bc%8f" aria-label="队列的方式">队列的方式</a></li>
                        <li>
                            <a href="#%e5%8f%91%e5%b8%83%e8%ae%a2%e9%98%85%e6%96%b9%e5%bc%8f" aria-label="发布订阅方式">发布订阅方式</a></li>
                        <li>
                            <a href="#%e9%98%9f%e5%88%97%e5%92%8c%e5%8f%91%e5%b8%83%e8%ae%a2%e9%98%85%e4%b8%a4%e8%80%85%e5%af%b9%e6%af%94" aria-label="队列和发布订阅两者对比">队列和发布订阅两者对比</a></li></ul>
                        </li>
                        <li>
                            <a href="#jms" aria-label="JMS">JMS</a><ul>
                                    
                        <li>
                            <a href="#%e6%b6%88%e6%81%af%e7%9a%84%e4%b8%89%e7%a7%8d%e9%83%a8%e5%88%86" aria-label="消息的三种部分">消息的三种部分</a><ul>
                                    
                        <li>
                            <a href="#%e6%b6%88%e6%81%af%e5%a4%b4" aria-label="消息头">消息头</a></li>
                        <li>
                            <a href="#%e6%b6%88%e6%81%af%e4%bd%93" aria-label="消息体">消息体</a></li>
                        <li>
                            <a href="#%e6%b6%88%e6%81%af%e5%b1%9e%e6%80%a7" aria-label="消息属性">消息属性</a></li></ul>
                        </li>
                        <li>
                            <a href="#%e6%b6%88%e6%81%af%e7%9a%84%e5%8f%af%e9%9d%a0%e6%80%a7" aria-label="消息的可靠性">消息的可靠性</a><ul>
                                    
                        <li>
                            <a href="#%e6%8c%81%e4%b9%85%e6%80%a7-%e9%98%9f%e5%88%97" aria-label="持久性 队列">持久性 队列</a></li>
                        <li>
                            <a href="#%e6%8c%81%e4%b9%85%e6%80%a7--%e5%8f%91%e5%b8%83%e8%ae%a2%e9%98%85" aria-label="持久性  发布订阅">持久性  发布订阅</a></li>
                        <li>
                            <a href="#%e4%ba%8b%e5%8a%a1" aria-label="事务">事务</a></li>
                        <li>
                            <a href="#%e7%ad%be%e6%94%b6%e6%9c%ba%e5%88%b6" aria-label="签收机制">签收机制</a></li></ul>
                        </li></ul>
                        </li>
                        <li>
                            <a href="#springboot%e7%bb%93%e5%90%88activemq" aria-label="SpringBoot结合ACtiveMQ">SpringBoot结合ACtiveMQ</a><ul>
                                    
                        <li>
                            <a href="#%e9%98%9f%e5%88%97%e6%a8%a1%e5%bc%8f" aria-label="队列模式">队列模式</a></li>
                        <li>
                            <a href="#%e8%ae%a2%e9%98%85%e5%8f%91%e5%b8%83%e6%a8%a1%e5%bc%8f" aria-label="订阅发布模式">订阅发布模式</a></li></ul>
                        </li>
                        <li>
                            <a href="#activemq%e4%bc%a0%e8%be%93%e5%8d%8f%e8%ae%ae" aria-label="ActiveMQ传输协议">ActiveMQ传输协议</a><ul>
                                    <ul>
                                    
                        <li>
                            <a href="#%e9%85%8d%e7%bd%aenio%e5%8d%8f%e8%ae%ae" aria-label="配置NIO协议">配置NIO协议</a></li></ul>
                                </ul>
                        </li>
                        <li>
                            <a href="#activemq%e6%8c%81%e4%b9%85%e5%8c%96" aria-label="ActiveMQ持久化">ActiveMQ持久化</a><ul>
                                    
                        <li>
                            <a href="#kahadb%e9%bb%98%e8%ae%a4" aria-label="KahaDB(默认)">KahaDB(默认)</a></li>
                        <li>
                            <a href="#leveldb" aria-label="LevelDB">LevelDB</a></li>
                        <li>
                            <a href="#jdbc" aria-label="JDBC">JDBC</a>
                        </li>
                    </ul>
                    </li>
                    </ul>
                </div>
            </details>
        </div>
    </aside>
    <script>
        let activeElement;
        let elements;
        window.addEventListener('DOMContentLoaded', function (event) {
            checkTocPosition();

            elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }, false);

        window.addEventListener('resize', function (event) {
            checkTocPosition();
        }, false);

        window.addEventListener('scroll', () => {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                    (getOffsetTop(element) - window.pageYOffset) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement

            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                if (element === activeElement) {
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
                } else {
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
                }
            })
        }, false);

        const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
        const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
        const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

        function checkTocPosition() {
            const width = document.body.scrollWidth;

            if (width - main - (toc * 2) - (gap * 4) > 0) {
                document.getElementById("toc-container").classList.add("wide");
            } else {
                document.getElementById("toc-container").classList.remove("wide");
            }
        }

        function getOffsetTop(element) {
            if (!element.getClientRects().length) {
                return 0;
            }
            let rect = element.getBoundingClientRect();
            let win = element.ownerDocument.defaultView;
            return rect.top + win.pageYOffset;
        }
    </script>
  <div class="post-content"><h1 id="activemq安装docker环境下">ActiveMQ安装（Docker环境下）<a hidden class="anchor" aria-hidden="true" href="#activemq安装docker环境下">#</a></h1>
<p>首先在docker搜索ActiveMQ，发现<strong>webcenter/activemq</strong>  这个版本使用是最多的</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/20/wTXzlT.png" alt="wTXzlT.png"  />
</p>
<p>然后选择版本，下载activeMQ</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/20/wTj63V.png" alt="wTj63V.png"  />
</p>
<p>查看镜像，配置好activemq容器的后台端口（61616）和前台端口（8161）的映射关系，并启动它</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/20/wTvBrD.png" alt="wTvBrD.png"  />
</p>
<p>浏览器访问，如下图，便安装完成</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/20/wTzvE4.png" alt="wTzvE4.png"  />
</p>
<h1 id="jms实现消息的生产者和消费者">JMS实现消息的生产者和消费者<a hidden class="anchor" aria-hidden="true" href="#jms实现消息的生产者和消费者">#</a></h1>
<h2 id="队列的方式">队列的方式<a hidden class="anchor" aria-hidden="true" href="#队列的方式">#</a></h2>
<blockquote>
<p>生产者：</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.activemq.ActiveMQConnectionFactory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.jms.*;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JmsProduce {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String ACTIVEMQ_URL=<span style="color:#0ff;font-weight:bold">&#34;tcp://服务器公网ip:后台映射端口号&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String QUEUE_NAME=<span style="color:#0ff;font-weight:bold">&#34;myQueue&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> JMSException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建连接工厂，指定active的url链接，不指定用户名和密码就是默认的。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ActiveMQConnectionFactory connectionFactory = <span style="color:#fff;font-weight:bold">new</span> ActiveMQConnectionFactory(ACTIVEMQ_URL);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建工厂后获取链接，并启动
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Connection connection = connectionFactory.<span style="color:#007f7f">createConnection</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建会话，有两个参数，分别是事务和签收机制
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Session session = connection.<span style="color:#007f7f">createSession</span>(<span style="color:#fff;font-weight:bold">false</span>, Session.<span style="color:#007f7f">AUTO_ACKNOWLEDGE</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建目的地（这里为队列方式）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Destination destination = session.<span style="color:#007f7f">createQueue</span>(QUEUE_NAME);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建消息的生产者
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        MessageProducer messageProducer = session.<span style="color:#007f7f">createProducer</span>(destination);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//生产4条消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 1; i &lt; 5; i++) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//创建消息内容
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            TextMessage message = session.<span style="color:#007f7f">createTextMessage</span>(<span style="color:#0ff;font-weight:bold">&#34;第&#34;</span> + i + <span style="color:#0ff;font-weight:bold">&#34;条消息&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//发送消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            messageProducer.<span style="color:#007f7f">send</span>(message);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//关闭资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        messageProducer.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        session.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;消息发送完成！&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>执行后的结果：</strong></p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/20/w79mct.png" alt="w79mct.png"  />
</p>
<blockquote>
<p>消费者（receive()方法获取信息）：</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.activemq.ActiveMQConnectionFactory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.jms.*;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JmsConsumer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String ACTIVEMQ_URL=<span style="color:#0ff;font-weight:bold">&#34;tcp://服务器公网ip:后台映射端口号&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String QUEUE_NAME=<span style="color:#0ff;font-weight:bold">&#34;myQueue&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> JMSException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建连接工厂，指定active的url链接，不指定用户名和密码就是默认的。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ActiveMQConnectionFactory activeMQConnectionFactory = <span style="color:#fff;font-weight:bold">new</span> ActiveMQConnectionFactory(ACTIVEMQ_URL);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建工厂后获取链接，并启动
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Connection connection = activeMQConnectionFactory.<span style="color:#007f7f">createConnection</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建会话，有两个参数，分别是事务和签收机制
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Session session = connection.<span style="color:#007f7f">createSession</span>(<span style="color:#fff;font-weight:bold">false</span>, Session.<span style="color:#007f7f">AUTO_ACKNOWLEDGE</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建目的地(这里为队列方式)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Destination destination = session.<span style="color:#007f7f">createQueue</span>(QUEUE_NAME);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建消息的生产者
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        MessageConsumer messageConsumer = session.<span style="color:#007f7f">createConsumer</span>(destination);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">while</span> (<span style="color:#fff;font-weight:bold">true</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//读取消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            TextMessage textMessage = (TextMessage)messageConsumer.<span style="color:#007f7f">receive</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">null</span> !=textMessage){
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//获取消息内容并打印
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;消费者接受的消息:  &#34;</span>+textMessage.<span style="color:#007f7f">getText</span>());
</span></span><span style="display:flex;"><span>            }<span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//关闭资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        messageConsumer.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        session.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>执行结果：</strong></p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/20/w7CjQ1.png" alt="w7CjQ1.png"  />
</p>
<blockquote>
<p>消费者（监听器MessageListener方式获取信息）</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.activemq.ActiveMQConnectionFactory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.jms.*;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JmsConsumer02 {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String ACTIVEMQ_URL=<span style="color:#0ff;font-weight:bold">&#34;tcp://服务器公网ip:后台映射端口号&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String QUEUE_NAME=<span style="color:#0ff;font-weight:bold">&#34;myQueue&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> JMSException, IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建连接工厂，指定active的url链接，不指定用户名和密码就是默认的。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ActiveMQConnectionFactory activeMQConnectionFactory = <span style="color:#fff;font-weight:bold">new</span> ActiveMQConnectionFactory(ACTIVEMQ_URL);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建工厂后获取链接，并启动
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Connection connection = activeMQConnectionFactory.<span style="color:#007f7f">createConnection</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建会话，有两个参数，分别是事务和签收机制
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Session session = connection.<span style="color:#007f7f">createSession</span>(<span style="color:#fff;font-weight:bold">false</span>, Session.<span style="color:#007f7f">AUTO_ACKNOWLEDGE</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建目的地(这里为队列方式)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Destination destination = session.<span style="color:#007f7f">createQueue</span>(QUEUE_NAME);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建消息的生产者
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        MessageConsumer messageConsumer = session.<span style="color:#007f7f">createConsumer</span>(destination);
</span></span><span style="display:flex;"><span>        messageConsumer.<span style="color:#007f7f">setMessageListener</span>((message) -&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">null</span> != message &amp;&amp; message <span style="color:#fff;font-weight:bold">instanceof</span> TextMessage){
</span></span><span style="display:flex;"><span>                    TextMessage textMessage = (TextMessage) message;
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;消费者接受的消息:  &#34;</span>+textMessage.<span style="color:#007f7f">getText</span>());
</span></span><span style="display:flex;"><span>                    } <span style="color:#fff;font-weight:bold">catch</span> (JMSException e) {
</span></span><span style="display:flex;"><span>                        e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">in</span>.<span style="color:#007f7f">read</span>();   <span style="color:#007f7f">//防止消息还没有读取到就关闭资源了
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//关闭资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        messageConsumer.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        session.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>消费者获取消息的方式</p>
</blockquote>
<p><strong>receive() 方法</strong>：该方法是同步阻塞的，如果调用者（队列或者订阅方）没有接受到消息，就会一直等待</p>
<p>除此之外它有一个重载方法 <strong>receive(long timeout)</strong> ，参数表示的是 等待的超时时间（毫秒），在等待时间内没有接受到消息就自动停止</p>
<p><strong>setMessageListener(MessageListener listener) 方法</strong>：该方法是异步非阻塞的，而方法参数类型是MessageListener接口，这个接口里只定义了一个用于处理接收到的消息的onMessage方法，该方法只接收一个Message参数监听器。当消息到达之后，会自动调用onMessage方法获取信息</p>
<blockquote>
<p>消费者的三种情况</p>
</blockquote>
<ul>
<li>
<p>先启动生产者，生产消息，然后再启动一个消费者，是否可以正常消费信息 ？</p>
<ul>
<li>答案：<strong>可以的</strong></li>
</ul>
</li>
<li>
<p>还是先启动生产者，生产消息，再分别启动两个消费者，后一个启动的消费者可以消费到消息吗 ？</p>
<ul>
<li>答案：<strong>否，后一个启动的消费者是消费不到的消息，消息都被前一个启动的消息者消费完了</strong></li>
</ul>
</li>
<li>
<p>先启动两个消费者，再启动生产者生产6条消息，结果如何 ？</p>
<ul>
<li>答案：<strong>消息被平分，两个消费者一人一半，分别消费3条消息</strong></li>
</ul>
</li>
</ul>
<h2 id="发布订阅方式">发布订阅方式<a hidden class="anchor" aria-hidden="true" href="#发布订阅方式">#</a></h2>
<blockquote>
<p>生产者：</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.activemq.ActiveMQConnectionFactory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.jms.*;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JmsProduce_Topic {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String ACTIVEMQ_URL=<span style="color:#0ff;font-weight:bold">&#34;tcp://服务器公网ip:后台映射端口号&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String TOPIC_NAME=<span style="color:#0ff;font-weight:bold">&#34;myTopic&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> JMSException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建连接工厂，指定active的url链接，不指定用户名和密码就是默认的。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ActiveMQConnectionFactory connectionFactory = <span style="color:#fff;font-weight:bold">new</span> ActiveMQConnectionFactory(ACTIVEMQ_URL);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建工厂后获取链接，并启动
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Connection connection = connectionFactory.<span style="color:#007f7f">createConnection</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建会话，有两个参数，分别是事务和签收机制
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Session session = connection.<span style="color:#007f7f">createSession</span>(<span style="color:#fff;font-weight:bold">false</span>, Session.<span style="color:#007f7f">AUTO_ACKNOWLEDGE</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建目的地（这里为发布订阅方式）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Destination destination = session.<span style="color:#007f7f">createTopic</span>(TOPIC_NAME);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建消息的生产者
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        MessageProducer messageProducer = session.<span style="color:#007f7f">createProducer</span>(destination);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//生产4条消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 1; i &lt; 5; i++) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//创建消息内容
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            TextMessage message = session.<span style="color:#007f7f">createTextMessage</span>(<span style="color:#0ff;font-weight:bold">&#34;第&#34;</span> + i + <span style="color:#0ff;font-weight:bold">&#34;条消息&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//发送消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            messageProducer.<span style="color:#007f7f">send</span>(message);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//关闭资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        messageProducer.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        session.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;消息发送完成！&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>​		发布订阅的方式和队列方式， 从生产者的代码可以发现，两者是一样的，<strong>唯一不同的就是，创建目的地的方法不一样，队列是createQueue(String queueName)，而发布订阅是createTopic(String topicName)。同样的，消费者的代码和队列也是一样的</strong></p>
<blockquote>
<p>消费者</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.activemq.ActiveMQConnectionFactory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.jms.*;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JmsConsumer_Topic {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span>  <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String ACTIVEMQ_URL=<span style="color:#0ff;font-weight:bold">&#34;tcp://服务器公网ip:后台映射端口号&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String TOPIC_NAME=<span style="color:#0ff;font-weight:bold">&#34;myTopic&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> JMSException, IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建连接工厂，指定active的url链接，不指定用户名和密码就是默认的。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ActiveMQConnectionFactory activeMQConnectionFactory = <span style="color:#fff;font-weight:bold">new</span> ActiveMQConnectionFactory();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建工厂后获取链接，并启动
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Connection connection = activeMQConnectionFactory.<span style="color:#007f7f">createConnection</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建会话，有两个参数，分别是事务和签收机制
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Session session = connection.<span style="color:#007f7f">createSession</span>(<span style="color:#fff;font-weight:bold">false</span>, Session.<span style="color:#007f7f">AUTO_ACKNOWLEDGE</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建目的地（这里为发布订阅方式）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Destination destination = session.<span style="color:#007f7f">createTopic</span>(TOPIC_NAME);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建消息的生产者
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        MessageConsumer messageConsumer = session.<span style="color:#007f7f">createConsumer</span>(destination);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//通过监听器，接受消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        messageConsumer.<span style="color:#007f7f">setMessageListener</span>((message) -&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">null</span> != message &amp;&amp; message <span style="color:#fff;font-weight:bold">instanceof</span> TextMessage) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                    TextMessage textMessage = (TextMessage) message;
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;消费者接受的消息:  &#34;</span> + textMessage.<span style="color:#007f7f">getText</span>());
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">catch</span> (JMSException e) {
</span></span><span style="display:flex;"><span>                    e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">in</span>.<span style="color:#007f7f">read</span>();<span style="color:#007f7f">//阻塞等待
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//关闭资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        messageConsumer.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        session.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>​		不过要注意的是，<strong>发布订阅的模式，要先启用订阅方，也就是消费者方，再启动发布方（生产者）</strong>。否则，就类似微信公众号一样，没有人订阅，生产方发布消息是没有人接受的到，会被丢弃。这种则是废消息。</p>
<h2 id="队列和发布订阅两者对比">队列和发布订阅两者对比<a hidden class="anchor" aria-hidden="true" href="#队列和发布订阅两者对比">#</a></h2>
<table>
<thead>
<tr>
<th>比 较 项 目</th>
<th>Topic （发布订阅）模式</th>
<th>Queue （队列）模式</th>
</tr>
</thead>
<tbody>
<tr>
<td>工 作 模 式</td>
<td>“订阅-发布”模式，如果当前没有订阅 者，消息将会被丢弃，如果有多个订阅 者，那么这些订阅者都会收到消息。</td>
<td>负载均衡 模式，如果当前没有消费者，消息也不会丢弃，如果有多个消费者，那么一条消息 也只会发送给其中一个消费者，并且要求消费者ack信息</td>
</tr>
<tr>
<td>有 无 状 态</td>
<td>无状态</td>
<td>Queue 数据默认会在 mq 服务器上以文件形式 保存，比如 Active MQ 一般保存在 $AMQ_HOME\data\kr-store\data下面，也可 以配置成DB存储</td>
</tr>
<tr>
<td>传 递 完 整 性</td>
<td>如果没有订阅者，消息会被丢弃</td>
<td>消息不会丢弃</td>
</tr>
<tr>
<td>处 理 效 率</td>
<td>由于消息要按照订阅者的数量进行复 制，所以处理性能会随着订阅者的增加 而明显降低，并且还要结合不同消息协 议自身的性能差异</td>
<td>由于一条消息只发送给一个消费者，所以就算 消费者再多，性能也不会有明显降低。当然不 同消息协议的具体性能也是有差异的。</td>
</tr>
</tbody>
</table>
<h1 id="jms">JMS<a hidden class="anchor" aria-hidden="true" href="#jms">#</a></h1>
<p>​		JMS是Java EE的一个面向消息中间件的一套规范，具体需要靠厂商的产品实现</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/22/wLZGvT.png" alt="wLZGvT.png"  />
</p>
<h2 id="消息的三种部分">消息的三种部分<a hidden class="anchor" aria-hidden="true" href="#消息的三种部分">#</a></h2>
<h3 id="消息头">消息头<a hidden class="anchor" aria-hidden="true" href="#消息头">#</a></h3>
<ul>
<li>在生产者方，消息的API看出可以针对每一条消息设置不同的消息头属性</li>
</ul>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/21/wHNZE6.png" alt="wHNZE6.png"  />
</p>
<ul>
<li>如果不想为每一条消息单独设置消息头属性，可以通过Send()方法的重载，批处理消息的消息头属性</li>
</ul>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/21/wHNEHx.png" alt="wHNEHx.png"  />
</p>
<ul>
<li>从批处理消息头属性和单独设置消息头属性两者结合来看，主要介绍五个消息头属性：</li>
</ul>
<p><strong>JMSDestination：</strong>  消息发送的目的地，主要是指 Queue 和 Topic</p>
<p><strong>JMSDeliveryMode：</strong>  持久模式和非持久模式，可设置的参数为<strong>DeliveryMode.NON_PERSISTENT(非持久)</strong>  和  <strong>DeliveryMode.PERSISTENT(持久)</strong></p>
<p>一条持久性的消息：应该被传送 “一次仅仅一次”，这就意味着如果JMS 提供者出现故障，该消息并不会丢失，它会在服务器恢复之后再次传递消息。
一条非持久的消息：多会传送一次，这意味着服务器出现故障，该消息将永久丢失。</p>
<p><strong>JMSPriority ：</strong>  消息优先级，从0 ~ 9 十个级别，0 ~ 4 是普通消息，5 ~ 9是加急消息。</p>
<p>JMS 不要求 MQ 严格按照这十个优先级发送消息，但必须保证加急消息要先于普通消息到达，默认是4 级。</p>
<p><strong>JMSExpiration：</strong>  可以设置消息在一定时间后过期，默认是永不过期。消息过期时间，等于Destination的send方法中的timeToLive值加上发送时刻的GMT时间</p>
<p>值。 如果timeToLive值等于零，则 JMSExpiration 被设为零，表示该消息永不过期。如果发送后，在消息过期时间之后消息还没有被发送到目的地，则该消息被清除。</p>
<p><strong>JMSMessageID ：</strong>  唯一识别每个消息的标识，由MQ产生。</p>
<h3 id="消息体">消息体<a hidden class="anchor" aria-hidden="true" href="#消息体">#</a></h3>
<p>封装具体的消息数据，发送和接收的消息体类型必须一致对应！</p>
<p>五种消息体格式：</p>
<p><strong>TextMessage：</strong> 普通字符串消息，包含一个String 。</p>
<p><strong>MapMessage：</strong> 一个Map类型的消息，key为String类型，而值为Java的基本类型。</p>
<p>BytesMessage  ： 二进制数组消息，包含一个byte[] 。</p>
<p>StreamMessage ： Java数据流消息，用标准流操作来顺序的填充和读取。</p>
<p>ObjectMessage ：对象消息，包含一个可序列化的 Java 对象。</p>
<h3 id="消息属性">消息属性<a hidden class="anchor" aria-hidden="true" href="#消息属性">#</a></h3>
<p>如果需要除消息头字段以外的值，那么可以使用消息属性！</p>
<p>识别、去重、重点标注等操作非常有用的方法！</p>
<p>消息属性是以属性名和属性值对的形式指定的。可以将属性是为消息头的扩展，属性指定一些消息头没有包括的附加信息，比如可以在属性里指定消息选择器。</p>
<p>以Property结尾：</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/21/wHsArF.png" alt="wHsArF.png"  />
</p>
<h2 id="消息的可靠性">消息的可靠性<a hidden class="anchor" aria-hidden="true" href="#消息的可靠性">#</a></h2>
<h3 id="持久性-队列">持久性 队列<a hidden class="anchor" aria-hidden="true" href="#持久性-队列">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#007f7f">//创建目的地（这里为队列方式）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span> Destination destination = session.<span style="color:#007f7f">createQueue</span>(QUEUE_NAME);
</span></span><span style="display:flex;"><span> <span style="color:#007f7f">//创建消息的生产者
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span> MessageProducer messageProducer = session.<span style="color:#007f7f">createProducer</span>(destination);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 非持久化 ：服务器宕机，则消息不能恢复
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span> messageProducer.<span style="color:#007f7f">setDeliveryMode</span>(DeliveryMode.<span style="color:#007f7f">NON_PERSISTENT</span>);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 持久化 ：服务器宕机，消息可以恢复
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span> messageProducer.<span style="color:#007f7f">setDeliveryMode</span>(DeliveryMode.<span style="color:#007f7f">PERSISTENT</span>);
</span></span></code></pre></div><p>队列是否设置为持久，可以通过setDeliveryMode(int deliveryMode)方法设置，<strong>默认为持久</strong></p>
<h3 id="持久性--发布订阅">持久性  发布订阅<a hidden class="anchor" aria-hidden="true" href="#持久性--发布订阅">#</a></h3>
<blockquote>
<p>发布方（生产者），顺序与之前有一点不同，需要设定先持久化，在启动连接</p>
</blockquote>
<p>测试代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.activemq.ActiveMQConnectionFactory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.jms.*;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JmsProduce_Topic_DeliveryMode {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String ACTIVEMQ_URL=<span style="color:#0ff;font-weight:bold">&#34;tcp://服务器公网ip:后台映射端口号&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String TOPIC_NAME=<span style="color:#0ff;font-weight:bold">&#34;my_topic_persist&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> JMSException {
</span></span><span style="display:flex;"><span>        ActiveMQConnectionFactory connectionFactory = <span style="color:#fff;font-weight:bold">new</span> ActiveMQConnectionFactory(ACTIVEMQ_URL);
</span></span><span style="display:flex;"><span>        Connection connection = connectionFactory.<span style="color:#007f7f">createConnection</span>();
</span></span><span style="display:flex;"><span>        Session session = connection.<span style="color:#007f7f">createSession</span>(<span style="color:#fff;font-weight:bold">false</span>, Session.<span style="color:#007f7f">AUTO_ACKNOWLEDGE</span>);
</span></span><span style="display:flex;"><span>        Topic topic = session.<span style="color:#007f7f">createTopic</span>(TOPIC_NAME);
</span></span><span style="display:flex;"><span>        MessageProducer messageProducer = session.<span style="color:#007f7f">createProducer</span>(topic);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//设置发布方为 持久
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        messageProducer.<span style="color:#007f7f">setDeliveryMode</span>(DeliveryMode.<span style="color:#007f7f">PERSISTENT</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//设定为持久后，然后连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        connection.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 1; i &lt;=3; i++) {
</span></span><span style="display:flex;"><span>            TextMessage message = session.<span style="color:#007f7f">createTextMessage</span>(<span style="color:#0ff;font-weight:bold">&#34;第&#34;</span> + i + <span style="color:#0ff;font-weight:bold">&#34;条消息&#34;</span>);
</span></span><span style="display:flex;"><span>            messageProducer.<span style="color:#007f7f">send</span>(message);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//关闭资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        messageProducer.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        session.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;消息发送完成！&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>订阅方（消费者）测试代码：</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.activemq.ActiveMQConnectionFactory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.jms.*;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JmsConsumer_Topic_DeliveryMode {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String ACTIVEMQ_URL=<span style="color:#0ff;font-weight:bold">&#34;tcp://服务器公网ip:后台映射端口号&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String TOPIC_NAME=<span style="color:#0ff;font-weight:bold">&#34;my_topic_persist&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> JMSException {
</span></span><span style="display:flex;"><span>        ActiveMQConnectionFactory connectionFactory = <span style="color:#fff;font-weight:bold">new</span> ActiveMQConnectionFactory(ACTIVEMQ_URL);
</span></span><span style="display:flex;"><span>        Connection connection = connectionFactory.<span style="color:#007f7f">createConnection</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//订阅方的id
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        connection.<span style="color:#007f7f">setClientID</span>(<span style="color:#0ff;font-weight:bold">&#34;001&#34;</span>);
</span></span><span style="display:flex;"><span>        Session session = connection.<span style="color:#007f7f">createSession</span>(<span style="color:#fff;font-weight:bold">false</span>, Session.<span style="color:#007f7f">AUTO_ACKNOWLEDGE</span>);
</span></span><span style="display:flex;"><span>        Topic topic = session.<span style="color:#007f7f">createTopic</span>(TOPIC_NAME);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建持久的订阅方
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        TopicSubscriber topicSubscriber = session.<span style="color:#007f7f">createDurableSubscriber</span>(topic, <span style="color:#0ff;font-weight:bold">&#34;十十乙&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//持久化后，再进行连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        connection.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>        Message message = topicSubscriber.<span style="color:#007f7f">receive</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">while</span> (<span style="color:#fff;font-weight:bold">null</span> != message){
</span></span><span style="display:flex;"><span>            TextMessage textMessage = (TextMessage)message;
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;订阅方收到的消息：&#34;</span>+textMessage.<span style="color:#007f7f">getText</span>());
</span></span><span style="display:flex;"><span>            message = topicSubscriber.<span style="color:#007f7f">receive</span>(3000L);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        topicSubscriber.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        session.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>先启动订阅方，再启动发布方</strong>，到ActiveMQ前台的<strong>Subscribers</strong>查看</p>
<blockquote>
<p>启动前情况：</p>
</blockquote>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/21/wHIUiT.png" alt="wHIUiT.png"  />
</p>
<blockquote>
<p>启动订阅方后情况：</p>
</blockquote>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/21/wHITeI.png" alt="wHITeI.png"  />
</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/21/wHo9wq.png" alt="wHo9wq.png"  />
</p>
<blockquote>
<p>启动生产方 后：</p>
</blockquote>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/21/wHo0tf.png" alt="wHo0tf.png"  />
</p>
<blockquote>
<p>订阅方停止后，会被列 离线的一栏去：</p>
</blockquote>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/21/wHo4hT.png" alt="wHo4hT.png"  />
</p>
<blockquote>
<p>如果这时，发布者再次发布消息，订阅方重启启动是否能接收到消息</p>
</blockquote>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/21/wHTuvQ.png" alt="wHTuvQ.png"  />
</p>
<blockquote>
<p>再次启动订阅方(不停止)后</p>
</blockquote>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/21/wHT7Pf.png" alt="wHT7Pf.png"  />

<img loading="lazy" src="https://s1.ax1x.com/2020/09/21/wHTHG8.png" alt="wHTHG8.png"  />
</p>
<blockquote>
<p>小结：</p>
</blockquote>
<p>​		<strong>第一次，一定要先启动订阅方，之后启动发布方，发布消息。这时不论订阅方在不在线，都可以接受到消息，不在线，重新启动后会接受没有收到过的消息接受下来</strong></p>
<h3 id="事务">事务<a hidden class="anchor" aria-hidden="true" href="#事务">#</a></h3>
<p><strong>事务偏向于生产者、签收偏向于消费者</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//创建会话，有两个参数，分别是事务和签收机制
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>Session session = connection.<span style="color:#007f7f">createSession</span>(<span style="color:#fff;font-weight:bold">false</span>, Session.<span style="color:#007f7f">AUTO_ACKNOWLEDGE</span>);
</span></span></code></pre></div><p>事务只有两个值，true和false</p>
<blockquote>
<p>生产者一方</p>
</blockquote>
<p>当值为false时，消息会被自动发送到目的地</p>
<p>当值为true时，需要在调用send()方法后，调用commit()方法，手动提交</p>
<blockquote>
<p>消费者一方</p>
</blockquote>
<p>当值为false时，消息只会被消费一次</p>
<p>当值为true时，消息会被重复消费，且在目的地中，消息不会出队的，即未被消费</p>
<p>测试：</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#007f7f">//创建会话，开启事务
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Session session = connection.<span style="color:#007f7f">createSession</span>(<span style="color:#fff;font-weight:bold">true</span>, Session.<span style="color:#007f7f">AUTO_ACKNOWLEDGE</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//OK,就提交
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            session.<span style="color:#007f7f">commit</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (JMSException e) {
</span></span><span style="display:flex;"><span>           <span style="color:#007f7f">//error,就回滚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            session.<span style="color:#007f7f">rollback</span>();
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//关闭资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><h3 id="签收机制">签收机制<a hidden class="anchor" aria-hidden="true" href="#签收机制">#</a></h3>
<p><strong>签收针对的是消费者一方，分为以下四种</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> Session <span style="color:#fff;font-weight:bold">extends</span> Runnable {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> AUTO_ACKNOWLEDGE = 1;   <span style="color:#007f7f">//自动签收（默认）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> CLIENT_ACKNOWLEDGE = 2;	<span style="color:#007f7f">//手动签收，需要调用 message.acknowledge(); 进行签收，否则也会导致重复消费
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span> 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> DUPS_OK_ACKNOWLEDGE = 3;	<span style="color:#007f7f">//自动批量确认
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> SESSION_TRANSACTED = 0;	<span style="color:#007f7f">//这个是配合事务，当事务开启则选择这个，主要是一个语法的一个规范而已
</span></span></span></code></pre></div><p><strong>当事务没有开启时 ：</strong>  即非事务，消息的确认情况 则以签收机制为主</p>
<p><strong>当事务开始时 ：</strong>  即事务情况下，消息的确认以事务为主，即是否commit的为主，不用管签收机制的情况。</p>
<p><strong>注：常用的签收模式 主要以自动签收（AUTO_ACKNOWLEDGE）和手动签收（CLIENT_ACKNOWLEDGE）为主</strong></p>
<h1 id="springboot结合activemq">SpringBoot结合ACtiveMQ<a hidden class="anchor" aria-hidden="true" href="#springboot结合activemq">#</a></h1>
<h2 id="队列模式">队列模式<a hidden class="anchor" aria-hidden="true" href="#队列模式">#</a></h2>
<p>1、导入maven依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">&lt;!--activemq的依赖--&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-activemq<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>2、编写application.properties配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>server.port=8888
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 配置activemq的链接，用户名和密码
</span></span><span style="display:flex;"><span>spring.activemq.broker-url=tcp://服务器公网ip:端口号
</span></span><span style="display:flex;"><span>spring.activemq.user=admin
</span></span><span style="display:flex;"><span>spring.activemq.password=admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#配置是否为发布订阅模式
</span></span><span style="display:flex;"><span>#false为队列（默认）
</span></span><span style="display:flex;"><span>#ture为发布订阅
</span></span><span style="display:flex;"><span>spring.jms.pub-sub-domain=false
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#队列名称（自定义标签）
</span></span><span style="display:flex;"><span>myqueue=activemq_springboot_queue
</span></span></code></pre></div><p>3、编写配置类</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.shishiyi.config;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.activemq.command.ActiveMQQueue;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Value;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Bean;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Configuration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.jms.Queue;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ActiveMQConfig {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//注入队列名称
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${myqueue}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String myQueue_name;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//向spring容器导入队列对象
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue queue(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> ActiveMQQueue(myQueue_name);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>4、编写队列的消息生产者Produce</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.shishiyi.queue;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.jms.core.JmsMessagingTemplate;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.jms.Queue;
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> QueueProduce {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> JmsMessagingTemplate jmsMessagingTemplate;
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Queue queue_name;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> produceSend(){
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//发送消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        jmsMessagingTemplate.<span style="color:#007f7f">convertAndSend</span>(queue_name,<span style="color:#0ff;font-weight:bold">&#34;生产者生产消息&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>5、编写controller类，并访问接口</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.shishiyi.controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.shishiyi.queue.QueueProduce;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.GetMapping;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.RestController;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@RestController
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> QueueProduceController {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> QueueProduce queueProduce;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @GetMapping(<span style="color:#0ff;font-weight:bold">&#34;/queuesend&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> queueSend(){
</span></span><span style="display:flex;"><span>        queueProduce.<span style="color:#007f7f">produceSend</span>();
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;消息发送成功&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>查看ActiveMQ的前台，消息已经发送到队列了</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/21/wqCXuR.png" alt="wqCXuR.png"  />
</p>
<p>6、编写队列的消费者</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.shishiyi.queue;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.jms.annotation.JmsListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.jms.core.JmsMessagingTemplate;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.jms.JMSException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.jms.Message;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.jms.TextMessage;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> QueueConsumer {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> JmsMessagingTemplate jmsMessagingTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//采用监听器的方式获取消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @JmsListener(destination = <span style="color:#0ff;font-weight:bold">&#34;${myqueue}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> receive(Message message) <span style="color:#fff;font-weight:bold">throws</span> JMSException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">null</span> !=message &amp;&amp; message <span style="color:#fff;font-weight:bold">instanceof</span> TextMessage){
</span></span><span style="display:flex;"><span>            TextMessage textMessage = (TextMessage)message;
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;消费者已经接受到了&#34;</span>+textMessage.<span style="color:#007f7f">getText</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>删除之前入队的信息，然后重新启动 启动类，再次访问接口，并查看ActiveMQ的前台和打印台</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/21/wqkFv4.png" alt="wqkFv4.png"  />
<img loading="lazy" src="https://s1.ax1x.com/2020/09/21/wqkfRU.png" alt="wqkfRU.png"  />
</p>
<h2 id="订阅发布模式">订阅发布模式<a hidden class="anchor" aria-hidden="true" href="#订阅发布模式">#</a></h2>
<p>1、导入maven依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-activemq<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>2、编写application.properties配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>server.port=7777
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 配置activemq的链接，用户名和密码
</span></span><span style="display:flex;"><span>spring.activemq.broker-url=tcp://服务器公网ip:端口号
</span></span><span style="display:flex;"><span>spring.activemq.user=admin
</span></span><span style="display:flex;"><span>spring.activemq.password=admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#配置是否为发布订阅模式
</span></span><span style="display:flex;"><span>#false为队列（默认）
</span></span><span style="display:flex;"><span>#ture为发布订阅
</span></span><span style="display:flex;"><span>spring.jms.pub-sub-domain=true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#topic名称
</span></span><span style="display:flex;"><span>mytopic=activemq_springboot_topic
</span></span></code></pre></div><p>3、编写配置类</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.shishiyi.config;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.activemq.command.ActiveMQTopic;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Value;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Bean;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Configuration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.jms.Topic;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ActiveMQConfig {
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${mytopic}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String myTopic;
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Topic topic(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> ActiveMQTopic(myTopic);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>4、编写主题的消息生产者（发布方）</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.shishiyi.topic;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.jms.core.JmsMessagingTemplate;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.jms.Topic;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TopicProduce {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> JmsMessagingTemplate jmsMessagingTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Topic topic;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> topicSend(){
</span></span><span style="display:flex;"><span>        jmsMessagingTemplate.<span style="color:#007f7f">convertAndSend</span>(topic,<span style="color:#0ff;font-weight:bold">&#34;发布方向主题发布的消息&#34;</span>);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;消息发送成功&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>5、编写controller类</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.shishiyi.controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.shishiyi.topic.TopicProduce;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.GetMapping;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.RestController;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@RestController
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TopicProduceController {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> TopicProduce topicProduce;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @GetMapping(<span style="color:#0ff;font-weight:bold">&#34;/topicSend&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> topicSend(){
</span></span><span style="display:flex;"><span>        topicProduce.<span style="color:#007f7f">topicSend</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>6、编写主题的消费者（订阅方）</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.shishiyi.topic;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.jms.annotation.JmsListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.jms.core.JmsMessagingTemplate;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.jms.*;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TopicConsumer {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> JmsMessagingTemplate jmsMessagingTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @JmsListener(destination = <span style="color:#0ff;font-weight:bold">&#34;${mytopic}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> receive(Message message) <span style="color:#fff;font-weight:bold">throws</span> JMSException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">null</span> != message &amp;&amp; message <span style="color:#fff;font-weight:bold">instanceof</span> TextMessage){
</span></span><span style="display:flex;"><span>            TextMessage textMessage = (TextMessage) message;
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;订阅方收到的消息：&#34;</span>+textMessage.<span style="color:#007f7f">getText</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>7、启动主启动类，访问接口，让发布方生产消息，并查看ActiveMQ的前台和打印台</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/21/wqeLvT.png" alt="wqeLvT.png"  />
<img loading="lazy" src="https://s1.ax1x.com/2020/09/21/wqevb4.png" alt="wqevb4.png"  />
</p>
<blockquote>
<p>定时的订阅发布模式</p>
</blockquote>
<p>让发布方每过5秒，发送一次消息</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//创建定时任务
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.shishiyi.topic;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.jms.core.JmsMessagingTemplate;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.scheduling.annotation.Scheduled;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.jms.Topic;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TopicProduce {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> JmsMessagingTemplate jmsMessagingTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Topic topic;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> topicSend(){
</span></span><span style="display:flex;"><span>        jmsMessagingTemplate.<span style="color:#007f7f">convertAndSend</span>(topic,<span style="color:#0ff;font-weight:bold">&#34;发布方向主题发布的消息&#34;</span>);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;消息发送成功&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//创建定时任务，每隔5秒发布消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Scheduled(fixedRate = 5000L)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> scheduled(){
</span></span><span style="display:flex;"><span>        topicSend();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>添加 @EnableScheduling 注解，发现定时任务让它后台执行</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/22/wLkdpT.png" alt="wLkdpT.png"  />
</p>
<p>修改主题的消费者（订阅方），添加LocalDateTime.now()方法，方便在控制台查看</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.shishiyi.topic;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.jms.annotation.JmsListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.jms.core.JmsMessagingTemplate;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.jms.*;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.time.LocalDateTime;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TopicConsumer {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> JmsMessagingTemplate jmsMessagingTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @JmsListener(destination = <span style="color:#0ff;font-weight:bold">&#34;${mytopic}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> receive(Message message) <span style="color:#fff;font-weight:bold">throws</span> JMSException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">null</span> != message &amp;&amp; message <span style="color:#fff;font-weight:bold">instanceof</span> TextMessage){
</span></span><span style="display:flex;"><span>            TextMessage textMessage = (TextMessage) message;
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;订阅方收到的消息：&#34;</span>+textMessage.<span style="color:#007f7f">getText</span>()+ <span style="color:#0ff;font-weight:bold">&#34;时间为：&#34;</span> +LocalDateTime.<span style="color:#007f7f">now</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>启动程序，查看控制台打印内容，以及（同一时间点内）查看ActiveMQ的前台</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/22/wLVl6O.png" alt="wLVl6O.png"  />

<img loading="lazy" src="https://s1.ax1x.com/2020/09/22/wLVQ1K.png" alt="wLVQ1K.png"  />
</p>
<h1 id="activemq传输协议">ActiveMQ传输协议<a hidden class="anchor" aria-hidden="true" href="#activemq传输协议">#</a></h1>
<p>在连接activemq时，默认是用TCP连接，那Activemq是否还支持其它协议吗？</p>
<p>查看activemq的conf文件夹下的<strong>activemq.xml</strong></p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/23/wjwPQx.png" alt="wjwPQx.png"  />
</p>
<p>可以看出，除了支持默认的TCP协议，还支持 amqp ，stomp，mqtt，ws等协议，而且协议对应的端口号也不一样，这就是用TCP连接时，端口号是61616的原因了。</p>
<p>从activemq前台也可以查看出来</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/23/wj03g1.png" alt="wj03g1.png"  />
</p>
<p>如果想配置其它协议，可以查看官网的文档</p>
<p><a href="http://activemq.apache.org/configuring-version-5-transports">http://activemq.apache.org/configuring-version-5-transports</a></p>
<blockquote>
<h3 id="配置nio协议">配置NIO协议<a hidden class="anchor" aria-hidden="true" href="#配置nio协议">#</a></h3>
</blockquote>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/23/wjySYD.png" alt="wjySYD.png"  />
</p>
<p>从官网的文档得知，配置NIO协议，只需要修改<strong>activemq.xml</strong>文件</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">&lt;!--添加一段即可--&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&lt;transportConnectors&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;transportConnector</span> <span style="color:#007f7f">name=</span><span style="color:#0ff;font-weight:bold">&#34;nio&#34;</span> <span style="color:#007f7f">uri=</span><span style="color:#0ff;font-weight:bold">&#34;nio://0.0.0.0:61617&#34;</span><span style="font-weight:bold">/&gt;</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f00">&lt;</span>/<span style="font-weight:bold">&lt;transportConnectors&gt;</span>
</span></span></code></pre></div><p><img loading="lazy" src="https://s1.ax1x.com/2020/09/23/wj59Ej.png" alt="wj59Ej.png"  />
</p>
<p>重启activemq（重启容器），查看activemq前台</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/23/wj5Raj.png" alt="wj5Raj.png"  />
</p>
<p>修改代码的连接方式，并测试</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#007f7f">//由于安装的activemq是docker容器，添加的nio协议端口是61617，所以端口要提前映射好，否则会连不上
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String ACTIVEMQ_URL=<span style="color:#0ff;font-weight:bold">&#34;nio://47.115.151.184:61617&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String QUEUE_NAME=<span style="color:#0ff;font-weight:bold">&#34;myQueue_NIO&#34;</span>;
</span></span></code></pre></div><p>查看前台</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/23/wjbZKx.png" alt="wjbZKx.png"  />
</p>
<h1 id="activemq持久化">ActiveMQ持久化<a hidden class="anchor" aria-hidden="true" href="#activemq持久化">#</a></h1>
<p>持久化不同于之前的持久性，持久化是以防服务器本身挂了，重启服务器也可以恢复消息</p>
<p>ActiveMQ目前默认的持久化方式是KahaDB，此外还有JDBC， LevelDB等，不过它们大体上的逻辑是一样，消息中心接受到消息。会把消息备份存储起来。</p>
<h2 id="kahadb默认">KahaDB(默认)<a hidden class="anchor" aria-hidden="true" href="#kahadb默认">#</a></h2>
<p><strong>KahaDB：这个5.4版本之后出现的默认的持久化方式，</strong> KahaDB的持久化机制是基于日志文件，索引和缓存。</p>
<p>从<strong>activemq.xml</strong>配置文件中可以得知</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/23/wjxVYT.png" alt="wjxVYT.png"  />
</p>
<p>它是把数据存储在activemq的data目录下的kahadb文件夹中</p>
<p>在这个文件夹中会有四个文件来完成消息持久化</p>
<ul>
<li><strong>db.data</strong> 它是消息的索引文件，本质上是B-Tree（B树），使用B-Tree作为索引指向<strong>db-*.log</strong>里面存储的消息</li>
<li><strong>db.redo</strong> 用来进行消息恢复</li>
<li><strong>db-*.log</strong> 存储消息内容。新的数据以APPEND的方式追加到日志文件末尾。属于顺序写入，因此消息存储是比较快的。默认是32M，达到阀值会自动递增文 件，文件名按照数字进行编号，如 db-1.log、db-2.log、&hellip;..</li>
<li><strong>lock</strong> 文件 锁，写入当前获得kahadb读写权限的broker ，用于在集群环境下的竞争处理</li>
</ul>
<p><strong>KahaDB配置官网链接：</strong>  <a href="http://activemq.apache.org/kahadb">http://activemq.apache.org/kahadb</a></p>
<h2 id="leveldb">LevelDB<a hidden class="anchor" aria-hidden="true" href="#leveldb">#</a></h2>
<p>这种文件系统是从ActiveMQ 5.8 之后引进的，它和 KahaDB 非常相似，也是基于文件的本地数据库存 储形式，但是它提供比 KahaDB更快的持久性。</p>
<p>但它不使用自定义 B-Tree 实现来索引预写日志，而是使用基于LevelDB的索引。</p>
<p>可是为什么LeavelDB 更快，并且5.8 以后就支持，为什么还是默认 KahaDB 引擎，因为 activemq 官网本身没有定论，LeavelDB 之后又出了可复制的</p>
<p>LeavelDB 比LeavelDB 更性能更优越，但需要基于 ZooKeeper 所以这些官方还没有定论，仍旧使用 KahaDB。</p>
<p>默认配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&lt;broker</span> <span style="color:#007f7f">brokerName=</span><span style="color:#0ff;font-weight:bold">&#34;broker&#34;</span> <span style="color:#f00">...</span> <span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;persistenceAdapter&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">&lt;levelDB</span> <span style="color:#007f7f">directory=</span><span style="color:#0ff;font-weight:bold">&#34;activemq-data&#34;</span><span style="font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/persistenceAdapter&gt;</span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&lt;/broker&gt;</span>
</span></span></code></pre></div><p><strong>LevelDB配置官网链接：</strong>  <a href="http://activemq.apache.org/leveldb-store">http://activemq.apache.org/leveldb-store</a></p>
<h2 id="jdbc">JDBC<a hidden class="anchor" aria-hidden="true" href="#jdbc">#</a></h2>
<p>看名字就知道和数据库有关，所以JDB的持久化就是把消息备份到数据库中</p>
<p>由于用docker比较麻烦，所以直接改为windows本地测试</p>
<p>首先下载activemq的windows版本，http://activemq.apache.org/components/classic/download/</p>
<p>然后下载mysql的驱动包，</p>
<p>把mysql驱动包丢到activemq的lib下</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/23/wv9hxU.png" alt="wv9hxU.png"  />
</p>
<p>打开activemq的<strong>conf目录下的activemq.xml文件</strong>，配置内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>		<span style="color:#007f7f">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">            Configure message persistence for the broker. The default persistence
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">            mechanism is the KahaDB store (identified by the kahaDB tag).
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">            For more information, see:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">            http://activemq.apache.org/persistence.html
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">        
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">        &lt;persistenceAdapter&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">            &lt;kahaDB directory=&#34;${activemq.data}/kahadb&#34;/&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">        &lt;/persistenceAdapter&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">		屏蔽之前的持久化
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">        --&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">&lt;!--改用mysql方式--&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;persistenceAdapter&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="font-weight:bold">&lt;jdbcPersistenceAdapter</span> <span style="color:#007f7f">dataSource=</span><span style="color:#0ff;font-weight:bold">&#34;#mysqlDataSource&#34;</span> <span style="color:#007f7f">createTablesOnStartup=</span><span style="color:#0ff;font-weight:bold">&#34;true&#34;</span><span style="font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;/persistenceAdapter&gt;</span>
</span></span></code></pre></div><p>参数解释：</p>
<p><strong>dataSource：</strong>   表示的是引用的数据源名称</p>
<p><strong>createTablesOnStartup：</strong>   表示启动的时候是否去创建表，一般第一次为true,之后改为false</p>
<p>接着由于指定了数据源，所以需要在<strong>activemq.xml</strong>配置一个数据源，不过要注意位置</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;bean</span> <span style="color:#007f7f">id=</span><span style="color:#0ff;font-weight:bold">&#34;mysqlDataSource&#34;</span> <span style="color:#007f7f">class=</span><span style="color:#0ff;font-weight:bold">&#34;org.apache.commons.dbcp.BasicDataSource&#34;</span> <span style="color:#007f7f">destroy-method=</span><span style="color:#0ff;font-weight:bold">&#34;close&#34;</span><span style="font-weight:bold">&gt;</span> 
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;property</span> <span style="color:#007f7f">name=</span><span style="color:#0ff;font-weight:bold">&#34;driverClassName&#34;</span> <span style="color:#007f7f">value=</span><span style="color:#0ff;font-weight:bold">&#34;com.mysql.jdbc.Driver&#34;</span><span style="font-weight:bold">/&gt;</span>      
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;property</span> <span style="color:#007f7f">name=</span><span style="color:#0ff;font-weight:bold">&#34;url&#34;</span> <span style="color:#007f7f">value=</span><span style="color:#0ff;font-weight:bold">&#34;jdbc:mysql://localhost:3306/activemq?relaxAutoCommit=true&#34;</span><span style="font-weight:bold">/&gt;</span>      
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;property</span> <span style="color:#007f7f">name=</span><span style="color:#0ff;font-weight:bold">&#34;username&#34;</span> <span style="color:#007f7f">value=</span><span style="color:#0ff;font-weight:bold">&#34;root&#34;</span><span style="font-weight:bold">/&gt;</span>     
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;property</span> <span style="color:#007f7f">name=</span><span style="color:#0ff;font-weight:bold">&#34;password&#34;</span> <span style="color:#007f7f">value=</span><span style="color:#0ff;font-weight:bold">&#34;123&#34;</span><span style="font-weight:bold">/&gt;</span>   
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/bean&gt;</span>
</span></span></code></pre></div><p><strong>然后创建好数据库，数据库名字与数据源链接的要一致</strong></p>
<p><strong>测试：</strong></p>
<blockquote>
<p>Queue</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//生产者
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JmsProduce {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String ACTIVEMQ_URL=<span style="color:#0ff;font-weight:bold">&#34;tcp://127.0.0.1:61616&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String QUEUE_NAME=<span style="color:#0ff;font-weight:bold">&#34;queue_jdbc_mysql&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> JMSException {
</span></span><span style="display:flex;"><span>        ActiveMQConnectionFactory connectionFactory = <span style="color:#fff;font-weight:bold">new</span> ActiveMQConnectionFactory(ACTIVEMQ_URL);     
</span></span><span style="display:flex;"><span>        Connection connection = connectionFactory.<span style="color:#007f7f">createConnection</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>        Session session = connection.<span style="color:#007f7f">createSession</span>(<span style="color:#fff;font-weight:bold">false</span>, Session.<span style="color:#007f7f">AUTO_ACKNOWLEDGE</span>);
</span></span><span style="display:flex;"><span>        Destination destination = session.<span style="color:#007f7f">createQueue</span>(QUEUE_NAME);
</span></span><span style="display:flex;"><span>        MessageProducer messageProducer = session.<span style="color:#007f7f">createProducer</span>(destination);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//一定要开启持久化
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        messageProducer.<span style="color:#007f7f">setDeliveryMode</span>(DeliveryMode.<span style="color:#007f7f">PERSISTENT</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 1; i &lt; 5; i++) {
</span></span><span style="display:flex;"><span>            TextMessage message = session.<span style="color:#007f7f">createTextMessage</span>(<span style="color:#0ff;font-weight:bold">&#34;第&#34;</span> + i + <span style="color:#0ff;font-weight:bold">&#34;条消息&#34;</span>);
</span></span><span style="display:flex;"><span>            messageProducer.<span style="color:#007f7f">send</span>(message);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//关闭资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        messageProducer.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        session.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;消息发送完成！&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>启动后，分别查看数据库和前台：</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/23/wvZeVU.png" alt="wvZeVU.png"  />

<img loading="lazy" src="https://s1.ax1x.com/2020/09/23/wvZmaF.png" alt="wvZmaF.png"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//消费者
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JmsConsumer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String ACTIVEMQ_URL=<span style="color:#0ff;font-weight:bold">&#34;tcp://127.0.0.1:61616&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String QUEUE_NAME=<span style="color:#0ff;font-weight:bold">&#34;queue_jdbc_mysql&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> JMSException {
</span></span><span style="display:flex;"><span>        ActiveMQConnectionFactory activeMQConnectionFactory = <span style="color:#fff;font-weight:bold">new</span> ActiveMQConnectionFactory(ACTIVEMQ_URL);
</span></span><span style="display:flex;"><span>        Connection connection = activeMQConnectionFactory.<span style="color:#007f7f">createConnection</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>        Session session = connection.<span style="color:#007f7f">createSession</span>(<span style="color:#fff;font-weight:bold">false</span>, Session.<span style="color:#007f7f">AUTO_ACKNOWLEDGE</span>);
</span></span><span style="display:flex;"><span>        Destination destination = session.<span style="color:#007f7f">createQueue</span>(QUEUE_NAME);
</span></span><span style="display:flex;"><span>        MessageConsumer messageConsumer = session.<span style="color:#007f7f">createConsumer</span>(destination);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">while</span> (<span style="color:#fff;font-weight:bold">true</span>){
</span></span><span style="display:flex;"><span>            TextMessage textMessage = (TextMessage)messageConsumer.<span style="color:#007f7f">receive</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">null</span> !=textMessage){
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//获取消息内容并打印
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;消费者接受的消息:  &#34;</span>+textMessage.<span style="color:#007f7f">getText</span>());
</span></span><span style="display:flex;"><span>            }<span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//关闭资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        messageConsumer.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        session.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>启动消费者查看数据库和前台：</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/23/wve3Wj.png" alt="wve3Wj.png"  />

<img loading="lazy" src="https://s1.ax1x.com/2020/09/23/wveGSs.png" alt="wveGSs.png"  />
</p>
<blockquote>
<p>Queue 小结：</p>
</blockquote>
<p>​		在点对点类型中，当<strong>DeliveryMode</strong>设置为<strong>NON_PERSISTENCE</strong> 时，消息被保存在内存中； 当<strong>DeliveryMode</strong>设置为<strong>PERSISTENCE</strong> 时，消息被保存在Broker的相应的文件或者数据库中。而且点对点类型中消息一旦被Consumer消费就从Broker中删除</p>
<blockquote>
<p>Topic</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//发布方
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JmsProduce_Topic {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String ACTIVEMQ_URL=<span style="color:#0ff;font-weight:bold">&#34;tcp://127.0.0.1:61616&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String TOPIC_NAME=<span style="color:#0ff;font-weight:bold">&#34;topic_jdbc_mysql&#34;</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> JMSException {
</span></span><span style="display:flex;"><span>        ActiveMQConnectionFactory connectionFactory = <span style="color:#fff;font-weight:bold">new</span> ActiveMQConnectionFactory(ACTIVEMQ_URL);
</span></span><span style="display:flex;"><span>        Connection connection = connectionFactory.<span style="color:#007f7f">createConnection</span>();
</span></span><span style="display:flex;"><span>        Session session = connection.<span style="color:#007f7f">createSession</span>(<span style="color:#fff;font-weight:bold">false</span>, Session.<span style="color:#007f7f">AUTO_ACKNOWLEDGE</span>);
</span></span><span style="display:flex;"><span>        Topic topic = session.<span style="color:#007f7f">createTopic</span>(TOPIC_NAME);
</span></span><span style="display:flex;"><span>        MessageProducer messageProducer = session.<span style="color:#007f7f">createProducer</span>(topic);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//设置发布方为 持久
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        messageProducer.<span style="color:#007f7f">setDeliveryMode</span>(DeliveryMode.<span style="color:#007f7f">PERSISTENT</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//设定为持久后，然后连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        connection.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 1; i &lt;=3; i++) {
</span></span><span style="display:flex;"><span>            TextMessage message = session.<span style="color:#007f7f">createTextMessage</span>(<span style="color:#0ff;font-weight:bold">&#34;第&#34;</span> + i + <span style="color:#0ff;font-weight:bold">&#34;条消息&#34;</span>);
</span></span><span style="display:flex;"><span>            messageProducer.<span style="color:#007f7f">send</span>(message);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//关闭资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        messageProducer.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        session.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;消息发送完成！&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//订阅方
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JmsConsumer_Topic_DeliveryMode {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String ACTIVEMQ_URL=<span style="color:#0ff;font-weight:bold">&#34;tcp://127.0.0.1:61616&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String TOPIC_NAME=<span style="color:#0ff;font-weight:bold">&#34;topic_jdbc_mysql&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> JMSException {
</span></span><span style="display:flex;"><span>        ActiveMQConnectionFactory connectionFactory = <span style="color:#fff;font-weight:bold">new</span> ActiveMQConnectionFactory(ACTIVEMQ_URL);
</span></span><span style="display:flex;"><span>        Connection connection = connectionFactory.<span style="color:#007f7f">createConnection</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//订阅方的id
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        connection.<span style="color:#007f7f">setClientID</span>(<span style="color:#0ff;font-weight:bold">&#34;001&#34;</span>);
</span></span><span style="display:flex;"><span>        Session session = connection.<span style="color:#007f7f">createSession</span>(<span style="color:#fff;font-weight:bold">false</span>, Session.<span style="color:#007f7f">AUTO_ACKNOWLEDGE</span>);
</span></span><span style="display:flex;"><span>        Topic topic = session.<span style="color:#007f7f">createTopic</span>(TOPIC_NAME);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建持久的订阅方
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        TopicSubscriber topicSubscriber = session.<span style="color:#007f7f">createDurableSubscriber</span>(topic, <span style="color:#0ff;font-weight:bold">&#34;十十乙&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//持久化后，再进行连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        connection.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>        Message message = topicSubscriber.<span style="color:#007f7f">receive</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">while</span> (<span style="color:#fff;font-weight:bold">null</span> != message){
</span></span><span style="display:flex;"><span>            TextMessage textMessage = (TextMessage)message;
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;订阅方收到的消息：&#34;</span>+textMessage.<span style="color:#007f7f">getText</span>());
</span></span><span style="display:flex;"><span>            message = topicSubscriber.<span style="color:#007f7f">receive</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        topicSubscriber.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        session.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>先启动订阅方然后再启动发布方，查看数据库和前台：</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/23/wvKJ4U.png" alt="wvKJ4U.png"  />

<img loading="lazy" src="https://s1.ax1x.com/2020/09/23/wvKGNT.png" alt="wvKGNT.png"  />

<img loading="lazy" src="https://s1.ax1x.com/2020/09/23/wvK1H0.png" alt="wvK1H0.png"  />

<img loading="lazy" src="https://s1.ax1x.com/2020/09/23/wvKKjs.png" alt="wvKKjs.png"  />
</p>
<blockquote>
<p>Topic 小结：</p>
</blockquote>
<p>一定要先启动消费订阅然后再启动生产，消息会被保留在 activemq_msgs表中消费完毕也不会删除，而订阅关系在 acks 表 中。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://shaoyi.cc/tags/activemq/">ActiveMQ</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://shaoyi.cc/posts/blog/mq/rabbitmq/rabbitmq/">
    <span class="title">« 上一页</span>
    <br>
    <span>消息中间件之RabbitMQ</span>
  </a>
  <a class="next" href="http://shaoyi.cc/posts/blog/%E6%9D%82%E8%AE%B0/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%AC%94%E8%AE%B0/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%AC%94%E8%AE%B0/">
    <span class="title">下一页 »</span>
    <br>
    <span>Java多线程笔记</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="http://shaoyi.cc/">十十乙的博客</a></span>
    <span>All Rights Reserved</span>
    <span>
        
        
        <a href="https://beian.miit.gov.cn/" rel="noopener noreferrer" target="_blank">鄂ICP备2022008682号-1</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script></body>

</html>
