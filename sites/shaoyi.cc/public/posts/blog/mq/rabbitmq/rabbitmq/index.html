<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>æ¶ˆæ¯ä¸­é—´ä»¶ä¹‹RabbitMQ | ååä¹™çš„åšå®¢</title>
<meta name="keywords" content="RabbitMQ">
<meta name="description" content="RabbitMQä½¿ç”¨æ–¹å¼">
<meta name="author" content="
ä½œè€…:&nbsp;ååä¹™">
<link rel="canonical" href="http://shaoyi.cc/posts/blog/mq/rabbitmq/rabbitmq/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.bb3fd15879e1b070bc3f661ad98fef35fef1f31a23b6bec0b04e5cb164937952.css" integrity="sha256-uz/RWHnhsHC8P2Ya2Y/vNf7x8xojtr7AsE5csWSTeVI=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="http://shaoyi.cc/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://shaoyi.cc/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://shaoyi.cc/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://shaoyi.cc/apple-touch-icon.png">
<link rel="mask-icon" href="http://shaoyi.cc/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="æ¶ˆæ¯ä¸­é—´ä»¶ä¹‹RabbitMQ" />
<meta property="og:description" content="RabbitMQä½¿ç”¨æ–¹å¼" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://shaoyi.cc/posts/blog/mq/rabbitmq/rabbitmq/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-04T19:18:23&#43;08:00" />
<meta property="article:modified_time" content="2022-08-06T16:24:23&#43;08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="æ¶ˆæ¯ä¸­é—´ä»¶ä¹‹RabbitMQ"/>
<meta name="twitter:description" content="RabbitMQä½¿ç”¨æ–¹å¼"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "http://shaoyi.cc/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“•æŠ€æœ¯",
      "item": "http://shaoyi.cc/posts/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "æ¶ˆæ¯ä¸­é—´ä»¶ä¹‹RabbitMQ",
      "item": "http://shaoyi.cc/posts/blog/mq/rabbitmq/rabbitmq/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "æ¶ˆæ¯ä¸­é—´ä»¶ä¹‹RabbitMQ",
  "name": "æ¶ˆæ¯ä¸­é—´ä»¶ä¹‹RabbitMQ",
  "description": "RabbitMQä½¿ç”¨æ–¹å¼",
  "keywords": [
    "RabbitMQ"
  ],
  "articleBody": "Docker å®‰è£…RabbitMQ è¿™é‡Œæ³¨æ„è·å–é•œåƒçš„æ—¶å€™è¦è·å–managementç‰ˆæœ¬çš„ï¼Œä¸è¦è·å–lastç‰ˆæœ¬çš„ï¼Œmanagementç‰ˆæœ¬çš„æ‰å¸¦æœ‰ç®¡ç†ç•Œé¢ã€‚\næŸ¥è¯¢é•œåƒ\n#æœç´¢RabbitMQé•œåƒ [root@shishiyi /]# docker search rabbitmq:management å¾—åˆ°ä¸‹åˆ—ç»“æœ\nä¸‹è½½é•œåƒ\n#ä¸‹è½½RabbitMQé•œåƒ [root@shishiyi /]# docker pull rabbitmq:management å‡ºç°å¦‚ä¸‹ç»“æœ\nè¿è¡Œé•œåƒ\n#è¿è¡ŒRabbitMQé•œåƒ [root@shishiyi /]# docker run -d -p 5672:5672 -p 15672:15672 --name rabbitmq rabbitmq:management è®¿é—®ç®¡ç†ç•Œé¢\nåœ°å€ä¸º æœåŠ¡å™¨ip:15672 ç”¨æˆ·åå’Œå¯†ç éƒ½æ˜¯guest\nJavaæ–¹å¼å®ç°RabbitMQ 1ã€helloword ç”Ÿäº§è€…\nimport com.rabbitmq.client.Channel; import com.rabbitmq.client.Connection; import com.rabbitmq.client.ConnectionFactory; import java.io.IOException; import java.util.concurrent.TimeoutException; public class Provider { public static void main(String[] args) throws IOException, TimeoutException { //åˆ›å»ºmqçš„è¿æ¥å·¥å‚ ConnectionFactory connectionFactory = new ConnectionFactory(); //è®¾ç½®è¿æ¥çš„æœåŠ¡å™¨IP connectionFactory.setHost(\"æœåŠ¡å™¨ip\"); //è®¾ç½®ç«¯å£å· connectionFactory.setPort(5672); //è®¾ç½®è¿æ¥çš„è™šæ‹Ÿä¸»æœºï¼ˆç±»ä¼¼æ•°æ®åº“ä¸­çš„åº“ï¼‰ connectionFactory.setVirtualHost(\"/ems\"); //è®¾ç½®ç”¨æˆ·å connectionFactory.setUsername(\"ems\"); //è®¾ç½®å¯†ç  connectionFactory.setPassword(\"123\"); //è·å–è¿æ¥ Connection connection = connectionFactory.newConnection(); //è·å–è¿æ¥çš„é€šé“ Channel channel = connection.createChannel(); //é€šé“ç»‘å®šæ¶ˆæ¯é˜Ÿåˆ— //å‚æ•°1ï¼šé˜Ÿåˆ—åç§°ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»º //å‚æ•°2ï¼šæ˜¯å¦æŒä¹…é˜Ÿåˆ— //å‚æ•°3ï¼šæ˜¯å¦ç‹¬å é˜Ÿåˆ— //å‚æ•°4ï¼š æ˜¯å¦æ¶ˆè´¹å®Œæ¯•åˆ é™¤é˜Ÿåˆ— //å‚æ•°5ï¼šé¢å¤–é™„åŠ å‚æ•° channel.queueDeclare(\"hello\",false,false,false,null); //å‘å¸ƒæ¶ˆæ¯ //å‚æ•°1ï¼šäº¤æ¢æœºï¼›å‚æ•°2ï¼šé˜Ÿåˆ—åç§°ï¼›å‚æ•°3ï¼šä¼ é€’æ¶ˆæ¯çš„é¢å¤–è®¾ç½®ï¼›å‚æ•°4ï¼šæ¶ˆæ¯å†…å®¹ channel.basicPublish(\"\",\"hello\",null,\"hello rabbitmq\".getBytes()); //å…³é—­èµ„æº channel.close(); connection.close(); } } æ¶ˆè´¹è€…\nimport com.rabbitmq.client.*; import java.io.IOException; import java.util.concurrent.TimeoutException; public class Consumer { public static void main(String[] args) throws IOException, TimeoutException { ConnectionFactory connectionFactory = new ConnectionFactory(); connectionFactory.setHost(\"æœåŠ¡å™¨ip\"); connectionFactory.setPort(5672); connectionFactory.setVirtualHost(\"/ems\"); connectionFactory.setUsername(\"ems\"); connectionFactory.setPassword(\"123\"); Connection connection = connectionFactory.newConnection(); Channel channel = connection.createChannel(); channel.queueDeclare(\"hello\",false,false,false,null); //å‚æ•°1ï¼šé˜Ÿåˆ—åç§°ï¼Œå‚æ•°2ï¼šå¼€å§‹æ¶ˆæ¯çš„è‡ªåŠ¨ç¡®è®¤æœºåˆ¶ï¼Œå‚æ•°3ï¼šæ¶ˆè´¹æ—¶çš„å›è°ƒæ¥å£ channel.basicConsume(\"hello\",true,new DefaultConsumer(channel){ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { System.out.println(\"æ¶ˆè´¹çš„å†…å®¹ï¼š\"+new String(body)); } }); } } æå–å…¬å…±éƒ¨åˆ†ï¼Œåˆ›å»ºå·¥å…·ç±» RabbitMQUtils\nimport com.rabbitmq.client.Channel; import com.rabbitmq.client.Connection; import com.rabbitmq.client.ConnectionFactory; import java.io.IOException; import java.util.concurrent.TimeoutException; public class RabbitMQUtils { private static ConnectionFactory connectionFactory = null; static { connectionFactory = new ConnectionFactory(); connectionFactory.setHost(\"æœåŠ¡å™¨ip\"); connectionFactory.setPort(5672); connectionFactory.setVirtualHost(\"/ems\"); connectionFactory.setUsername(\"ems\"); connectionFactory.setPassword(\"123\"); } //è·å–è¿æ¥ public static Connection getConnection(){ try { Connection connection = connectionFactory.newConnection(); return connection; } catch (IOException e) { e.printStackTrace(); } catch (TimeoutException e) { e.printStackTrace(); } return null; } //å…³é—­èµ„æº public static void clone(Channel channel , Connection connection){ try { if (null !=channel) channel.close(); if (null != connection) connection.close(); } catch (IOException e) { e.printStackTrace(); } catch (TimeoutException e) { e.printStackTrace(); } } } 2ã€Work queues ç”Ÿäº§è€…\npackage com.shishiyi.work; import com.rabbitmq.client.Channel; import com.rabbitmq.client.Connection; import com.shishiyi.utils.RabbitMQUtils; import java.io.IOException; public class Provider { public static void main(String[] args) throws IOException { Connection connection = RabbitMQUtils.getConnection(); Channel channel = connection.createChannel(); channel.queueDeclare(\"work\",false,false,false,null); for (int i = 0; i \u003c 10 ; i++) { channel.basicPublish(\"\",\"work\",null,\"work queue\".getBytes()); } RabbitMQUtils.clone(channel,connection); } } æ¶ˆè´¹è€…1\nConnection connection = RabbitMQUtils.getConnection(); Channel channel = connection.createChannel(); channel.queueDeclare(\"work\",false,false,false,null); channel.basicConsume(\"work\",true,new DefaultConsumer(channel){ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { System.out.println(\"work æ¶ˆè´¹è€…1ï¼š\"+new String(body)); } }); æ¶ˆè´¹è€…2\nConnection connection = RabbitMQUtils.getConnection(); Channel channel = connection.createChannel(); channel.basicConsume(\"work\",true,new DefaultConsumer(channel){ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { System.out.println(\"work æ¶ˆè´¹è€…2ï¼š\"+new String(body)); } }); 3ã€fanout ç”Ÿäº§è€…\n//å°†é€šé“å£°æ˜ä¸ºäº¤æ¢æœº //å‚æ•°1ï¼šäº¤æ¢æœºåç§°ï¼›å‚æ•°2ï¼šäº¤æ¢æœºç±»å‹ fanoutä¸ºå¹¿æ’­ç±»å‹ channel.exchangeDeclare(\"logs\",\"fanout\"); //å‘é€æ¶ˆæ¯ channel.basicPublish(\"logs\",\"\",null,\"fanout type message\".getBytes()); RabbitMQUtils.clone(channel,connection); æ¶ˆè´¹è€…ä¸€\n//é€šé“å£°æ˜ä¸ºäº¤æ¢æœº channel.exchangeDeclare(\"logs\",\"fanout\"); //ä¸´æ—¶çš„é˜Ÿåˆ— String queue = channel.queueDeclare().getQueue(); //é€šé“ç»‘å®šä¸´æ—¶é˜Ÿåˆ—å’Œäº¤æ¢æœº channel.queueBind(queue,\"logs\",\"\"); channel.basicConsume(queue,true,new DefaultConsumer(channel){ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { System.out.println(\"fanout1====\u003e\"+new String(body)); } }); æ¶ˆè´¹è€…äºŒ\n//é€šé“å£°æ˜ä¸ºäº¤æ¢æœº channel.exchangeDeclare(\"logs\",\"fanout\"); //ä¸´æ—¶é˜Ÿåˆ— String queue = channel.queueDeclare().getQueue(); //é€šé“ç»‘å®šä¸´æ—¶é˜Ÿåˆ—å’Œäº¤æ¢æœº channel.queueBind(queue,\"logs\",\"\"); channel.basicConsume(queue,true,new DefaultConsumer(channel){ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { System.out.println(\"fanout2====\u003e\"+new String(body)); } }); 4ã€direct ç”Ÿäº§è€…\nchannel.exchangeDeclare(\"direct_logs\",\"direct\"); String routingKey = \"info\"; channel.basicPublish(\"direct_logs\",routingKey,null,(\"directå‘é€äº†ä¸€æ¡routingKeyä¸º\"+routingKey+\"çš„æ¶ˆæ¯\").getBytes()); æ¶ˆè´¹è€…ä¸€\nchannel.exchangeDeclare(\"direct_logs\",\"direct\"); String queue = channel.queueDeclare().getQueue(); channel.queueBind(queue,\"direct_logs\",\"error\"); channel.basicConsume(queue,true,new DefaultConsumer(channel){ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { System.out.println(\"directæ¶ˆè´¹è€…1: \"+new String(body)); } }); æ¶ˆè´¹è€…äºŒ\nchannel.exchangeDeclare(\"direct_logs\",\"direct\"); String queue = channel.queueDeclare().getQueue(); channel.queueBind(queue,\"direct_logs\",\"info\"); channel.queueBind(queue,\"direct_logs\",\"error\"); channel.basicConsume(queue,true,new DefaultConsumer(channel){ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { System.out.println(\"directæ¶ˆè´¹è€…2ï¼š\"+new String(body)); } }); 5ã€topic *ç¬¦å·å¯ä»¥ä»£æ›¿ä¸€ä¸ªå•è¯ã€‚ ï¼ƒç¬¦å·å¯ä»¥æ›¿ä»£é›¶ä¸ªæˆ–å¤šä¸ªå•è¯ã€‚ ç”Ÿäº§è€…\nchannel.exchangeDeclare(\"topic_logs\",\"topic\"); String routingKey = \"user.find.save\"; channel.basicPublish(\"topic_logs\",routingKey,null,(\"å‘é€äº†ä¸€æ¡routingKeyä¸º\"+routingKey+\"çš„æ¶ˆæ¯\").getBytes()); æ¶ˆè´¹è€…ä¸€\nchannel.exchangeDeclare(\"topic_logs\",\"topic\"); String queue = channel.queueDeclare().getQueue(); String routingKey = \"user.*\"; channel.queueBind(queue,\"topic_logs\",routingKey); channel.basicConsume(queue,true,new DefaultConsumer(channel){ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { System.out.println(\"topicæ¶ˆè´¹è€…1ï¼š\"+new String(body)); } }); æ¶ˆè´¹è€…äºŒ\nchannel.exchangeDeclare(\"topic_logs\",\"topic\"); String queue = channel.queueDeclare().getQueue(); String routingKey = \"user.#\"; channel.queueBind(queue,\"topic_logs\",routingKey); channel.basicConsume(queue,true,new DefaultConsumer(channel){ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { System.out.println(\"topicæ¶ˆè´¹è€…2ï¼š\"+new String(body)); } }); Springbootå®ç°æ–¹å¼ æ¶ˆè´¹è€…æ–¹ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœºçš„æ–¹å¼ ç¯å¢ƒ ",
  "wordCount" : "11788",
  "inLanguage": "zh",
  "datePublished": "2020-07-04T19:18:23+08:00",
  "dateModified": "2022-08-06T16:24:23+08:00",
  "author":[{
    "@type": "Person",
    "name": "ååä¹™"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://shaoyi.cc/posts/blog/mq/rabbitmq/rabbitmq/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ååä¹™çš„åšå®¢",
    "logo": {
      "@type": "ImageObject",
      "url": "http://shaoyi.cc/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://shaoyi.cc/" accesskey="h" title="ååä¹™çš„åšå®¢ (Alt + H)">ååä¹™çš„åšå®¢</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://shaoyi.cc/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="http://shaoyi.cc/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="http://shaoyi.cc/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ” æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="http://shaoyi.cc/archives/" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="http://shaoyi.cc/tags/" title="ğŸ§©æ ‡ç­¾">
                    <span>ğŸ§©æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="http://shaoyi.cc/about" title="ğŸ™‹ğŸ»â€â™‚ï¸å…³äº">
                    <span>ğŸ™‹ğŸ»â€â™‚ï¸å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://shaoyi.cc/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="http://shaoyi.cc/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="http://shaoyi.cc/posts/blog/">ğŸ“•æŠ€æœ¯</a></div>
    <h1 class="post-title">
      æ¶ˆæ¯ä¸­é—´ä»¶ä¹‹RabbitMQ
    </h1>
    <div class="post-description">
      RabbitMQä½¿ç”¨æ–¹å¼
    </div>
    <div class="post-meta">









åˆ›å»º:&nbsp;<span title='2020-07-04 19:18:23 +0800 CST'>2020-07-04</span>&nbsp;Â·&nbsp;æ›´æ–°:&nbsp;2022-08-06&nbsp;Â·&nbsp;å­—æ•°:&nbsp;11788å­—&nbsp;Â·&nbsp;
ä½œè€…:&nbsp;ååä¹™

</div>
  </header> <aside id="toc-container" class="toc-container wide">
        <div class="toc">
            <details  open>
                <summary accesskey="c" title="(Alt + C)">
                    <span class="details">ç›®å½•</span>
                </summary>

                <div class="inner"><ul>
                        <li>
                            <a href="#docker-%e5%ae%89%e8%a3%85rabbitmq" aria-label="Docker å®‰è£…RabbitMQ">Docker å®‰è£…RabbitMQ</a></li>
                        <li>
                            <a href="#java%e6%96%b9%e5%bc%8f%e5%ae%9e%e7%8e%b0rabbitmq" aria-label="Javaæ–¹å¼å®ç°RabbitMQ">Javaæ–¹å¼å®ç°RabbitMQ</a><ul>
                                    
                        <li>
                            <a href="#1helloword" aria-label="1ã€helloword">1ã€helloword</a></li>
                        <li>
                            <a href="#%e6%8f%90%e5%8f%96%e5%85%ac%e5%85%b1%e9%83%a8%e5%88%86%e5%88%9b%e5%bb%ba%e5%b7%a5%e5%85%b7%e7%b1%bb" aria-label="æå–å…¬å…±éƒ¨åˆ†ï¼Œåˆ›å»ºå·¥å…·ç±»">æå–å…¬å…±éƒ¨åˆ†ï¼Œåˆ›å»ºå·¥å…·ç±»</a></li>
                        <li>
                            <a href="#2work-queues" aria-label="2ã€Work queues">2ã€Work queues</a></li>
                        <li>
                            <a href="#3fanout" aria-label="3ã€fanout">3ã€fanout</a></li>
                        <li>
                            <a href="#4direct" aria-label="4ã€direct">4ã€direct</a></li>
                        <li>
                            <a href="#5topic" aria-label="5ã€topic">5ã€topic</a></li></ul>
                        </li>
                        <li>
                            <a href="#springboot%e5%ae%9e%e7%8e%b0%e6%96%b9%e5%bc%8f" aria-label="Springbootå®ç°æ–¹å¼">Springbootå®ç°æ–¹å¼</a><ul>
                                    
                        <li>
                            <a href="#%e6%b6%88%e8%b4%b9%e8%80%85%e6%96%b9%e7%bb%91%e5%ae%9a%e9%98%9f%e5%88%97%e5%92%8c%e4%ba%a4%e6%8d%a2%e6%9c%ba%e7%9a%84%e6%96%b9%e5%bc%8f" aria-label="æ¶ˆè´¹è€…æ–¹ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœºçš„æ–¹å¼">æ¶ˆè´¹è€…æ–¹ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœºçš„æ–¹å¼</a></li>
                        <li>
                            <a href="#%e7%8e%af%e5%a2%83" aria-label="ç¯å¢ƒ">ç¯å¢ƒ</a><ul>
                                    
                        <li>
                            <a href="#1helloword-1" aria-label="1ã€helloword">1ã€helloword</a></li>
                        <li>
                            <a href="#2work-queues-1" aria-label="2ã€Work queues">2ã€Work queues</a></li>
                        <li>
                            <a href="#3fanout-1" aria-label="3ã€fanout">3ã€fanout</a></li>
                        <li>
                            <a href="#4direct-1" aria-label="4ã€direct">4ã€direct</a></li>
                        <li>
                            <a href="#5topic-1" aria-label="5ã€topic">5ã€topic</a></li></ul>
                        </li>
                        <li>
                            <a href="#%e7%94%9f%e4%ba%a7%e8%80%85%e6%96%b9%e7%bb%91%e5%ae%9a%e9%98%9f%e5%88%97%e5%92%8c%e4%ba%a4%e6%8d%a2%e6%9c%ba%e7%9a%84%e6%96%b9%e5%bc%8f" aria-label="ç”Ÿäº§è€…æ–¹ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœºçš„æ–¹å¼">ç”Ÿäº§è€…æ–¹ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœºçš„æ–¹å¼</a><ul>
                                    
                        <li>
                            <a href="#1fanout" aria-label="1ã€fanout">1ã€fanout</a></li>
                        <li>
                            <a href="#%e7%94%9f%e4%ba%a7%e8%80%85%e6%96%b9" aria-label="ç”Ÿäº§è€…æ–¹">ç”Ÿäº§è€…æ–¹</a></li>
                        <li>
                            <a href="#%e6%b6%88%e8%b4%b9%e8%80%85%e6%96%b9" aria-label="æ¶ˆè´¹è€…æ–¹">æ¶ˆè´¹è€…æ–¹</a></li>
                        <li>
                            <a href="#2direct" aria-label="2ã€direct">2ã€direct</a></li>
                        <li>
                            <a href="#%e7%94%9f%e4%ba%a7%e8%80%85%e6%96%b9-1" aria-label="ç”Ÿäº§è€…æ–¹">ç”Ÿäº§è€…æ–¹</a></li>
                        <li>
                            <a href="#%e6%b6%88%e8%b4%b9%e8%80%85%e6%96%b9-1" aria-label="æ¶ˆè´¹è€…æ–¹">æ¶ˆè´¹è€…æ–¹</a></li>
                        <li>
                            <a href="#3topic" aria-label="3ã€topic">3ã€topic</a></li>
                        <li>
                            <a href="#%e7%94%9f%e4%ba%a7%e8%80%85" aria-label="ç”Ÿäº§è€…">ç”Ÿäº§è€…</a></li>
                        <li>
                            <a href="#%e6%b6%88%e8%b4%b9%e8%80%85%e6%96%b9-2" aria-label="æ¶ˆè´¹è€…æ–¹">æ¶ˆè´¹è€…æ–¹</a></li></ul>
                        </li></ul>
                        </li>
                        <li>
                            <a href="#rabbitmq%e7%9a%84%e9%ab%98%e7%ba%a7%e7%89%b9%e6%80%a7" aria-label="RabbitMQçš„é«˜çº§ç‰¹æ€§">RabbitMQçš„é«˜çº§ç‰¹æ€§</a><ul>
                                    
                        <li>
                            <a href="#%e7%94%9f%e4%ba%a7%e8%80%85%e6%96%b9%e6%b6%88%e6%81%af%e7%a1%ae%e8%ae%a4%e6%9c%ba%e5%88%b6" aria-label="ç”Ÿäº§è€…æ–¹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶">ç”Ÿäº§è€…æ–¹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶</a></li>
                        <li>
                            <a href="#%e6%b6%88%e8%b4%b9%e8%80%85%e6%96%b9%e6%b6%88%e6%81%af%e7%a1%ae%e8%ae%a4%e6%9c%ba%e5%88%b6" aria-label="æ¶ˆè´¹è€…æ–¹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶">æ¶ˆè´¹è€…æ–¹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶</a></li>
                        <li>
                            <a href="#%e6%b6%88%e8%b4%b9%e7%ab%af%e9%99%90%e6%b5%81" aria-label="æ¶ˆè´¹ç«¯é™æµ">æ¶ˆè´¹ç«¯é™æµ</a></li>
                        <li>
                            <a href="#ttl%e6%b6%88%e6%81%af%e8%bf%87%e6%9c%9f%e6%97%b6%e9%97%b4" aria-label="TTLï¼šæ¶ˆæ¯è¿‡æœŸæ—¶é—´">TTLï¼šæ¶ˆæ¯è¿‡æœŸæ—¶é—´</a><ul>
                                    
                        <li>
                            <a href="#1%e9%98%9f%e5%88%97%e5%86%85%e6%b6%88%e6%81%af%e7%bb%9f%e4%b8%80%e8%bf%87%e6%9c%9f" aria-label="1ã€é˜Ÿåˆ—å†…æ¶ˆæ¯ç»Ÿä¸€è¿‡æœŸ">1ã€é˜Ÿåˆ—å†…æ¶ˆæ¯ç»Ÿä¸€è¿‡æœŸ</a></li>
                        <li>
                            <a href="#2%e6%b6%88%e6%81%af%e5%8d%95%e7%8b%ac%e8%bf%87%e6%9c%9f" aria-label="2ã€æ¶ˆæ¯å•ç‹¬è¿‡æœŸ">2ã€æ¶ˆæ¯å•ç‹¬è¿‡æœŸ</a></li></ul>
                        </li>
                        <li>
                            <a href="#%e6%ad%bb%e4%bf%a1%e9%98%9f%e5%88%97" aria-label="æ­»ä¿¡é˜Ÿåˆ—">æ­»ä¿¡é˜Ÿåˆ—</a><ul>
                                    
                        <li>
                            <a href="#1%e6%b6%88%e6%81%afttl%e8%bf%87%e6%9c%9f" aria-label="1ã€æ¶ˆæ¯TTLè¿‡æœŸ">1ã€æ¶ˆæ¯TTLè¿‡æœŸ</a></li>
                        <li>
                            <a href="#2%e9%98%9f%e5%88%97%e8%be%be%e5%88%b0%e6%9c%80%e5%a4%a7%e9%95%bf%e5%ba%a6" aria-label="2ã€é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦">2ã€é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦</a></li>
                        <li>
                            <a href="#3%e6%b6%88%e6%81%af%e8%a2%ab%e6%8b%92%e7%bb%9d" aria-label="3ã€æ¶ˆæ¯è¢«æ‹’ç»">3ã€æ¶ˆæ¯è¢«æ‹’ç»</a></li></ul>
                        </li>
                        <li>
                            <a href="#%e5%bb%b6%e8%bf%9f%e9%98%9f%e5%88%97" aria-label="å»¶è¿Ÿé˜Ÿåˆ—">å»¶è¿Ÿé˜Ÿåˆ—</a></li>
                        <li>
                            <a href="#%e5%bb%b6%e8%bf%9f%e9%98%9f%e5%88%97%e6%8f%92%e4%bb%b6%e6%96%b9%e5%bc%8f" aria-label="å»¶è¿Ÿé˜Ÿåˆ—ï¼ˆæ’ä»¶æ–¹å¼ï¼‰">å»¶è¿Ÿé˜Ÿåˆ—ï¼ˆæ’ä»¶æ–¹å¼ï¼‰</a><ul>
                                    
                        <li>
                            <a href="#%e6%b6%88%e8%b4%b9%e8%80%85%e6%96%b9%e7%bb%91%e5%ae%9a%e6%96%b9%e5%bc%8f%e5%ae%9e%e7%8e%b0%e5%bb%b6%e8%bf%9f%e9%98%9f%e5%88%97" aria-label="æ¶ˆè´¹è€…æ–¹ç»‘å®šæ–¹å¼å®ç°å»¶è¿Ÿé˜Ÿåˆ—">æ¶ˆè´¹è€…æ–¹ç»‘å®šæ–¹å¼å®ç°å»¶è¿Ÿé˜Ÿåˆ—</a></li></ul>
                        </li></ul>
                        </li>
                        <li>
                            <a href="#%e8%bf%9e%e6%8e%a5%e5%a4%9a%e4%b8%aarabbitmq%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%88%96virtual-host" aria-label="è¿æ¥å¤šä¸ªRabbitMqçš„æœåŠ¡æˆ–Virtual-Host">è¿æ¥å¤šä¸ªRabbitMqçš„æœåŠ¡æˆ–Virtual-Host</a><ul>
                                    
                        <li>
                            <a href="#%e8%87%aa%e5%ae%9a%e4%b9%89%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e5%86%85%e5%ae%b9" aria-label="è‡ªå®šä¹‰é…ç½®æ–‡ä»¶å†…å®¹">è‡ªå®šä¹‰é…ç½®æ–‡ä»¶å†…å®¹</a></li>
                        <li>
                            <a href="#%e5%88%9b%e5%bb%ba%e5%af%b9%e5%ba%94%e7%9a%84properties%e5%b1%9e%e6%80%a7%e7%b1%bb" aria-label="åˆ›å»ºå¯¹åº”çš„Propertieså±æ€§ç±»">åˆ›å»ºå¯¹åº”çš„Propertieså±æ€§ç±»</a></li>
                        <li>
                            <a href="#rabbitmq%e9%85%8d%e7%bd%ae%e7%b1%bb" aria-label="Rabbitmqé…ç½®ç±»">Rabbitmqé…ç½®ç±»</a></li>
                        <li>
                            <a href="#%e5%8f%91%e9%80%81%e6%b6%88%e6%81%af" aria-label="å‘é€æ¶ˆæ¯">å‘é€æ¶ˆæ¯</a></li>
                        <li>
                            <a href="#%e6%8e%a5%e5%8f%97%e6%b6%88%e6%81%af" aria-label="æ¥å—æ¶ˆæ¯">æ¥å—æ¶ˆæ¯</a>
                        </li>
                    </ul>
                    </li>
                    </ul>
                </div>
            </details>
        </div>
    </aside>
    <script>
        let activeElement;
        let elements;
        window.addEventListener('DOMContentLoaded', function (event) {
            checkTocPosition();

            elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }, false);

        window.addEventListener('resize', function (event) {
            checkTocPosition();
        }, false);

        window.addEventListener('scroll', () => {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                    (getOffsetTop(element) - window.pageYOffset) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement

            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                if (element === activeElement) {
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
                } else {
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
                }
            })
        }, false);

        const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
        const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
        const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

        function checkTocPosition() {
            const width = document.body.scrollWidth;

            if (width - main - (toc * 2) - (gap * 4) > 0) {
                document.getElementById("toc-container").classList.add("wide");
            } else {
                document.getElementById("toc-container").classList.remove("wide");
            }
        }

        function getOffsetTop(element) {
            if (!element.getClientRects().length) {
                return 0;
            }
            let rect = element.getBoundingClientRect();
            let win = element.ownerDocument.defaultView;
            return rect.top + win.pageYOffset;
        }
    </script>
  <div class="post-content"><h1 id="docker-å®‰è£…rabbitmq">Docker å®‰è£…RabbitMQ<a hidden class="anchor" aria-hidden="true" href="#docker-å®‰è£…rabbitmq">#</a></h1>
<blockquote>
<p>è¿™é‡Œæ³¨æ„è·å–é•œåƒçš„æ—¶å€™è¦è·å–managementç‰ˆæœ¬çš„ï¼Œä¸è¦è·å–lastç‰ˆæœ¬çš„ï¼Œmanagementç‰ˆæœ¬çš„æ‰å¸¦æœ‰ç®¡ç†ç•Œé¢ã€‚</p>
</blockquote>
<p><strong>æŸ¥è¯¢é•œåƒ</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f">#æœç´¢RabbitMQé•œåƒ</span>
</span></span><span style="display:flex;"><span>[root@shishiyi /]<span style="color:#007f7f"># docker search rabbitmq:management</span>
</span></span></code></pre></div><p>å¾—åˆ°ä¸‹åˆ—ç»“æœ</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/29/0eAeED.png" alt="0eAeED.png"  />
</p>
<p><strong>ä¸‹è½½é•œåƒ</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f">#ä¸‹è½½RabbitMQé•œåƒ</span>
</span></span><span style="display:flex;"><span>[root@shishiyi /]<span style="color:#007f7f"># docker pull rabbitmq:management</span>
</span></span></code></pre></div><p>å‡ºç°å¦‚ä¸‹ç»“æœ</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/29/0eAIr6.png" alt="0eAIr6.png"  />
</p>
<p><strong>è¿è¡Œé•œåƒ</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f">#è¿è¡ŒRabbitMQé•œåƒ</span>
</span></span><span style="display:flex;"><span>[root@shishiyi /]<span style="color:#007f7f"># docker run -d -p 5672:5672 -p 15672:15672 --name rabbitmq rabbitmq:management</span>
</span></span></code></pre></div><p><strong>è®¿é—®ç®¡ç†ç•Œé¢</strong></p>
<p>åœ°å€ä¸º   æœåŠ¡å™¨ip:15672  ç”¨æˆ·åå’Œå¯†ç éƒ½æ˜¯guest</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/09/29/0eVwn0.png" alt="0eVwn0.png"  />
</p>
<h1 id="javaæ–¹å¼å®ç°rabbitmq">Javaæ–¹å¼å®ç°RabbitMQ<a hidden class="anchor" aria-hidden="true" href="#javaæ–¹å¼å®ç°rabbitmq">#</a></h1>
<h2 id="1helloword">1ã€helloword<a hidden class="anchor" aria-hidden="true" href="#1helloword">#</a></h2>
<p><strong>ç”Ÿäº§è€…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.rabbitmq.client.Channel;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.rabbitmq.client.Connection;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.rabbitmq.client.ConnectionFactory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.concurrent.TimeoutException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Provider {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> IOException, TimeoutException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºmqçš„è¿æ¥å·¥å‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ConnectionFactory connectionFactory = <span style="color:#fff;font-weight:bold">new</span> ConnectionFactory();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½®è¿æ¥çš„æœåŠ¡å™¨IP
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        connectionFactory.<span style="color:#007f7f">setHost</span>(<span style="color:#0ff;font-weight:bold">&#34;æœåŠ¡å™¨ip&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½®ç«¯å£å·
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        connectionFactory.<span style="color:#007f7f">setPort</span>(5672);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½®è¿æ¥çš„è™šæ‹Ÿä¸»æœºï¼ˆç±»ä¼¼æ•°æ®åº“ä¸­çš„åº“ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        connectionFactory.<span style="color:#007f7f">setVirtualHost</span>(<span style="color:#0ff;font-weight:bold">&#34;/ems&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½®ç”¨æˆ·å
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        connectionFactory.<span style="color:#007f7f">setUsername</span>(<span style="color:#0ff;font-weight:bold">&#34;ems&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½®å¯†ç 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        connectionFactory.<span style="color:#007f7f">setPassword</span>(<span style="color:#0ff;font-weight:bold">&#34;123&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è·å–è¿æ¥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Connection connection = connectionFactory.<span style="color:#007f7f">newConnection</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è·å–è¿æ¥çš„é€šé“
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Channel channel = connection.<span style="color:#007f7f">createChannel</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//é€šé“ç»‘å®šæ¶ˆæ¯é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//å‚æ•°1ï¼šé˜Ÿåˆ—åç§°ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»º
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//å‚æ•°2ï¼šæ˜¯å¦æŒä¹…é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//å‚æ•°3ï¼šæ˜¯å¦ç‹¬å é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//å‚æ•°4ï¼š æ˜¯å¦æ¶ˆè´¹å®Œæ¯•åˆ é™¤é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//å‚æ•°5ï¼šé¢å¤–é™„åŠ å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        channel.<span style="color:#007f7f">queueDeclare</span>(<span style="color:#0ff;font-weight:bold">&#34;hello&#34;</span>,<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å‘å¸ƒæ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//å‚æ•°1ï¼šäº¤æ¢æœºï¼›å‚æ•°2ï¼šé˜Ÿåˆ—åç§°ï¼›å‚æ•°3ï¼šä¼ é€’æ¶ˆæ¯çš„é¢å¤–è®¾ç½®ï¼›å‚æ•°4ï¼šæ¶ˆæ¯å†…å®¹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        channel.<span style="color:#007f7f">basicPublish</span>(<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;hello&#34;</span>,<span style="color:#fff;font-weight:bold">null</span>,<span style="color:#0ff;font-weight:bold">&#34;hello rabbitmq&#34;</span>.<span style="color:#007f7f">getBytes</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å…³é—­èµ„æº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        channel.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>æ¶ˆè´¹è€…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.rabbitmq.client.*;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.concurrent.TimeoutException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Consumer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> IOException, TimeoutException {
</span></span><span style="display:flex;"><span>        ConnectionFactory connectionFactory = <span style="color:#fff;font-weight:bold">new</span> ConnectionFactory();
</span></span><span style="display:flex;"><span>        connectionFactory.<span style="color:#007f7f">setHost</span>(<span style="color:#0ff;font-weight:bold">&#34;æœåŠ¡å™¨ip&#34;</span>);
</span></span><span style="display:flex;"><span>        connectionFactory.<span style="color:#007f7f">setPort</span>(5672);
</span></span><span style="display:flex;"><span>        connectionFactory.<span style="color:#007f7f">setVirtualHost</span>(<span style="color:#0ff;font-weight:bold">&#34;/ems&#34;</span>);
</span></span><span style="display:flex;"><span>        connectionFactory.<span style="color:#007f7f">setUsername</span>(<span style="color:#0ff;font-weight:bold">&#34;ems&#34;</span>);
</span></span><span style="display:flex;"><span>        connectionFactory.<span style="color:#007f7f">setPassword</span>(<span style="color:#0ff;font-weight:bold">&#34;123&#34;</span>);
</span></span><span style="display:flex;"><span>        Connection connection = connectionFactory.<span style="color:#007f7f">newConnection</span>();
</span></span><span style="display:flex;"><span>        Channel channel = connection.<span style="color:#007f7f">createChannel</span>();
</span></span><span style="display:flex;"><span>        channel.<span style="color:#007f7f">queueDeclare</span>(<span style="color:#0ff;font-weight:bold">&#34;hello&#34;</span>,<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å‚æ•°1ï¼šé˜Ÿåˆ—åç§°ï¼Œå‚æ•°2ï¼šå¼€å§‹æ¶ˆæ¯çš„è‡ªåŠ¨ç¡®è®¤æœºåˆ¶ï¼Œå‚æ•°3ï¼šæ¶ˆè´¹æ—¶çš„å›è°ƒæ¥å£
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        channel.<span style="color:#007f7f">basicConsume</span>(<span style="color:#0ff;font-weight:bold">&#34;hello&#34;</span>,<span style="color:#fff;font-weight:bold">true</span>,<span style="color:#fff;font-weight:bold">new</span> DefaultConsumer(channel){
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> handleDelivery(String consumerTag, Envelope envelope, AMQP.<span style="color:#007f7f">BasicProperties</span> properties, <span style="color:#fff;font-weight:bold">byte</span>[] body) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>                System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;æ¶ˆè´¹çš„å†…å®¹ï¼š&#34;</span>+<span style="color:#fff;font-weight:bold">new</span> String(body));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="æå–å…¬å…±éƒ¨åˆ†åˆ›å»ºå·¥å…·ç±»">æå–å…¬å…±éƒ¨åˆ†ï¼Œåˆ›å»ºå·¥å…·ç±»<a hidden class="anchor" aria-hidden="true" href="#æå–å…¬å…±éƒ¨åˆ†åˆ›å»ºå·¥å…·ç±»">#</a></h2>
<p><strong>RabbitMQUtils</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.rabbitmq.client.Channel;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.rabbitmq.client.Connection;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.rabbitmq.client.ConnectionFactory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.concurrent.TimeoutException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> RabbitMQUtils {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> ConnectionFactory connectionFactory = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> {
</span></span><span style="display:flex;"><span>        connectionFactory = <span style="color:#fff;font-weight:bold">new</span> ConnectionFactory();
</span></span><span style="display:flex;"><span>        connectionFactory.<span style="color:#007f7f">setHost</span>(<span style="color:#0ff;font-weight:bold">&#34;æœåŠ¡å™¨ip&#34;</span>);
</span></span><span style="display:flex;"><span>        connectionFactory.<span style="color:#007f7f">setPort</span>(5672);
</span></span><span style="display:flex;"><span>        connectionFactory.<span style="color:#007f7f">setVirtualHost</span>(<span style="color:#0ff;font-weight:bold">&#34;/ems&#34;</span>);
</span></span><span style="display:flex;"><span>        connectionFactory.<span style="color:#007f7f">setUsername</span>(<span style="color:#0ff;font-weight:bold">&#34;ems&#34;</span>);
</span></span><span style="display:flex;"><span>        connectionFactory.<span style="color:#007f7f">setPassword</span>(<span style="color:#0ff;font-weight:bold">&#34;123&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//è·å–è¿æ¥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> Connection getConnection(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            Connection connection = connectionFactory.<span style="color:#007f7f">newConnection</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> connection;
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (TimeoutException e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å…³é—­èµ„æº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> clone(Channel channel , Connection connection){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">null</span> !=channel)
</span></span><span style="display:flex;"><span>                channel.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">null</span> != connection)
</span></span><span style="display:flex;"><span>                connection.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (TimeoutException e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="2work-queues">2ã€Work queues<a hidden class="anchor" aria-hidden="true" href="#2work-queues">#</a></h2>
<p><strong>ç”Ÿäº§è€…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.shishiyi.work;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.rabbitmq.client.Channel;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.rabbitmq.client.Connection;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.shishiyi.utils.RabbitMQUtils;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Provider {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        Connection connection = RabbitMQUtils.<span style="color:#007f7f">getConnection</span>();
</span></span><span style="display:flex;"><span>        Channel channel = connection.<span style="color:#007f7f">createChannel</span>();
</span></span><span style="display:flex;"><span>        channel.<span style="color:#007f7f">queueDeclare</span>(<span style="color:#0ff;font-weight:bold">&#34;work&#34;</span>,<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 0; i &lt; 10 ; i++) {
</span></span><span style="display:flex;"><span>            channel.<span style="color:#007f7f">basicPublish</span>(<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;work&#34;</span>,<span style="color:#fff;font-weight:bold">null</span>,<span style="color:#0ff;font-weight:bold">&#34;work queue&#34;</span>.<span style="color:#007f7f">getBytes</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        RabbitMQUtils.<span style="color:#007f7f">clone</span>(channel,connection);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>æ¶ˆè´¹è€…1</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Connection connection = RabbitMQUtils.<span style="color:#007f7f">getConnection</span>();
</span></span><span style="display:flex;"><span>    Channel channel = connection.<span style="color:#007f7f">createChannel</span>();
</span></span><span style="display:flex;"><span>    channel.<span style="color:#007f7f">queueDeclare</span>(<span style="color:#0ff;font-weight:bold">&#34;work&#34;</span>,<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>    channel.<span style="color:#007f7f">basicConsume</span>(<span style="color:#0ff;font-weight:bold">&#34;work&#34;</span>,<span style="color:#fff;font-weight:bold">true</span>,<span style="color:#fff;font-weight:bold">new</span> DefaultConsumer(channel){
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> handleDelivery(String consumerTag, Envelope envelope, AMQP.<span style="color:#007f7f">BasicProperties</span> properties, <span style="color:#fff;font-weight:bold">byte</span>[] body) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;work æ¶ˆè´¹è€…1ï¼š&#34;</span>+<span style="color:#fff;font-weight:bold">new</span> String(body));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span></code></pre></div><p><strong>æ¶ˆè´¹è€…2</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Connection connection = RabbitMQUtils.<span style="color:#007f7f">getConnection</span>();
</span></span><span style="display:flex;"><span>    Channel channel = connection.<span style="color:#007f7f">createChannel</span>();
</span></span><span style="display:flex;"><span>    channel.<span style="color:#007f7f">basicConsume</span>(<span style="color:#0ff;font-weight:bold">&#34;work&#34;</span>,<span style="color:#fff;font-weight:bold">true</span>,<span style="color:#fff;font-weight:bold">new</span> DefaultConsumer(channel){
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> handleDelivery(String consumerTag, Envelope envelope, AMQP.<span style="color:#007f7f">BasicProperties</span> properties, <span style="color:#fff;font-weight:bold">byte</span>[] body) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;work æ¶ˆè´¹è€…2ï¼š&#34;</span>+<span style="color:#fff;font-weight:bold">new</span> String(body));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span></code></pre></div><h2 id="3fanout">3ã€fanout<a hidden class="anchor" aria-hidden="true" href="#3fanout">#</a></h2>
<p><strong>ç”Ÿäº§è€…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//å°†é€šé“å£°æ˜ä¸ºäº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//å‚æ•°1ï¼šäº¤æ¢æœºåç§°ï¼›å‚æ•°2ï¼šäº¤æ¢æœºç±»å‹  fanoutä¸ºå¹¿æ’­ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>channel.<span style="color:#007f7f">exchangeDeclare</span>(<span style="color:#0ff;font-weight:bold">&#34;logs&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;fanout&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//å‘é€æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>channel.<span style="color:#007f7f">basicPublish</span>(<span style="color:#0ff;font-weight:bold">&#34;logs&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>,<span style="color:#fff;font-weight:bold">null</span>,<span style="color:#0ff;font-weight:bold">&#34;fanout type message&#34;</span>.<span style="color:#007f7f">getBytes</span>());
</span></span><span style="display:flex;"><span>RabbitMQUtils.<span style="color:#007f7f">clone</span>(channel,connection);
</span></span></code></pre></div><p><strong>æ¶ˆè´¹è€…ä¸€</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//é€šé“å£°æ˜ä¸ºäº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>channel.<span style="color:#007f7f">exchangeDeclare</span>(<span style="color:#0ff;font-weight:bold">&#34;logs&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;fanout&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//ä¸´æ—¶çš„é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>String queue = channel.<span style="color:#007f7f">queueDeclare</span>().<span style="color:#007f7f">getQueue</span>();
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//é€šé“ç»‘å®šä¸´æ—¶é˜Ÿåˆ—å’Œäº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>channel.<span style="color:#007f7f">queueBind</span>(queue,<span style="color:#0ff;font-weight:bold">&#34;logs&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>channel.<span style="color:#007f7f">basicConsume</span>(queue,<span style="color:#fff;font-weight:bold">true</span>,<span style="color:#fff;font-weight:bold">new</span> DefaultConsumer(channel){
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> handleDelivery(String consumerTag, Envelope envelope, AMQP.<span style="color:#007f7f">BasicProperties</span> properties, <span style="color:#fff;font-weight:bold">byte</span>[] body) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;fanout1====&gt;&#34;</span>+<span style="color:#fff;font-weight:bold">new</span> String(body));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p><strong>æ¶ˆè´¹è€…äºŒ</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//é€šé“å£°æ˜ä¸ºäº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>channel.<span style="color:#007f7f">exchangeDeclare</span>(<span style="color:#0ff;font-weight:bold">&#34;logs&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;fanout&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//ä¸´æ—¶é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>String queue = channel.<span style="color:#007f7f">queueDeclare</span>().<span style="color:#007f7f">getQueue</span>();
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//é€šé“ç»‘å®šä¸´æ—¶é˜Ÿåˆ—å’Œäº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>channel.<span style="color:#007f7f">queueBind</span>(queue,<span style="color:#0ff;font-weight:bold">&#34;logs&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>channel.<span style="color:#007f7f">basicConsume</span>(queue,<span style="color:#fff;font-weight:bold">true</span>,<span style="color:#fff;font-weight:bold">new</span> DefaultConsumer(channel){
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> handleDelivery(String consumerTag, Envelope envelope, AMQP.<span style="color:#007f7f">BasicProperties</span> properties, <span style="color:#fff;font-weight:bold">byte</span>[] body) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;fanout2====&gt;&#34;</span>+<span style="color:#fff;font-weight:bold">new</span> String(body));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><h2 id="4direct">4ã€direct<a hidden class="anchor" aria-hidden="true" href="#4direct">#</a></h2>
<p><strong>ç”Ÿäº§è€…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>channel.<span style="color:#007f7f">exchangeDeclare</span>(<span style="color:#0ff;font-weight:bold">&#34;direct_logs&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;direct&#34;</span>);
</span></span><span style="display:flex;"><span>String routingKey = <span style="color:#0ff;font-weight:bold">&#34;info&#34;</span>;
</span></span><span style="display:flex;"><span>channel.<span style="color:#007f7f">basicPublish</span>(<span style="color:#0ff;font-weight:bold">&#34;direct_logs&#34;</span>,routingKey,<span style="color:#fff;font-weight:bold">null</span>,(<span style="color:#0ff;font-weight:bold">&#34;directå‘é€äº†ä¸€æ¡routingKeyä¸º&#34;</span>+routingKey+<span style="color:#0ff;font-weight:bold">&#34;çš„æ¶ˆæ¯&#34;</span>).<span style="color:#007f7f">getBytes</span>());
</span></span></code></pre></div><p><strong>æ¶ˆè´¹è€…ä¸€</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    channel.<span style="color:#007f7f">exchangeDeclare</span>(<span style="color:#0ff;font-weight:bold">&#34;direct_logs&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;direct&#34;</span>);
</span></span><span style="display:flex;"><span>    String queue = channel.<span style="color:#007f7f">queueDeclare</span>().<span style="color:#007f7f">getQueue</span>();
</span></span><span style="display:flex;"><span>    channel.<span style="color:#007f7f">queueBind</span>(queue,<span style="color:#0ff;font-weight:bold">&#34;direct_logs&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;error&#34;</span>);
</span></span><span style="display:flex;"><span>    channel.<span style="color:#007f7f">basicConsume</span>(queue,<span style="color:#fff;font-weight:bold">true</span>,<span style="color:#fff;font-weight:bold">new</span> DefaultConsumer(channel){
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> handleDelivery(String consumerTag, Envelope envelope, AMQP.<span style="color:#007f7f">BasicProperties</span> properties, <span style="color:#fff;font-weight:bold">byte</span>[] body) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;directæ¶ˆè´¹è€…1: &#34;</span>+<span style="color:#fff;font-weight:bold">new</span> String(body));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span></code></pre></div><p><strong>æ¶ˆè´¹è€…äºŒ</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    channel.<span style="color:#007f7f">exchangeDeclare</span>(<span style="color:#0ff;font-weight:bold">&#34;direct_logs&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;direct&#34;</span>);
</span></span><span style="display:flex;"><span>    String queue = channel.<span style="color:#007f7f">queueDeclare</span>().<span style="color:#007f7f">getQueue</span>();
</span></span><span style="display:flex;"><span>    channel.<span style="color:#007f7f">queueBind</span>(queue,<span style="color:#0ff;font-weight:bold">&#34;direct_logs&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;info&#34;</span>);
</span></span><span style="display:flex;"><span>    channel.<span style="color:#007f7f">queueBind</span>(queue,<span style="color:#0ff;font-weight:bold">&#34;direct_logs&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;error&#34;</span>);
</span></span><span style="display:flex;"><span>    channel.<span style="color:#007f7f">basicConsume</span>(queue,<span style="color:#fff;font-weight:bold">true</span>,<span style="color:#fff;font-weight:bold">new</span> DefaultConsumer(channel){
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> handleDelivery(String consumerTag, Envelope envelope, AMQP.<span style="color:#007f7f">BasicProperties</span> properties, <span style="color:#fff;font-weight:bold">byte</span>[] body) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;directæ¶ˆè´¹è€…2ï¼š&#34;</span>+<span style="color:#fff;font-weight:bold">new</span> String(body));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span></code></pre></div><h2 id="5topic">5ã€topic<a hidden class="anchor" aria-hidden="true" href="#5topic">#</a></h2>
<ul>
<li>*ç¬¦å·å¯ä»¥ä»£æ›¿ä¸€ä¸ªå•è¯ã€‚</li>
<li>ï¼ƒç¬¦å·å¯ä»¥æ›¿ä»£é›¶ä¸ªæˆ–å¤šä¸ªå•è¯ã€‚</li>
</ul>
<p><strong>ç”Ÿäº§è€…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>channel.<span style="color:#007f7f">exchangeDeclare</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_logs&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;topic&#34;</span>);
</span></span><span style="display:flex;"><span>String routingKey = <span style="color:#0ff;font-weight:bold">&#34;user.find.save&#34;</span>;
</span></span><span style="display:flex;"><span>channel.<span style="color:#007f7f">basicPublish</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_logs&#34;</span>,routingKey,<span style="color:#fff;font-weight:bold">null</span>,(<span style="color:#0ff;font-weight:bold">&#34;å‘é€äº†ä¸€æ¡routingKeyä¸º&#34;</span>+routingKey+<span style="color:#0ff;font-weight:bold">&#34;çš„æ¶ˆæ¯&#34;</span>).<span style="color:#007f7f">getBytes</span>());
</span></span></code></pre></div><p><strong>æ¶ˆè´¹è€…ä¸€</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    channel.<span style="color:#007f7f">exchangeDeclare</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_logs&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;topic&#34;</span>);
</span></span><span style="display:flex;"><span>    String queue = channel.<span style="color:#007f7f">queueDeclare</span>().<span style="color:#007f7f">getQueue</span>();
</span></span><span style="display:flex;"><span>    String routingKey = <span style="color:#0ff;font-weight:bold">&#34;user.*&#34;</span>;
</span></span><span style="display:flex;"><span>    channel.<span style="color:#007f7f">queueBind</span>(queue,<span style="color:#0ff;font-weight:bold">&#34;topic_logs&#34;</span>,routingKey);
</span></span><span style="display:flex;"><span>    channel.<span style="color:#007f7f">basicConsume</span>(queue,<span style="color:#fff;font-weight:bold">true</span>,<span style="color:#fff;font-weight:bold">new</span> DefaultConsumer(channel){
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> handleDelivery(String consumerTag, Envelope envelope, AMQP.<span style="color:#007f7f">BasicProperties</span> properties, <span style="color:#fff;font-weight:bold">byte</span>[] body) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;topicæ¶ˆè´¹è€…1ï¼š&#34;</span>+<span style="color:#fff;font-weight:bold">new</span> String(body));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span></code></pre></div><p><strong>æ¶ˆè´¹è€…äºŒ</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    channel.<span style="color:#007f7f">exchangeDeclare</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_logs&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;topic&#34;</span>);
</span></span><span style="display:flex;"><span>    String queue = channel.<span style="color:#007f7f">queueDeclare</span>().<span style="color:#007f7f">getQueue</span>();
</span></span><span style="display:flex;"><span>    String routingKey = <span style="color:#0ff;font-weight:bold">&#34;user.#&#34;</span>;
</span></span><span style="display:flex;"><span>    channel.<span style="color:#007f7f">queueBind</span>(queue,<span style="color:#0ff;font-weight:bold">&#34;topic_logs&#34;</span>,routingKey);
</span></span><span style="display:flex;"><span>    channel.<span style="color:#007f7f">basicConsume</span>(queue,<span style="color:#fff;font-weight:bold">true</span>,<span style="color:#fff;font-weight:bold">new</span> DefaultConsumer(channel){
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> handleDelivery(String consumerTag, Envelope envelope, AMQP.<span style="color:#007f7f">BasicProperties</span> properties, <span style="color:#fff;font-weight:bold">byte</span>[] body) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;topicæ¶ˆè´¹è€…2ï¼š&#34;</span>+<span style="color:#fff;font-weight:bold">new</span> String(body));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span></code></pre></div><h1 id="springbootå®ç°æ–¹å¼">Springbootå®ç°æ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#springbootå®ç°æ–¹å¼">#</a></h1>
<h2 id="æ¶ˆè´¹è€…æ–¹ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœºçš„æ–¹å¼">æ¶ˆè´¹è€…æ–¹ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœºçš„æ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#æ¶ˆè´¹è€…æ–¹ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœºçš„æ–¹å¼">#</a></h2>
<blockquote>
<h2 id="ç¯å¢ƒ">ç¯å¢ƒ<a hidden class="anchor" aria-hidden="true" href="#ç¯å¢ƒ">#</a></h2>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#007f7f">&lt;!--åˆ›å»ºSpringbootå·¥ç¨‹ï¼Œå¯¼å…¥Mavenä¾èµ–-â€”â€”&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">&lt;dependency&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">    &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">&lt;/dependency&gt;
</span></span></span></code></pre></div><p>ç¼–å†™application.ymlæ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">application</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: rabbitmq_springboot
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">rabbitmq</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">host</span>: æœåŠ¡å™¨ip
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">5672</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: ems <span style="color:#007f7f">#ç”¨æˆ·å </span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: <span style="color:#ff0;font-weight:bold">123</span> <span style="color:#007f7f">#å¯†ç </span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">virtual-host</span>: /ems	#è™šæ‹Ÿæœºåç§°
</span></span></code></pre></div><h3 id="1helloword-1">1ã€helloword<a hidden class="anchor" aria-hidden="true" href="#1helloword-1">#</a></h3>
<p><strong>ç”Ÿäº§è€…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Autowired
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> RabbitTemplate rabbitTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> test() {
</span></span><span style="display:flex;"><span>    rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;hello&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;hello world&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>æ¶ˆè´¹è€…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.Queue;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.RabbitHandler;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span>@RabbitListener(queuesToDeclare = @Queue(<span style="color:#0ff;font-weight:bold">&#34;hello&#34;</span>))
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Consumer_hello {
</span></span><span style="display:flex;"><span>    @RabbitHandler
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> receive(String message){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;æ¶ˆè´¹çš„å†…å®¹ï¼š&#34;</span>+message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="2work-queues-1">2ã€Work queues<a hidden class="anchor" aria-hidden="true" href="#2work-queues-1">#</a></h3>
<p><strong>ç”Ÿäº§è€…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Autowired
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> RabbitTemplate rabbitTemplate;
</span></span><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> work(){
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 0; i &lt; 10; i++) {
</span></span><span style="display:flex;"><span>        rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;work&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34; work &#34;</span>+i);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>æ¶ˆè´¹è€…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.Queue;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Consumer_Work {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @RabbitListener(queuesToDeclare = @Queue(<span style="color:#0ff;font-weight:bold">&#34;work&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> receive1(String messages){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;workæ¶ˆè´¹è€…1:&#34;</span>+messages);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @RabbitListener(queuesToDeclare = @Queue(<span style="color:#0ff;font-weight:bold">&#34;work&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> receive2(String messages){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;workæ¶ˆè´¹è€…2:&#34;</span>+messages);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="3fanout-1">3ã€fanout<a hidden class="anchor" aria-hidden="true" href="#3fanout-1">#</a></h3>
<p><strong>ç”Ÿäº§è€…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Autowired
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> RabbitTemplate rabbitTemplate;
</span></span><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> fanout(){
</span></span><span style="display:flex;"><span>    rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;fanout_logs&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;fanoutå‘çš„æ¶ˆæ¯&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>æ¶ˆè´¹è€…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.Exchange;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.Queue;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Consumer_Fanout {
</span></span><span style="display:flex;"><span>    @RabbitListener(bindings = {
</span></span><span style="display:flex;"><span>            @QueueBinding(
</span></span><span style="display:flex;"><span>                value = @Queue, 	<span style="color:#007f7f">//åˆ›å»ºä¸´æ—¶é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                exchange = @Exchange(value = <span style="color:#0ff;font-weight:bold">&#34;logs_fanout&#34;</span>,type = <span style="color:#0ff;font-weight:bold">&#34;fanout&#34;</span>) 	<span style="color:#007f7f">//è‡ªå®šä¹‰äº¤æ¢æœºåç§°å’Œç±»å‹ï¼Œå¹¶ç»‘å®šäº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    )})
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> receive1(String messages){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;fanoutæ¶ˆè´¹è€…1:&#34;</span>+messages);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @RabbitListener(bindings = {
</span></span><span style="display:flex;"><span>            @QueueBinding(
</span></span><span style="display:flex;"><span>                value = @Queue,     <span style="color:#007f7f">//åˆ›å»ºä¸´æ—¶é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                exchange = @Exchange(value = <span style="color:#0ff;font-weight:bold">&#34;logs_fanout&#34;</span>,type = <span style="color:#0ff;font-weight:bold">&#34;fanout&#34;</span>)     <span style="color:#007f7f">//è‡ªå®šä¹‰äº¤æ¢æœºåç§°å’Œç±»å‹ï¼Œå¹¶ç»‘å®šäº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    )})
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> receive2(String messages){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;fanoutæ¶ˆè´¹è€…2:&#34;</span>+messages);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="4direct-1">4ã€direct<a hidden class="anchor" aria-hidden="true" href="#4direct-1">#</a></h3>
<p><strong>ç”Ÿäº§è€…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Autowired
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> RabbitTemplate rabbitTemplate;
</span></span><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> route(){
</span></span><span style="display:flex;"><span>    String routingKey = <span style="color:#0ff;font-weight:bold">&#34;info&#34;</span>;
</span></span><span style="display:flex;"><span>    rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;route_logs&#34;</span>,routingKey,<span style="color:#0ff;font-weight:bold">&#34;infoçš„æ¶ˆæ¯&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>æ¶ˆè´¹è€…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.Exchange;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.Queue;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Consumer_Route {
</span></span><span style="display:flex;"><span>    @RabbitListener(
</span></span><span style="display:flex;"><span>            bindings = @QueueBinding(
</span></span><span style="display:flex;"><span>                    value = @Queue,		<span style="color:#007f7f">//åˆ›å»ºä¸´æ—¶é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    exchange = @Exchange(value = <span style="color:#0ff;font-weight:bold">&#34;route_logs&#34;</span>,type = <span style="color:#0ff;font-weight:bold">&#34;direct&#34;</span>),		<span style="color:#007f7f">//è‡ªå®šä¹‰äº¤æ¢æœºåç§°å’Œç±»å‹ï¼Œå¹¶ç»‘å®šäº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    key = {<span style="color:#0ff;font-weight:bold">&#34;error&#34;</span>}		<span style="color:#007f7f">//è®¾ç½®è·¯ç”±
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            )
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> receive1(String messages){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Routeæ¶ˆè´¹è€…1: &#34;</span>+messages);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @RabbitListener(
</span></span><span style="display:flex;"><span>            bindings = @QueueBinding(
</span></span><span style="display:flex;"><span>                    value = @Queue,		<span style="color:#007f7f">//åˆ›å»ºä¸´æ—¶é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    exchange = @Exchange(value = <span style="color:#0ff;font-weight:bold">&#34;route_logs&#34;</span>,type = <span style="color:#0ff;font-weight:bold">&#34;direct&#34;</span>),		<span style="color:#007f7f">//è‡ªå®šä¹‰äº¤æ¢æœºåç§°å’Œç±»å‹ï¼Œå¹¶ç»‘å®šäº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    key = {<span style="color:#0ff;font-weight:bold">&#34;info&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;error&#34;</span>}		<span style="color:#007f7f">//è®¾ç½®è·¯ç”±
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            )
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> receive2(String messages){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Routeæ¶ˆè´¹è€…2: &#34;</span>+messages);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="5topic-1">5ã€topic<a hidden class="anchor" aria-hidden="true" href="#5topic-1">#</a></h3>
<p><strong>ç”Ÿäº§è€…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Autowired
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> RabbitTemplate rabbitTemplate;
</span></span><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> topic(){
</span></span><span style="display:flex;"><span>    String routingKey = <span style="color:#0ff;font-weight:bold">&#34;user.find&#34;</span>;
</span></span><span style="display:flex;"><span>    rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_logs&#34;</span>,routingKey,<span style="color:#0ff;font-weight:bold">&#34;topicå‘é€çš„æ¶ˆæ¯&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>æ¶ˆè´¹è€…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.Exchange;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.Queue;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Consumer_Topic {
</span></span><span style="display:flex;"><span>    @RabbitListener(
</span></span><span style="display:flex;"><span>            bindings = {
</span></span><span style="display:flex;"><span>                    @QueueBinding(
</span></span><span style="display:flex;"><span>                            value = @Queue,		<span style="color:#007f7f">//åˆ›å»ºä¸´æ—¶é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                            exchange = @Exchange(value = <span style="color:#0ff;font-weight:bold">&#34;topic_logs&#34;</span>,type = <span style="color:#0ff;font-weight:bold">&#34;topic&#34;</span>),		<span style="color:#007f7f">//è‡ªå®šä¹‰äº¤æ¢æœºåç§°å’Œç±»å‹ï¼Œå¹¶ç»‘å®šäº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                            key = {<span style="color:#0ff;font-weight:bold">&#34;user.#&#34;</span>}
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> receive1(String messages){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;topicæ¶ˆè´¹è€…1: &#34;</span>+messages);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @RabbitListener(bindings = @QueueBinding(
</span></span><span style="display:flex;"><span>            value = @Queue,		<span style="color:#007f7f">//åˆ›å»ºä¸´æ—¶é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            exchange = @Exchange(value = <span style="color:#0ff;font-weight:bold">&#34;topic_logs&#34;</span>,type = <span style="color:#0ff;font-weight:bold">&#34;topic&#34;</span>),		<span style="color:#007f7f">//è‡ªå®šä¹‰äº¤æ¢æœºåç§°å’Œç±»å‹ï¼Œå¹¶ç»‘å®šäº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            key = {<span style="color:#0ff;font-weight:bold">&#34;user.*&#34;</span>}
</span></span><span style="display:flex;"><span>    ))
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> receive2(String messages){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;topicæ¶ˆè´¹è€…2: &#34;</span>+messages);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="ç”Ÿäº§è€…æ–¹ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœºçš„æ–¹å¼">ç”Ÿäº§è€…æ–¹ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœºçš„æ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#ç”Ÿäº§è€…æ–¹ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœºçš„æ–¹å¼">#</a></h2>
<h3 id="1fanout">1ã€fanout<a hidden class="anchor" aria-hidden="true" href="#1fanout">#</a></h3>
<blockquote>
<h3 id="ç”Ÿäº§è€…æ–¹">ç”Ÿäº§è€…æ–¹<a hidden class="anchor" aria-hidden="true" href="#ç”Ÿäº§è€…æ–¹">#</a></h3>
</blockquote>
<p>åœ¨pom.xmlæ–‡ä»¶å¯¼å…¥Mavenä¾èµ–</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>é…ç½®application.ymlæ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">server</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">8001</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">application</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: rabbitmq_springboot_fanout_provider
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">rabbitmq</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">host</span>: æœåŠ¡å™¨ip
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">5672</span> <span style="color:#007f7f">#rabbitmqç«¯å£å·</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: shishiyi	#ç”¨æˆ·å
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: <span style="color:#ff0;font-weight:bold">123</span>	<span style="color:#007f7f">#å¯†ç </span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">virtual-host</span>: /shishiyi	#è™šæ‹Ÿæœºåç§°
</span></span></code></pre></div><p>ç¼–å†™é…ç½®ç±»</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.core.*;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Bean;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Configuration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ConfigRabbitmqFanout {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//åˆ›å»ºä¸‰ä¸ªé˜Ÿåˆ—åˆ†åˆ«ä¸ºfanoutQueue1ï¼ŒfanoutQueue2ï¼ŒfanoutQueue3
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue fanoutQueue1(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;fanoutQueue1&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue fanoutQueue2(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;fanoutQueue2&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue fanoutQueue3(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;fanoutQueue3&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//åˆ›å»ºfanoutç±»å‹çš„äº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> FanoutExchange fanoutExchange(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ExchangeBuilder.<span style="color:#007f7f">fanoutExchange</span>(<span style="color:#0ff;font-weight:bold">&#34;fanoutExchange&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æŠŠä¸‰ä¸ªé˜Ÿåˆ—åˆ†åˆ«å’Œäº¤æ¢æœºè¿›è¡Œç»‘å®š
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Binding bindingExchange1(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> BindingBuilder.<span style="color:#007f7f">bind</span>(fanoutQueue1()).<span style="color:#007f7f">to</span>(fanoutExchange());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Binding bindingExchange2(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> BindingBuilder.<span style="color:#007f7f">bind</span>(fanoutQueue2()).<span style="color:#007f7f">to</span>(fanoutExchange());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Binding bindingExchange3(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> BindingBuilder.<span style="color:#007f7f">bind</span>(fanoutQueue3()).<span style="color:#007f7f">to</span>(fanoutExchange());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç¼–å†™ç”Ÿäº§è€…çš„æ¥å£ï¼Œå‘é€æ¶ˆæ¯</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.GetMapping;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.RestController;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@RestController
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FanoutController {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> RabbitTemplate rabbitTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @GetMapping(<span style="color:#0ff;font-weight:bold">&#34;/sendFanout&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> sendMessages(){
</span></span><span style="display:flex;"><span>        rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;fanoutExchange&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;fanoutç±»å‹å‘é€çš„æ¶ˆæ¯&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯åŠ¨é¡¹ç›®ï¼Œè°ƒç”¨æ¥å£</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/01/0MNvSe.png" alt="0MNvSe.png"  />
</p>
<p>æ£€æŸ¥rabbitMqç®¡ç†é¡µï¼Œæ¶ˆæ¯å·²ç»å‘é€æˆåŠŸ</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/02/0QWwo8.png" alt="0QWwo8.png"  />
</p>
<blockquote>
<h3 id="æ¶ˆè´¹è€…æ–¹">æ¶ˆè´¹è€…æ–¹<a hidden class="anchor" aria-hidden="true" href="#æ¶ˆè´¹è€…æ–¹">#</a></h3>
</blockquote>
<p>åœ¨pom.xmlæ–‡ä»¶å¯¼å…¥Mavenä¾èµ–</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>é…ç½®application.ymlæ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="font-weight:bold">server</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">7001</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">application</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: rabbitmq_springboot_fanout_consumer
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">rabbitmq</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">host</span>: æœåŠ¡å™¨ip
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">5672</span> <span style="color:#007f7f">#rabbitmqç«¯å£å·</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: shishiyi	#ç”¨æˆ·å
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: <span style="color:#ff0;font-weight:bold">123</span>	<span style="color:#007f7f">#å¯†ç </span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">virtual-host</span>: /shishiyi	#è™šæ‹Ÿæœºåç§°
</span></span></code></pre></div><p>ç¼–å†™ç›‘å¬ç±»</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.core.Message;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FanoutReceiver {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ç›‘å¬å¯¹åº”çš„é˜Ÿåˆ—åç§°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @RabbitListener(queues = <span style="color:#0ff;font-weight:bold">&#34;fanoutQueue1&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> fanout1(Message message){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;fanoutQueue1 æ¶ˆè´¹è€…æ¥å—çš„æ¶ˆæ¯ï¼š&#34;</span>+message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @RabbitListener(queues = <span style="color:#0ff;font-weight:bold">&#34;fanoutQueue2&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> fanout2(Message message){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;fanoutQueue2 æ¶ˆè´¹è€…æ¥å—çš„æ¶ˆæ¯ï¼š&#34;</span>+message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @RabbitListener(queues = <span style="color:#0ff;font-weight:bold">&#34;fanoutQueue3&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> fanout3(Message message){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;fanoutQueue3 æ¶ˆè´¹è€…æ¥å—çš„æ¶ˆæ¯ï¼š&#34;</span>+message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯åŠ¨é¡¹ç›®ï¼ŒæŸ¥çœ‹æ§åˆ¶å°</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/02/0QWSrq.png" alt="0QWSrq.png"  />
</p>
<h3 id="2direct">2ã€direct<a hidden class="anchor" aria-hidden="true" href="#2direct">#</a></h3>
<blockquote>
<h3 id="ç”Ÿäº§è€…æ–¹-1">ç”Ÿäº§è€…æ–¹<a hidden class="anchor" aria-hidden="true" href="#ç”Ÿäº§è€…æ–¹-1">#</a></h3>
</blockquote>
<p>pom.xmlæ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>application.ymlæ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">server</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">8002</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">application</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: rabbitmq_springboot_direct_provider
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">rabbitmq</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">host</span>: æœåŠ¡ip
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">5672</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: shishiyi
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: <span style="color:#ff0;font-weight:bold">123</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">virtual-host</span>: /shishiyi
</span></span></code></pre></div><p>ç¼–å†™é…ç½®ç±»</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.core.*;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Bean;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Configuration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ConfigRabbitmqDirect {
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue directQueue1(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;directQueue1&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue directQueue2(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;directQueue2&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> DirectExchange directExchange(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ExchangeBuilder.<span style="color:#007f7f">directExchange</span>(<span style="color:#0ff;font-weight:bold">&#34;directExchange&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ç»‘å®šå¯¹åº”çš„é˜Ÿåˆ—ï¼Œä»¥åŠè·¯ç”±key
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Binding bindingExchangeQueue1(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> BindingBuilder.<span style="color:#007f7f">bind</span>(directQueue1()).<span style="color:#007f7f">to</span>(directExchange()).<span style="color:#007f7f">with</span>(<span style="color:#0ff;font-weight:bold">&#34;info&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Binding bindingExchangeQueue2(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> BindingBuilder.<span style="color:#007f7f">bind</span>(directQueue2()).<span style="color:#007f7f">to</span>(directExchange()).<span style="color:#007f7f">with</span>(<span style="color:#0ff;font-weight:bold">&#34;error&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç¼–å†™ç”Ÿäº§è€…çš„æ¥å£ï¼Œå‘é€æ¶ˆæ¯</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.GetMapping;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.RestController;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@RestController
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> DirectController {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> RabbitTemplate rabbitTemplate;
</span></span><span style="display:flex;"><span>    @GetMapping(<span style="color:#0ff;font-weight:bold">&#34;/sendDirect&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> sendMessages(){	<span style="color:#007f7f">//è·¯ç”±keyå€¼ä¸ºinfo
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;directExchange&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;info&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;è¿™æ˜¯directç±»å‹,è·¯ç”±ä¸ºinfoçš„æ¶ˆæ¯&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯åŠ¨é¡¹ç›®ï¼Œè°ƒç”¨æ¥å£</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/01/0M0T5q.png" alt="0M0T5q.png"  />
</p>
<p>æŸ¥çœ‹rabbitmqæ§åˆ¶å°ï¼Œç”±äºå‘é€æ¶ˆæ¯æ–¹æ³•æ˜¯å¾€è·¯ç”±keyå€¼ä¸ºinfoé˜Ÿåˆ—å‘é€ï¼Œæ‰€ä»¥åªæœ‰è·¯ç”±keyä¸ºinfoçš„directQueue1é˜Ÿåˆ—å¯ä»¥æ¥æ”¶åˆ°ï¼Œè€Œè·¯ç”±keyå€¼ä¸ºerrorçš„directQueue2é˜Ÿåˆ—æ¥å—ä¸åˆ°æ¶ˆæ¯</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/02/0QfPOI.png" alt="0QfPOI.png"  />
</p>
<blockquote>
<h3 id="æ¶ˆè´¹è€…æ–¹-1">æ¶ˆè´¹è€…æ–¹<a hidden class="anchor" aria-hidden="true" href="#æ¶ˆè´¹è€…æ–¹-1">#</a></h3>
</blockquote>
<p>pom.xmlæ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>application.ymlæ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">server</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">7002</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">application</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: rabbitmq_springboot_direct_consumer
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">rabbitmq</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">host</span>: æœåŠ¡å™¨ip
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">5672</span> <span style="color:#007f7f">#rabbitmqç«¯å£å·</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: shishiyi	#ç”¨æˆ·å
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: <span style="color:#ff0;font-weight:bold">123</span>	<span style="color:#007f7f">#å¯†ç </span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">virtual-host</span>: /shishiyi	#è™šæ‹Ÿæœºåç§°
</span></span></code></pre></div><p>ç¼–å†™ç›‘å¬ç±»</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.core.Message;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> DirectReceiver {
</span></span><span style="display:flex;"><span>    @RabbitListener(queues = <span style="color:#0ff;font-weight:bold">&#34;directQueue1&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> directQueue1(Message message){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;directQueue1 æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š&#34;</span>+message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @RabbitListener(queues = <span style="color:#0ff;font-weight:bold">&#34;directQueue2&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> directQueue2(Message message){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;directQueue2 æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š&#34;</span>+message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯åŠ¨é¡¹ç›®ï¼ŒæŸ¥çœ‹æ§åˆ¶å°ï¼Œç”±äºåªæœ‰directQueue1é‡Œæœ‰æ¶ˆæ¯ï¼Œæ‰€ä»¥æ¶ˆè´¹è€…åªèƒ½çœ‹åˆ°è¿™ä¸ªé˜Ÿåˆ—æ¶ˆæ¯</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/02/0Qf6hD.png" alt="0Qf6hD.png"  />
</p>
<h3 id="3topic">3ã€topic<a hidden class="anchor" aria-hidden="true" href="#3topic">#</a></h3>
<blockquote>
<h3 id="ç”Ÿäº§è€…">ç”Ÿäº§è€…<a hidden class="anchor" aria-hidden="true" href="#ç”Ÿäº§è€…">#</a></h3>
</blockquote>
<p>ç¼–å†™pom.xmlæ–‡ä»¶ï¼Œå¯¼å…¥Mavenä¾èµ–</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>é…ç½®æ–‡ä»¶application.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">server</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">8003</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">application</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: rabbitmq_springboot_topic_provider
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">rabbitmq</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">host</span>: æœåŠ¡å™¨ip
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">5672</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: shishiyi	#ç”¨æˆ·å
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: <span style="color:#ff0;font-weight:bold">123</span>		<span style="color:#007f7f">#å¯†ç </span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">virtual-host</span>: /shishiyi		#è™šæ‹Ÿæœºåç§°
</span></span></code></pre></div><p>ç¼–å†™é…ç½®ç±»</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.core.*;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Bean;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Configuration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ConfigRabbitmqTopic {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue topicQueue1(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;topicQueue1&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue topicQueue2(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;topicQueue2&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue topicQueue3(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;topicQueue3&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> TopicExchange topicExchange(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ExchangeBuilder.<span style="color:#007f7f">topicExchange</span>(<span style="color:#0ff;font-weight:bold">&#34;topicExchange&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœºï¼Œä»¥åŠç»‘å®šäº†ä¸åŒçš„è·¯ç”±keyå€¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Binding bindingExchangeQueue1(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> BindingBuilder.<span style="color:#007f7f">bind</span>(topicQueue1()).<span style="color:#007f7f">to</span>(topicExchange()).<span style="color:#007f7f">with</span>(<span style="color:#0ff;font-weight:bold">&#34;user.#&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Binding bindingExchangeQueue2(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> BindingBuilder.<span style="color:#007f7f">bind</span>(topicQueue2()).<span style="color:#007f7f">to</span>(topicExchange()).<span style="color:#007f7f">with</span>(<span style="color:#0ff;font-weight:bold">&#34;user.save&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Binding bindingExchangeQueue3(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> BindingBuilder.<span style="color:#007f7f">bind</span>(topicQueue2()).<span style="color:#007f7f">to</span>(topicExchange()).<span style="color:#007f7f">with</span>(<span style="color:#0ff;font-weight:bold">&#34;user&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç¼–å†™æ¥å£</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.GetMapping;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.RestController;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@RestController
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TopicController {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> RabbitTemplate rabbitTemplate;
</span></span><span style="display:flex;"><span>    @GetMapping(<span style="color:#0ff;font-weight:bold">&#34;/sendTopic&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> sendMessage(){  <span style="color:#007f7f">//è·¯ç”±keyä¸ºuser.save
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;topicExchange&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;user.save&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;è¿™æ˜¯topicç±»å‹ï¼Œè·¯ç”±ä¸ºuser.saveçš„æ¶ˆæ¯&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯åŠ¨é¡¹ç›®ï¼Œè°ƒç”¨æ¥å£</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/02/0QgpqK.png" alt="0QgpqK.png"  />
</p>
<p>æŸ¥çœ‹rabbitmqæ§åˆ¶å°ï¼Œç”±äºå‘é€æ¶ˆæ¯çš„æ–¹æ³• è·¯ç”±keyå€¼ä¸ºuser.saveï¼Œæ‰€ä»¥åªæœ‰è·¯ç”±keyä¸ºuser.#çš„topicQueue1çš„é˜Ÿåˆ—å’Œè·¯ç”±keyå€¼ä¸ºuser.saveçš„topicQueue2é˜Ÿåˆ—å¯ä»¥æ”¶åˆ°æ¶ˆæ¯ï¼Œè€Œè·¯ç”±keyå€¼ä¸ºuserçš„topicQueue3é˜Ÿåˆ—åˆ™æ”¶ä¸åˆ°æ¶ˆæ¯</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/02/0Qfq3Q.png" alt="0Qfq3Q.png"  />
</p>
<blockquote>
<h3 id="æ¶ˆè´¹è€…æ–¹-2">æ¶ˆè´¹è€…æ–¹<a hidden class="anchor" aria-hidden="true" href="#æ¶ˆè´¹è€…æ–¹-2">#</a></h3>
</blockquote>
<p>pom.xmlæ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>application.ymlæ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">server</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">7003</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">application</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: rabbitmq_springboot_topic_consumer
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">rabbitmq</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">host</span>: æœåŠ¡å™¨ip
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">5672</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: shishiyi
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: <span style="color:#ff0;font-weight:bold">123</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">virtual-host</span>: /shishiyi
</span></span></code></pre></div><p>ç¼–å†™ç›‘å¬ç±»ï¼Œè·å–æ¶ˆæ¯</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.core.Message;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TopicReceiver {
</span></span><span style="display:flex;"><span>    @RabbitListener(queues = <span style="color:#0ff;font-weight:bold">&#34;topicQueue1&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> topicQueue1(Message message){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;topicQueue1 æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š&#34;</span>+message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @RabbitListener(queues = <span style="color:#0ff;font-weight:bold">&#34;topicQueue2&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> topicQueue2(Message message){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;topicQueue2 æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š&#34;</span>+message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @RabbitListener(queues = <span style="color:#0ff;font-weight:bold">&#34;topicQueue3&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> topicQueue3(Message message){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;topicQueue3 æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š&#34;</span>+message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯åŠ¨é¡¹ç›®ï¼Œåœ¨æ§åˆ¶å°æŸ¥çœ‹æ‰“å°ä¿¡æ¯ï¼Œç”±äºåªæœ‰é˜Ÿåˆ—topicQueue1ï¼ŒtopicQueue2é‡Œæœ‰æ¶ˆæ¯ï¼Œæ‰€ä»¥æ¶ˆè´¹è€…åªèƒ½çœ‹åˆ°è¿™ä¸¤ä¸ªé˜Ÿåˆ—æ¶ˆæ¯</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/02/0Q2q39.png" alt="0Q2q39.png"  />
</p>
<h1 id="rabbitmqçš„é«˜çº§ç‰¹æ€§">RabbitMQçš„é«˜çº§ç‰¹æ€§<a hidden class="anchor" aria-hidden="true" href="#rabbitmqçš„é«˜çº§ç‰¹æ€§">#</a></h1>
<h2 id="ç”Ÿäº§è€…æ–¹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶">ç”Ÿäº§è€…æ–¹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶<a hidden class="anchor" aria-hidden="true" href="#ç”Ÿäº§è€…æ–¹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶">#</a></h2>
<p>åœ¨ä½¿ç”¨RabbitMQçš„æ—¶å€™ï¼Œä½œä¸ºæ¶ˆæ¯å‘é€æ–¹å¸Œæœ›æœç»ä»»ä½•æ¶ˆæ¯ä¸¢å¤±æˆ–è€…æŠ•é€’å¤±è´¥åœºæ™¯ã€‚RabbitMQ ä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ç§æ–¹å¼ç”¨æ¥æ§åˆ¶æ¶ˆæ¯çš„æŠ•é€’å¯é æ€§æ¨¡å¼ã€‚</p>
<ul>
<li>confirm ç¡®è®¤æ¨¡å¼</li>
<li>return é€€å›æ¨¡å¼</li>
</ul>
<p>RabbitMQå¤§ä½“æµç¨‹è·¯å¾„ï¼š</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/02/0lGgvd.png" alt="0lGgvd.png"  />
</p>
<ul>
<li>
<p>æ¶ˆæ¯ä»æ¶ˆè´¹è€…(Producer) åˆ° äº¤æ¢æœº(exchange) åˆ™ä¼šè°ƒç”¨ä¸€ä¸ªå›è°ƒæ–¹æ³•setConfirmCallback()</p>
<p>â€‹	æ–¹æ³•å‚æ•°ï¼š <strong>correlationData ç›¸å…³ä¿¡æ¯ã€ack æ˜¯å¦å‘é€æˆåŠŸã€cause å¤±è´¥åŸå› </strong></p>
</li>
<li>
<p>æ¶ˆæ¯ä»äº¤æ¢æœº(exchange)åˆ° é˜Ÿåˆ—(queue) åˆ™ä¼šè°ƒç”¨ä¸€ä¸ªå›è°ƒæ–¹æ³•setReturnCallback()</p>
<p>â€‹	æ–¹æ³•å‚æ•°ï¼š <strong>messageæ¶ˆæ¯å†…å®¹ã€ replyCodeå›åº”ç ã€replyTextå›åº”æ¶ˆæ¯ã€exchangeäº¤æ¢æœºã€routingKeyè·¯ç”±keyå€¼</strong></p>
</li>
</ul>
<p>ç¼–å†™é…ç½®æ–‡ä»¶application.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">server</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">8004</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">application</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: rabbitmq_springboot_provider
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">rabbitmq</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">host</span>: æœåŠ¡å™¨ip
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">5672</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: shishiyi
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: <span style="color:#ff0;font-weight:bold">123</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">virtual-host</span>: /shishiyi
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#æ¶ˆæ¯ç¡®è®¤é…ç½®é¡¹</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#ç¡®è®¤æ¶ˆæ¯å·²å‘é€åˆ°äº¤æ¢æœº(Exchange)</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">publisher-confirm-type</span>: correlated
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#ç¡®è®¤æ¶ˆæ¯å·²å‘é€åˆ°é˜Ÿåˆ—(Queue)</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">publisher-returns</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span></code></pre></div><p>ç¼–å†™é…ç½®ç±»</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.core.*;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.connection.ConnectionFactory;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Bean;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Configuration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> RabbitmqConfig {
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> RabbitTemplate createRabbitTemplate(ConnectionFactory connectionFactory){
</span></span><span style="display:flex;"><span>        RabbitTemplate rabbitTemplate = <span style="color:#fff;font-weight:bold">new</span> RabbitTemplate();
</span></span><span style="display:flex;"><span>        rabbitTemplate.<span style="color:#007f7f">setConnectionFactory</span>(connectionFactory);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         * ä»æ¶ˆè´¹è€…(Producer) åˆ° äº¤æ¢æœº(exchange) åˆ™ä¼šè¢«è°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         */</span>
</span></span><span style="display:flex;"><span>        rabbitTemplate.<span style="color:#007f7f">setConfirmCallback</span>((correlationData, ack, cause) -&gt; {
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;ConfirmCallback ç›¸å…³æ•°æ®: &#34;</span>+correlationData);
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;ConfirmCallback ç¡®è®¤æƒ…å†µ: &#34;</span>+ack);
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;ConfirmCallback åŸå› : &#34;</span>+cause);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½®å¼€å¯Mandatory,æ‰èƒ½è§¦å‘å›è°ƒå‡½æ•°,æ— è®ºæ¶ˆæ¯æ¨é€ç»“æœæ€ä¹ˆæ ·éƒ½å¼ºåˆ¶è°ƒç”¨å›è°ƒå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        rabbitTemplate.<span style="color:#007f7f">setMandatory</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         * ä»äº¤æ¢æœº(exchange)åˆ° é˜Ÿåˆ—(queue) åˆ™ä¼šè¢«è°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         */</span>
</span></span><span style="display:flex;"><span>        rabbitTemplate.<span style="color:#007f7f">setReturnCallback</span>((message, replyCode, replyText, exchange, routingKey) -&gt; {
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;ReturnCallback æ¶ˆæ¯å†…å®¹: &#34;</span>+message);
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;ReturnCallback å›åº”ç : &#34;</span>+replyCode);
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;ReturnCallback å›åº”æ¶ˆæ¯: &#34;</span>+replyText);
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;ReturnCallback äº¤æ¢æœº: &#34;</span>+exchange);
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;ReturnCallback è·¯ç”±keyå€¼: &#34;</span>+routingKey);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> rabbitTemplate;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue queue(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_queue&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> TopicExchange topicExchange(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ExchangeBuilder.<span style="color:#007f7f">topicExchange</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Binding binding(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> BindingBuilder.<span style="color:#007f7f">bind</span>(queue()).<span style="color:#007f7f">to</span>(topicExchange()).<span style="color:#007f7f">with</span>(<span style="color:#0ff;font-weight:bold">&#34;yes.#&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç¼–å†™æ¥å£</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.GetMapping;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.RestController;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@RestController
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TopicController {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> RabbitTemplate rabbitTemplate;
</span></span><span style="display:flex;"><span>    @GetMapping(<span style="color:#0ff;font-weight:bold">&#34;/send&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> sendMessage(){
</span></span><span style="display:flex;"><span>        rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;yes&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;å‘å¸ƒäº†ä¸€æ¡æ¶ˆæ¯&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯åŠ¨æµ‹è¯•ï¼ŒæŸ¥çœ‹æ§åˆ¶å°ä¿¡æ¯</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/02/0lZ1AA.png" alt="0lZ1AA.png"  />
</p>
<p>æ ¹æ®RabbitMQå¤§ä½“æµç¨‹è·¯å¾„ï¼Œä»ç”Ÿäº§è€…è§’åº¦ï¼Œåšå¦‚ä¸‹æµ‹è¯•ï¼š</p>
<p>1ã€å¦‚æœå‘é€çš„äº¤æ¢æœºæ²¡æœ‰è¿›è¡Œé…ç½®ï¼Œå³ä¸å­˜åœ¨</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//äº¤æ¢æœºä¸ºexchange1111ï¼Œæ²¡æœ‰è¿›è¡Œé…ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>@GetMapping(<span style="color:#0ff;font-weight:bold">&#34;/send&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> sendMessage(){
</span></span><span style="display:flex;"><span>    rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;exchange1111&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;yes&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;å‘å¸ƒäº†ä¸€æ¡æ¶ˆæ¯&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯åŠ¨æµ‹è¯•ï¼Œè°ƒç”¨æ¥å£ï¼ŒæŸ¥çœ‹æ§åˆ¶å°</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ConfirmCallback ç›¸å…³æ•°æ®: <span style="color:#fff;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>ConfirmCallback ç¡®è®¤æƒ…å†µ: <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>ConfirmCallback åŸå› : channel error; protocol method: <span style="color:#f00">#</span>method&lt;channel.<span style="color:#007f7f">close</span>&gt;(reply-code=404, reply-text=NOT_FOUND - no exchange <span style="color:#f00">&#39;</span>exchange1111<span style="color:#f00">&#39;</span> in vhost <span style="color:#f00">&#39;</span>/shishiyi<span style="color:#f00">&#39;</span>, class-id=60, method-id=40)
</span></span></code></pre></div><p>2ã€å¦‚æœäº¤æ¢æœºé…ç½®äº†ï¼Œä½†æ˜¯æ²¡æœ‰ç»‘å®šé˜Ÿåˆ—</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//é…ç½®äº¤æ¢æœºï¼Œä½†ä¸ç»‘å®šé˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>@Bean
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> TopicExchange exchange2(){
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> ExchangeBuilder.<span style="color:#007f7f">topicExchange</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange_test&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//ç»™æ²¡æœ‰ç»‘å®šçš„äº¤æ¢æœºå‘é€æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>@GetMapping(<span style="color:#0ff;font-weight:bold">&#34;/send&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> sendMessage(){
</span></span><span style="display:flex;"><span>    rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange_test&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;yes&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;å‘å¸ƒäº†ä¸€æ¡æ¶ˆæ¯&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯åŠ¨æµ‹è¯•ï¼Œè°ƒç”¨æ¥å£ï¼ŒæŸ¥çœ‹æ§åˆ¶å°</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ReturnCallback æ¶ˆæ¯å†…å®¹: (Body:<span style="color:#f00">&#39;</span>å‘å¸ƒäº†ä¸€æ¡æ¶ˆæ¯<span style="color:#f00">&#39;</span> MessageProperties [headers={}, contentType=text/plain, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, deliveryTag=0])
</span></span><span style="display:flex;"><span>ReturnCallback å›åº”ç : 312
</span></span><span style="display:flex;"><span>ReturnCallback å›åº”æ¶ˆæ¯: NO_ROUTE
</span></span><span style="display:flex;"><span>ReturnCallback äº¤æ¢æœº: topic_exchange_test
</span></span><span style="display:flex;"><span>ReturnCallback è·¯ç”±keyå€¼: yes
</span></span><span style="display:flex;"><span>ConfirmCallback ç›¸å…³æ•°æ®: <span style="color:#fff;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>ConfirmCallback ç¡®è®¤æƒ…å†µ: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>ConfirmCallback åŸå› : <span style="color:#fff;font-weight:bold">null</span>
</span></span></code></pre></div><h2 id="æ¶ˆè´¹è€…æ–¹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶">æ¶ˆè´¹è€…æ–¹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶<a hidden class="anchor" aria-hidden="true" href="#æ¶ˆè´¹è€…æ–¹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶">#</a></h2>
<p>è¿™é‡Œæ˜¯æŠŠæ¶ˆæ¯çš„è‡ªåŠ¨ç¡®è®¤æœºåˆ¶ï¼Œæ”¹ä¸ºæ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯ï¼Œå³æŠŠ <strong>AcknowledgeMode.NONE</strong> æ”¹ä¸º  <strong>AcknowledgeMode.MANUAL</strong></p>
<p>é…ç½®æ–‡ä»¶application.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">server</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">7004</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">application</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: rabbitmq_springboot_consumer
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">rabbitmq</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">host</span>: æœåŠ¡å™¨ip
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">5672</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: shishiyi
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: <span style="color:#ff0;font-weight:bold">123</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">virtual-host</span>: /shishiyi
</span></span></code></pre></div><p>ç¼–å†™å¼€å¯æ‰‹åŠ¨ç¡®è®¤ï¼Œä»¥åŠè‡ªå®šä¹‰ç›‘å¬ç±»</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.shishiyi.listener.AckListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.core.AcknowledgeMode;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.connection.ConnectionFactory;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Bean;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Configuration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MessageListenerConfig {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> AckListener ackListener;
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> ConnectionFactory connectionFactory;
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> SimpleMessageListenerContainer simpleMessageListenerContainer(){
</span></span><span style="display:flex;"><span>        SimpleMessageListenerContainer simpleMessageListenerContainer = <span style="color:#fff;font-weight:bold">new</span> SimpleMessageListenerContainer(connectionFactory);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ¶ˆè´¹è€…æ”¹ä¸ºæ‰‹åŠ¨ç¡®è®¤ï¼Œé»˜è®¤ä¸ºè‡ªåŠ¨ç¡®è®¤
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        simpleMessageListenerContainer.<span style="color:#007f7f">setAcknowledgeMode</span>(AcknowledgeMode.<span style="color:#007f7f">MANUAL</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½®é˜Ÿåˆ—ï¼Œå‚æ•°å¯ä»¥è®¾ç½®å¤šä¸ªé˜Ÿåˆ—åç§°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        simpleMessageListenerContainer.<span style="color:#007f7f">setQueueNames</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_queue&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½®è‡ªå®šä¹‰çš„ç›‘å¬ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        simpleMessageListenerContainer.<span style="color:#007f7f">setMessageListener</span>(ackListener);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> simpleMessageListenerContainer;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.rabbitmq.client.Channel;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.core.Message;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.listener.api.ChannelAwareMessageListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AckListener <span style="color:#fff;font-weight:bold">implements</span> ChannelAwareMessageListener {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> onMessage(Message message, Channel channel) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">long</span> deliveryTag = message.<span style="color:#007f7f">getMessageProperties</span>().<span style="color:#007f7f">getDeliveryTag</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//åˆ¤æ–­é˜Ÿåˆ—ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒé˜Ÿåˆ—ï¼Œæ¥æ‰§è¡Œä¸åŒçš„ä¸šåŠ¡å†…å®¹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#0ff;font-weight:bold">&#34;topic_queue&#34;</span>.<span style="color:#007f7f">equals</span>(message.<span style="color:#007f7f">getMessageProperties</span>().<span style="color:#007f7f">getConsumerQueue</span>())){
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//è½¬æ¢æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#fff;font-weight:bold">new</span> String(message.<span style="color:#007f7f">getBody</span>()));
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//å¤„ç†ä¸šåŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;å¤„ç†ä¸šåŠ¡.........&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æ‰‹åŠ¨ç¡®è®¤ï¼Œç­¾æ”¶æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            channel.<span style="color:#007f7f">basicAck</span>(deliveryTag,<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">             *  é’ˆå¯¹å¤šä¸ªæ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">             *  ç¬¬äºŒä¸ªå‚æ•°æ˜¯å¦åº”ç”¨äºå¤šæ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">             *  ç¬¬ä¸‰ä¸ªå‚æ•°requeueï¼šæ˜¯å¦é‡å›é˜Ÿåˆ—ï¼Œå¦‚æœæ˜¯true,åˆ™é‡æ–°å›åˆ°é˜Ÿåˆ—ï¼Œç„¶åé‡æ–°å‘ç»™æ¶ˆè´¹è€…ï¼Œå¦è€…åˆ™ä¸¢å¼ƒæˆ–è€…è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">             */</span>
</span></span><span style="display:flex;"><span>            channel.<span style="color:#007f7f">basicNack</span>(deliveryTag,<span style="color:#fff;font-weight:bold">true</span>,<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//é’ˆå¯¹å•ä¸ªæ¶ˆæ¯ï¼Œç¬¬äºŒä¸ªå‚æ•°requeueï¼šæ˜¯å¦é‡å›é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">//channel.basicReject(deliveryTag,true);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¦‚æœæ‰§è¡Œä¸šåŠ¡å‡ºé”™ï¼Œåˆ™å¯ä»¥æ‹’ç»æ¶ˆæ¯ï¼Œå¯¹æ­¤æ–¹æ³•æœ‰<strong>channel.basicReject(deliveryTag, true)</strong>  å’Œ  <strong>channel.basicNack(deliveryTag, false, true)</strong>  ä¸¤ç§æ–¹å¼å¤„ç†</p>
<p><strong>channel.basicReject(deliveryTag, true)ï¼š</strong>   æ‹’ç»æ¶ˆè´¹å½“å‰æ¶ˆæ¯ï¼Œå¦‚æœç¬¬äºŒå‚æ•°ä¼ å…¥trueï¼Œå°±æ˜¯å°†æ•°æ®é‡æ–°ä¸¢å›é˜Ÿåˆ—é‡Œï¼Œé‚£ä¹ˆä¸‹æ¬¡è¿˜ä¼šæ¶ˆè´¹è¿™æ¶ˆæ¯ã€‚è®¾ç½®falseï¼Œ</p>
<p>å°±æ˜¯å‘Šè¯‰æœåŠ¡å™¨ï¼Œæˆ‘å·²ç»çŸ¥é“è¿™æ¡æ¶ˆæ¯æ•°æ®äº†ï¼Œå› ä¸ºä¸€äº›åŸå› æ‹’ç»å®ƒï¼Œè€Œä¸”æœåŠ¡å™¨ä¹ŸæŠŠè¿™ä¸ªæ¶ˆæ¯ä¸¢æ‰å°±è¡Œã€‚ ä¸‹æ¬¡ä¸æƒ³å†æ¶ˆè´¹è¿™æ¡æ¶ˆæ¯äº†ã€‚ä½¿ç”¨æ‹’ç»åé‡æ–°å…¥åˆ—è¿™</p>
<p>ä¸ªç¡®è®¤æ¨¡å¼è¦è°¨æ…ï¼Œå› ä¸ºä¸€èˆ¬éƒ½æ˜¯å‡ºç°å¼‚å¸¸çš„æ—¶å€™ï¼Œcatchå¼‚å¸¸å†æ‹’ç»å…¥åˆ—ï¼Œé€‰æ‹©æ˜¯å¦é‡å…¥åˆ—ã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨ä¸å½“ä¼šå¯¼è‡´ä¸€äº›æ¯æ¬¡éƒ½è¢«ä½ é‡å…¥åˆ—çš„æ¶ˆæ¯ä¸€ç›´æ¶ˆè´¹-å…¥</p>
<p>åˆ—-æ¶ˆè´¹-å…¥åˆ—è¿™æ ·å¾ªç¯ï¼Œä¼šå¯¼è‡´æ¶ˆæ¯ç§¯å‹ã€‚</p>
<p><strong>channel.basicNack(deliveryTag, false, true)ï¼š</strong>  ç¬¬ä¸€ä¸ªå‚æ•°ä¾ç„¶æ˜¯å½“å‰æ¶ˆæ¯åˆ°çš„æ•°æ®çš„å”¯ä¸€idï¼›</p>
<p>ç¬¬äºŒä¸ªå‚æ•°æ˜¯æŒ‡æ˜¯å¦é’ˆå¯¹å¤šæ¡æ¶ˆæ¯ï¼›å¦‚æœæ˜¯trueï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€æ¬¡æ€§é’ˆå¯¹å½“å‰é€šé“çš„æ¶ˆæ¯çš„tagIDå°äºå½“å‰è¿™æ¡æ¶ˆæ¯çš„ï¼Œéƒ½æ‹’ç»ç¡®è®¤ã€‚</p>
<p>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æŒ‡æ˜¯å¦é‡æ–°å…¥åˆ—ï¼Œä¹Ÿå°±æ˜¯æŒ‡ä¸ç¡®è®¤çš„æ¶ˆæ¯æ˜¯å¦é‡æ–°ä¸¢å›åˆ°é˜Ÿåˆ—é‡Œé¢å»ã€‚</p>
<p>åŒæ ·ä½¿ç”¨ä¸ç¡®è®¤åé‡æ–°å…¥åˆ—è¿™ä¸ªç¡®è®¤æ¨¡å¼è¦è°¨æ…ï¼Œå› ä¸ºè¿™é‡Œä¹Ÿå¯èƒ½å› ä¸ºè€ƒè™‘ä¸å‘¨å‡ºç°æ¶ˆæ¯ä¸€ç›´è¢«é‡æ–°ä¸¢å›å»çš„æƒ…å†µï¼Œå¯¼è‡´ç§¯å‹ã€‚</p>
<h2 id="æ¶ˆè´¹ç«¯é™æµ">æ¶ˆè´¹ç«¯é™æµ<a hidden class="anchor" aria-hidden="true" href="#æ¶ˆè´¹ç«¯é™æµ">#</a></h2>
<p>ä¸ºé˜²æ­¢å¤§é‡æ¶ˆæ¯å…¨éƒ¨ç»™åˆ°æ¶ˆè´¹ç«¯ç³»ç»Ÿï¼Œå¯ä»¥å¯¹æ¶ˆè´¹ç«¯åšä¸€ä¸ªé™æµæ“ä½œ</p>
<p>å¼€å¯æ–¹å¼çš„å‰æä¸€å®šæ˜¯æ¶ˆè´¹ç«¯æ”¹ä¸ºæ‰‹åŠ¨ç¡®è®¤ä¿¡æ¯ï¼Œå¦åˆ™å°±ä¸æˆåŠŸ</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SimpleMessageListenerContainer simpleMessageListenerContainer = <span style="color:#fff;font-weight:bold">new</span> SimpleMessageListenerContainer(connectionFactory);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ¶ˆè´¹è€…æ”¹ä¸ºæ‰‹åŠ¨ç¡®è®¤ï¼Œé»˜è®¤ä¸ºè‡ªåŠ¨ç¡®è®¤
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>simpleMessageListenerContainer.<span style="color:#007f7f">setAcknowledgeMode</span>(AcknowledgeMode.<span style="color:#007f7f">MANUAL</span>);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//å¯¹æ¶ˆè´¹ç«¯è¿›è¡Œä¸€ä¸ªé™æµè®¾ç½®ï¼Œä¸€æ¬¡å…è®¸å¤šå°‘æ¶ˆæ¯è¿›å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>simpleMessageListenerContainer.<span style="color:#007f7f">setPrefetchCount</span>(1);
</span></span></code></pre></div><h2 id="ttlæ¶ˆæ¯è¿‡æœŸæ—¶é—´">TTLï¼šæ¶ˆæ¯è¿‡æœŸæ—¶é—´<a hidden class="anchor" aria-hidden="true" href="#ttlæ¶ˆæ¯è¿‡æœŸæ—¶é—´">#</a></h2>
<h3 id="1é˜Ÿåˆ—å†…æ¶ˆæ¯ç»Ÿä¸€è¿‡æœŸ">1ã€é˜Ÿåˆ—å†…æ¶ˆæ¯ç»Ÿä¸€è¿‡æœŸ<a hidden class="anchor" aria-hidden="true" href="#1é˜Ÿåˆ—å†…æ¶ˆæ¯ç»Ÿä¸€è¿‡æœŸ">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Bean
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Queue queue(){	<span style="color:#007f7f">//åªéœ€è¦åœ¨é…ç½®é˜Ÿåˆ—æ—¶ï¼Œè®¾ç½®ä¸€ä¸‹ttl(int ttl)æ–¹æ³•ï¼Œå‚æ•°ä¸ºå¤šå°‘æ¯«ç§’åæ¶ˆæ¯è¿‡æœŸ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_queue&#34;</span>).<span style="color:#007f7f">ttl</span>(5000).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img loading="lazy" src="https://s1.ax1x.com/2020/10/03/03gCtO.png" alt="03gCtO.png"  />
</p>
<h3 id="2æ¶ˆæ¯å•ç‹¬è¿‡æœŸ">2ã€æ¶ˆæ¯å•ç‹¬è¿‡æœŸ<a hidden class="anchor" aria-hidden="true" href="#2æ¶ˆæ¯å•ç‹¬è¿‡æœŸ">#</a></h3>
<p><strong>å•ç‹¬ä¸ºæŸæ¡æ¶ˆæ¯è®¾ç½®è¿‡æœŸå±æ€§ï¼Œå¯ä»¥é€šè¿‡å‘å¸ƒæ¶ˆæ¯çš„convertAndSend()é‡è½½æ–¹æ³•ä¸­ï¼ŒMessagePostProcessoræ¶ˆæ¯å‘å¸ƒå¤„ç†å™¨æ¥è®¾ç½®è¿‡æœŸå±æ€§</strong></p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/03/03gO58.png" alt="03gO58.png"  />
</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/03/0328PO.png" alt="0328PO.png"  />
</p>
<p><strong>é€šè¿‡æºç å¯ä»¥å‘ç°ï¼ŒMessagePostProcessoræ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œè€Œæ¥å£çš„æ–¹æ³•æœ‰ä¸€ä¸ªMessageç±»å‹çš„å‚æ•°ï¼Œä»¥æ­¤ä¾¿å¯ä»¥è®¾ç½®æ¶ˆæ¯å±æ€§äº†</strong></p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/03/032Xe1.png" alt="032Xe1.png"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//å‘å¸ƒæ¶ˆæ¯æ—¶ï¼Œå•ç‹¬è®¾ç½®ä¸€ä¸‹æ¶ˆæ¯è¿‡æœŸæ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> sendMessage(){
</span></span><span style="display:flex;"><span>    rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;yes&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;å‘å¸ƒäº†ä¸€æ¡æ¶ˆæ¯&#34;</span>,message -&gt; {
</span></span><span style="display:flex;"><span>        message.<span style="color:#007f7f">getMessageProperties</span>().<span style="color:#007f7f">setExpiration</span>(<span style="color:#0ff;font-weight:bold">&#34;5000&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> message;
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>ä¸è¿‡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“é˜Ÿåˆ—ä¸­æœ‰å¤šæ¡æ¶ˆæ¯ï¼Œæœ‰è¿‡æœŸæ—¶é—´çš„æ¶ˆæ¯ä¸ä¼šåœ¨è¾¾åˆ°æ—¶é—´åä»é˜Ÿåˆ—ä¸­è‡ªåŠ¨æ¶ˆå¤±ï¼Œè€Œæ˜¯åªæœ‰æ¶ˆæ¯åœ¨é˜Ÿåˆ—é¡¶ç«¯æ—¶ï¼Œæ‰ä¼šåˆ¤æ–­å…¶å¦è¿‡æœŸäº†</strong></p>
<p><strong>è€Œå¦‚æœåŒæ—¶è®¾ç½®é˜Ÿåˆ—è¿‡æœŸæ—¶é—´å’Œæ¶ˆæ¯è¿‡æœŸæ—¶é—´ï¼Œåˆ™ä»¥æ—¶é—´çŸ­çš„ä¸ºå‡†</strong></p>
<h2 id="æ­»ä¿¡é˜Ÿåˆ—">æ­»ä¿¡é˜Ÿåˆ—<a hidden class="anchor" aria-hidden="true" href="#æ­»ä¿¡é˜Ÿåˆ—">#</a></h2>
<p>Rabbitmqçš„æ­»ä¿¡é˜Ÿåˆ—ï¼Œå…¶å®æŒ‡çš„æ­»ä¿¡äº¤æ¢æœº(DLX)ï¼Œä½†è™½ç„¶åç§°æ˜¯è¿™ä¹ˆä¸€ä¸ªå«æ³•ï¼Œä½†æ˜¯æ­»ä¿¡äº¤æ¢æœºä¹Ÿæ˜¯ä¸€ä¸ªæ­£å¸¸çš„äº¤æ¢æœºï¼Œå’Œä¸€èˆ¬çš„äº¤æ¢æœºæ˜¯æ²¡æœ‰åŒºåˆ«çš„</p>
<p>è€Œè¿›å…¥æ­»ä¿¡äº¤æ¢æœºçš„æ¶ˆæ¯ï¼Œå¤§è‡´æœ‰ä¸‰ç§æƒ…å†µï¼š</p>
<h3 id="1æ¶ˆæ¯ttlè¿‡æœŸ">1ã€æ¶ˆæ¯TTLè¿‡æœŸ<a hidden class="anchor" aria-hidden="true" href="#1æ¶ˆæ¯ttlè¿‡æœŸ">#</a></h3>
<p>ç”Ÿäº§æ–¹çš„é…ç½®ç±»</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.core.*;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Bean;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Configuration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> RabbitmqConfig {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å£°æ˜æ­£å¸¸é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue queue(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_queue&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//æ­£å¸¸é˜Ÿåˆ—å’Œæ­»ä¿¡äº¤æ¢æœºç»‘å®š
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">deadLetterExchange</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange_dlx&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//å’Œæ­»ä¿¡äº¤æ¢æœºçš„è·¯ç”±keyç»‘å®šï¼Œå‘ç»™å“ªä¸ªæ­»ä¿¡é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">deadLetterRoutingKey</span>(<span style="color:#0ff;font-weight:bold">&#34;no.msg&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//è®¾ç½®é˜Ÿåˆ—è¿‡æœŸæ—¶é—´ï¼Œ3ç§’åè¿‡æœŸ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">ttl</span>(3000)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å£°æ˜æ­£å¸¸äº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> TopicExchange exchange(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ExchangeBuilder.<span style="color:#007f7f">topicExchange</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ­£å¸¸çš„é˜Ÿåˆ—å’Œäº¤æ¢æœºè¿›è¡Œç»‘å®š
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Binding binding(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> BindingBuilder.<span style="color:#007f7f">bind</span>(queue()).<span style="color:#007f7f">to</span>(exchange()).<span style="color:#007f7f">with</span>(<span style="color:#0ff;font-weight:bold">&#34;yes.#&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å£°æ˜æ­»ä¿¡é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue queue_dlx(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_queue_dlx&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å£°æ˜æ­»ä¿¡äº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> TopicExchange exchange_dlx(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ExchangeBuilder.<span style="color:#007f7f">topicExchange</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange_dlx&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ­»ä¿¡çš„é˜Ÿåˆ—å’Œäº¤æ¢æœºè¿›è¡Œç»‘å®š
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Binding binding_dlx(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> BindingBuilder.<span style="color:#007f7f">bind</span>(queue_dlx()).<span style="color:#007f7f">to</span>(exchange_dlx()).<span style="color:#007f7f">with</span>(<span style="color:#0ff;font-weight:bold">&#34;no.#&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç¼–å†™æ¥å£</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.GetMapping;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.RestController;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@RestController
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TopicController {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> RabbitTemplate rabbitTemplate;
</span></span><span style="display:flex;"><span>    @GetMapping(<span style="color:#0ff;font-weight:bold">&#34;/send&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> sendMessage(){
</span></span><span style="display:flex;"><span>        rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;yes.msg&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;å‘å¸ƒäº†ä¸€æ¡æ¶ˆæ¯&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯åŠ¨æµ‹è¯•ï¼Œè°ƒç”¨æ¥å£å‘é€æ¶ˆæ¯ï¼Œä¸æ¶ˆè´¹æ¶ˆæ¯ï¼Œ3ç§’åæŸ¥çœ‹rabbitmqç®¡ç†é¡µé¢ï¼Œæ¶ˆæ¯å·²è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/03/03TblV.png" alt="03TblV.png"  />
</p>
<h3 id="2é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦">2ã€é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦<a hidden class="anchor" aria-hidden="true" href="#2é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦">#</a></h3>
<p>ç”Ÿäº§æ–¹çš„é…ç½®ç±»</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.core.*;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Bean;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Configuration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> RabbitmqConfig {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å£°æ˜æ­£å¸¸é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue queue(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_queue&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//æ­£å¸¸é˜Ÿåˆ—å’Œæ­»ä¿¡äº¤æ¢æœºç»‘å®š
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">deadLetterExchange</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange_dlx&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//å’Œæ­»ä¿¡äº¤æ¢æœºçš„è·¯ç”±keyç»‘å®šï¼Œå‘ç»™å“ªä¸ªæ­»ä¿¡é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">deadLetterRoutingKey</span>(<span style="color:#0ff;font-weight:bold">&#34;no.msg&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//æŒ‡å®šé˜Ÿåˆ—æœ€å¤§æ¥å—é•¿åº¦(æœ€å¤§æ¥å—æ¶ˆæ¯æ•°)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">maxLength</span>(5)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å£°æ˜æ­£å¸¸äº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> TopicExchange exchange(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ExchangeBuilder.<span style="color:#007f7f">topicExchange</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ­£å¸¸çš„é˜Ÿåˆ—å’Œäº¤æ¢æœºè¿›è¡Œç»‘å®š
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Binding binding(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> BindingBuilder.<span style="color:#007f7f">bind</span>(queue()).<span style="color:#007f7f">to</span>(exchange()).<span style="color:#007f7f">with</span>(<span style="color:#0ff;font-weight:bold">&#34;yes.#&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å£°æ˜æ­»ä¿¡é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue queue_dlx(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_queue_dlx&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å£°æ˜æ­»ä¿¡äº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> TopicExchange exchange_dlx(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ExchangeBuilder.<span style="color:#007f7f">topicExchange</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange_dlx&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ­»ä¿¡çš„é˜Ÿåˆ—å’Œäº¤æ¢æœºè¿›è¡Œç»‘å®š
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Binding binding_dlx(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> BindingBuilder.<span style="color:#007f7f">bind</span>(queue_dlx()).<span style="color:#007f7f">to</span>(exchange_dlx()).<span style="color:#007f7f">with</span>(<span style="color:#0ff;font-weight:bold">&#34;no.#&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç¼–å†™æ¥å£</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.GetMapping;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.RestController;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@RestController
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TopicController {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> RabbitTemplate rabbitTemplate;
</span></span><span style="display:flex;"><span>    @GetMapping(<span style="color:#0ff;font-weight:bold">&#34;/send&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> sendMessage(){
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å‘é€10æ¡ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 0; i &lt; 10; i++) {
</span></span><span style="display:flex;"><span>            rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;yes.msg&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;å‘å¸ƒäº†ä¸€æ¡æ¶ˆæ¯&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯åŠ¨æµ‹è¯•ï¼Œè°ƒç”¨æ¥å£å‘é€æ¶ˆæ¯ï¼Œä¸æ¶ˆè´¹æ¶ˆæ¯ï¼ŒæŸ¥çœ‹rabbitmqç®¡ç†é¡µé¢ï¼Œç”±äºè®¾ç½®é˜Ÿåˆ—æœ€å¤§é•¿åº¦ä¸º5ï¼Œæ‰€ä»¥æœ‰5æ¡æ¶ˆæ¯è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/03/03qmtJ.png" alt="03qmtJ.png"  />
</p>
<h3 id="3æ¶ˆæ¯è¢«æ‹’ç»">3ã€æ¶ˆæ¯è¢«æ‹’ç»<a hidden class="anchor" aria-hidden="true" href="#3æ¶ˆæ¯è¢«æ‹’ç»">#</a></h3>
<p>ç¼–å†™ç”Ÿäº§æ–¹é…ç½®ç±»</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.core.*;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Bean;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Configuration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> RabbitmqConfig {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å£°æ˜æ­£å¸¸é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue queue(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_queue&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//æ­£å¸¸é˜Ÿåˆ—å’Œæ­»ä¿¡äº¤æ¢æœºç»‘å®š
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">deadLetterExchange</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange_dlx&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//å’Œæ­»ä¿¡äº¤æ¢æœºçš„è·¯ç”±keyç»‘å®šï¼Œå‘ç»™å“ªä¸ªæ­»ä¿¡é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">deadLetterRoutingKey</span>(<span style="color:#0ff;font-weight:bold">&#34;no.msg&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å£°æ˜æ­£å¸¸äº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> TopicExchange exchange(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ExchangeBuilder.<span style="color:#007f7f">topicExchange</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ­£å¸¸çš„é˜Ÿåˆ—å’Œäº¤æ¢æœºè¿›è¡Œç»‘å®š
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Binding binding(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> BindingBuilder.<span style="color:#007f7f">bind</span>(queue()).<span style="color:#007f7f">to</span>(exchange()).<span style="color:#007f7f">with</span>(<span style="color:#0ff;font-weight:bold">&#34;yes.#&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å£°æ˜æ­»ä¿¡é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue queue_dlx(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_queue_dlx&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å£°æ˜æ­»ä¿¡äº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> TopicExchange exchange_dlx(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ExchangeBuilder.<span style="color:#007f7f">topicExchange</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange_dlx&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ­»ä¿¡çš„é˜Ÿåˆ—å’Œäº¤æ¢æœºè¿›è¡Œç»‘å®š
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Binding binding_dlx(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> BindingBuilder.<span style="color:#007f7f">bind</span>(queue_dlx()).<span style="color:#007f7f">to</span>(exchange_dlx()).<span style="color:#007f7f">with</span>(<span style="color:#0ff;font-weight:bold">&#34;no.#&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç¼–å†™æ¥å£</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.GetMapping;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.RestController;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@RestController
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TopicController {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> RabbitTemplate rabbitTemplate;
</span></span><span style="display:flex;"><span>    @GetMapping(<span style="color:#0ff;font-weight:bold">&#34;/send&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> sendMessage(){
</span></span><span style="display:flex;"><span>        rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;yes.msg&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;å‘å¸ƒäº†ä¸€æ¡æ¶ˆæ¯&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç¼–å†™ å¼€å¯æ‰‹åŠ¨ç¡®è®¤ï¼Œä»¥åŠè‡ªå®šä¹‰ç›‘å¬ç±»</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.shishiyi.listener.AckListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.core.AcknowledgeMode;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.connection.ConnectionFactory;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Bean;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Configuration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MessageListenerConfig {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> AckListener ackListener;
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> ConnectionFactory connectionFactory;
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> SimpleMessageListenerContainer simpleMessageListenerContainer(){
</span></span><span style="display:flex;"><span>        SimpleMessageListenerContainer simpleMessageListenerContainer = <span style="color:#fff;font-weight:bold">new</span> SimpleMessageListenerContainer(connectionFactory);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ¶ˆè´¹è€…æ”¹ä¸ºæ‰‹åŠ¨ç¡®è®¤ï¼Œé»˜è®¤ä¸ºè‡ªåŠ¨ç¡®è®¤
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        simpleMessageListenerContainer.<span style="color:#007f7f">setAcknowledgeMode</span>(AcknowledgeMode.<span style="color:#007f7f">MANUAL</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½®é˜Ÿåˆ—ï¼Œå‚æ•°å¯ä»¥è®¾ç½®å¤šä¸ªé˜Ÿåˆ—åç§°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        simpleMessageListenerContainer.<span style="color:#007f7f">setQueueNames</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_queue&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½®è‡ªå®šä¹‰çš„ç›‘å¬ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        simpleMessageListenerContainer.<span style="color:#007f7f">setMessageListener</span>(ackListener);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> simpleMessageListenerContainer;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ‰§è¡Œä¸šåŠ¡å‡ºé”™ï¼Œæ¶ˆæ¯è¢«æ‹’ç»(basic.reject/ basic.nackï¼‰å¹¶ä¸”requeue=false</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.rabbitmq.client.Channel;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.core.Message;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.listener.api.ChannelAwareMessageListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AckListener <span style="color:#fff;font-weight:bold">implements</span> ChannelAwareMessageListener {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> onMessage(Message message, Channel channel) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">long</span> deliveryTag = message.<span style="color:#007f7f">getMessageProperties</span>().<span style="color:#007f7f">getDeliveryTag</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//åˆ¤æ–­é˜Ÿåˆ—ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒé˜Ÿåˆ—ï¼Œæ¥æ‰§è¡Œä¸åŒçš„ä¸šåŠ¡å†…å®¹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#0ff;font-weight:bold">&#34;topic_queue&#34;</span>.<span style="color:#007f7f">equals</span>(message.<span style="color:#007f7f">getMessageProperties</span>().<span style="color:#007f7f">getConsumerQueue</span>())){
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//è½¬æ¢æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#fff;font-weight:bold">new</span> String(message.<span style="color:#007f7f">getBody</span>()));
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//å¤„ç†ä¸šåŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;å¤„ç†ä¸šåŠ¡.........&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//é™¤é›¶å‡ºé”™ï¼Œæ¨¡æ‹Ÿæ‰§è¡Œä¸šåŠ¡å‡ºå·®é”™
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">int</span> i = 1/0;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æ‰‹åŠ¨ç¡®è®¤ï¼Œç­¾æ”¶æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            channel.<span style="color:#007f7f">basicAck</span>(deliveryTag,<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;å‡ºç°å¼‚å¸¸ï¼Œæ‹’ç»ç­¾æ”¶æ¶ˆæ¯&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æ‹’ç»ç­¾æ”¶æ¶ˆæ¯ï¼Œä¸é‡å›é˜Ÿåˆ—requeue=false
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            channel.<span style="color:#007f7f">basicNack</span>(deliveryTag,<span style="color:#fff;font-weight:bold">true</span>,<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯åŠ¨æµ‹è¯•ï¼Œè°ƒç”¨æ¥å£å‘é€æ¶ˆæ¯ï¼ŒæŸ¥çœ‹rabbitmqç®¡ç†é¡µé¢ï¼Œç”±äºæ¶ˆè´¹è€…æ–¹å¤„ç†ä¸šåŠ¡å¤±è´¥äº§ç”Ÿé”™è¯¯ï¼Œæ‹’ç»ç­¾æ”¶æ¶ˆæ¯ï¼Œä¸”ä¸é‡å›é˜Ÿåˆ—ï¼Œåˆ™æ¶ˆæ¯è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/03/03XSte.png" alt="03XSte.png"  />
</p>
<h2 id="å»¶è¿Ÿé˜Ÿåˆ—">å»¶è¿Ÿé˜Ÿåˆ—<a hidden class="anchor" aria-hidden="true" href="#å»¶è¿Ÿé˜Ÿåˆ—">#</a></h2>
<p>RabbitMQå¾ˆé—æ†¾ä¸æ”¯æŒåŸç”Ÿçš„å»¶è¿Ÿé˜Ÿåˆ—ï¼Œä½†æ˜¯æˆ‘ä»¬ <strong>å¯ä»¥æ ¹æ®TTLè¿‡æœŸæ—¶é—´å’Œæ­»ä¿¡é˜Ÿåˆ—ç»„åˆå®ç°å»¶è¿Ÿé˜Ÿåˆ—</strong> åŠŸèƒ½</p>
<p>ç”Ÿäº§æ–¹çš„é…ç½®ç±»</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.shishiyi.config;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.core.*;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.connection.ConnectionFactory;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Bean;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Configuration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> RabbitmqConfig {
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å£°æ˜æ­£å¸¸é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue queue(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_queue&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">deadLetterExchange</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange_delay&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">deadLetterRoutingKey</span>(<span style="color:#0ff;font-weight:bold">&#34;time.msg&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//è®¾ç½®é˜Ÿåˆ—è¿‡æœŸæ—¶é—´,å³åˆ°è¾¾æŒ‡å®šæ—¶é—´å‘é€æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">ttl</span>(5000)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å£°æ˜æ­£å¸¸äº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> TopicExchange exchange(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ExchangeBuilder.<span style="color:#007f7f">topicExchange</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ­£å¸¸çš„é˜Ÿåˆ—å’Œäº¤æ¢æœºè¿›è¡Œç»‘å®š
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Binding binding(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> BindingBuilder.<span style="color:#007f7f">bind</span>(queue()).<span style="color:#007f7f">to</span>(exchange()).<span style="color:#007f7f">with</span>(<span style="color:#0ff;font-weight:bold">&#34;yes.#&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å£°æ˜å»¶è¿Ÿé˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Queue queue_delay(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> QueueBuilder.<span style="color:#007f7f">durable</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_queue_delay&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å£°æ˜å»¶è¿Ÿäº¤æ¢æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> TopicExchange exchange_delay(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ExchangeBuilder.<span style="color:#007f7f">topicExchange</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange_delay&#34;</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å»¶è¿Ÿçš„é˜Ÿåˆ—å’Œäº¤æ¢æœºè¿›è¡Œç»‘å®š
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Binding binding_delay(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> BindingBuilder.<span style="color:#007f7f">bind</span>(queue_delay()).<span style="color:#007f7f">to</span>(exchange_delay()).<span style="color:#007f7f">with</span>(<span style="color:#0ff;font-weight:bold">&#34;time.#&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç¼–å†™æ¥å£</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.GetMapping;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.web.bind.annotation.RestController;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@RestController
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TopicController {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> RabbitTemplate rabbitTemplate;
</span></span><span style="display:flex;"><span>    @GetMapping(<span style="color:#0ff;font-weight:bold">&#34;/send&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> sendMessage(){
</span></span><span style="display:flex;"><span>        SimpleDateFormat format = <span style="color:#fff;font-weight:bold">new</span> SimpleDateFormat(<span style="color:#0ff;font-weight:bold">&#34;HH:mm:ss&#34;</span>);
</span></span><span style="display:flex;"><span>        String current_time = format.<span style="color:#007f7f">format</span>(<span style="color:#fff;font-weight:bold">new</span> Date());
</span></span><span style="display:flex;"><span>        rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;topic_exchange&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;yes.msg&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;è¿™æ˜¯ä¸€æ¡å»¶æ—¶çš„æ¶ˆæ¯,å‘é€æ—¶é—´ä¸ºï¼š&#34;</span>+current_time);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç¼–å†™æ¶ˆè´¹è€…æ–¹</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.core.Message;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> DelayReceiver {
</span></span><span style="display:flex;"><span>    @RabbitListener(queues = <span style="color:#0ff;font-weight:bold">&#34;topic_queue_delay&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> queue(Message message){
</span></span><span style="display:flex;"><span>        SimpleDateFormat format = <span style="color:#fff;font-weight:bold">new</span> SimpleDateFormat(<span style="color:#0ff;font-weight:bold">&#34;HH:mm:ss&#34;</span>);
</span></span><span style="display:flex;"><span>        String current_time = format.<span style="color:#007f7f">format</span>(<span style="color:#fff;font-weight:bold">new</span> Date());
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;è·å–æ—¶é—´ï¼š&#34;</span>+current_time);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;ä»å»¶è¿Ÿé˜Ÿåˆ—æ”¶åˆ°çš„æ¶ˆæ¯ï¼š&#34;</span>+<span style="color:#fff;font-weight:bold">new</span> String(message.<span style="color:#007f7f">getBody</span>()));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯åŠ¨æµ‹è¯•ï¼Œè°ƒç”¨æ¥å£å‘é€æ¶ˆæ¯ï¼ŒæŸ¥çœ‹æ¶ˆè´¹è€…æ–¹æ§åˆ¶å°ï¼Œ5ç§’åä¼šæ‰“å°ä¸€æ¡æ¶ˆæ¯</p>
<p><img loading="lazy" src="https://s1.ax1x.com/2020/10/03/08Fv7j.png" alt="08Fv7j.png"  />
</p>
<h2 id="å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶æ–¹å¼">å»¶è¿Ÿé˜Ÿåˆ—ï¼ˆæ’ä»¶æ–¹å¼ï¼‰<a hidden class="anchor" aria-hidden="true" href="#å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶æ–¹å¼">#</a></h2>
<p><strong>æ³¨ï¼š</strong><code>å‰ææ˜¯é€šè¿‡docker å®‰è£…RabbitMQ-Management</code></p>
<p>ä¸‹è½½æ’ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wget https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/download/3.9.0/rabbitmq_delayed_message_exchange-3.9.0.ez
</span></span></code></pre></div><p>å¤åˆ¶åˆ°dockerå®¹å™¨MQçš„æ’ä»¶ç›®å½•ä¸‹</p>
<p>æ³¨ï¼šdocker cp æ–‡ä»¶ç›®å½•   dockerå®¹å™¨id:å®¹å™¨å†…çš„è·¯å¾„</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker cp rabbitmq_delayed_message_exchange-3.9.0.ez 724766fbe93a:/opt/rabbitmq/plugins
</span></span></code></pre></div><p>è¿›å…¥åˆ°å®¹å™¨ä¸­</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker <span style="color:#fff;font-weight:bold">exec</span> -it 724766fbe93a /bin/sh
</span></span></code></pre></div><p>å¼€å¯æ’ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>rabbitmq-plugins <span style="color:#fff;font-weight:bold">enable</span> rabbitmq_delayed_message_exchange
</span></span></code></pre></div><p>æŸ¥çœ‹æ’ä»¶æ˜¯å¦å®‰è£…</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>rabbitmq-plugins list
</span></span></code></pre></div><p><img loading="lazy" src="https://z3.ax1x.com/2021/11/21/IXv0XQ.png" alt=""  />
</p>
<h3 id="æ¶ˆè´¹è€…æ–¹ç»‘å®šæ–¹å¼å®ç°å»¶è¿Ÿé˜Ÿåˆ—">æ¶ˆè´¹è€…æ–¹ç»‘å®šæ–¹å¼å®ç°å»¶è¿Ÿé˜Ÿåˆ—<a hidden class="anchor" aria-hidden="true" href="#æ¶ˆè´¹è€…æ–¹ç»‘å®šæ–¹å¼å®ç°å»¶è¿Ÿé˜Ÿåˆ—">#</a></h3>
<p>åˆ›å»ºæ¥æ”¶æ¶ˆæ¯ç±»ï¼Œä½¿ç”¨@RabbitListeneræ³¨è§£ç›‘å¬æ¶ˆæ¯å¹¶åŒæ—¶ç»‘å®šqueueé˜Ÿåˆ—ã€exchangeäº¤æ¢æœºã€routing key</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MqReceiver {
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 * rabbitmq_delayed_message_exchangeæ’ä»¶ç‰ˆå»¶æ—¶é˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 * @param msg
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 * @param message
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 * @param channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 */</span>
</span></span><span style="display:flex;"><span>	@RabbitListener(bindings= @QueueBinding(value = @Queue(value = <span style="color:#0ff;font-weight:bold">&#34;delay.queue&#34;</span>, durable = <span style="color:#0ff;font-weight:bold">&#34;true&#34;</span>),
</span></span><span style="display:flex;"><span>			exchange = @Exchange(value = <span style="color:#0ff;font-weight:bold">&#34;delay.exchange&#34;</span>,type=ExchangeTypes.<span style="color:#007f7f">DIRECT</span>,
</span></span><span style="display:flex;"><span>			arguments=@Argument(name=<span style="color:#0ff;font-weight:bold">&#34;x-delayed-type&#34;</span>,value=<span style="color:#0ff;font-weight:bold">&#34;direct&#34;</span>),delayed=Exchange.<span style="color:#007f7f">TRUE</span>),
</span></span><span style="display:flex;"><span>			key =<span style="color:#0ff;font-weight:bold">&#34;delay.key&#34;</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> receiveDelay(String msg,Message message,Channel channel) {
</span></span><span style="display:flex;"><span>		System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(message.<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>		System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(message.<span style="color:#007f7f">getMessageProperties</span>().<span style="color:#007f7f">getReceivedDelay</span>());
</span></span><span style="display:flex;"><span>		System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;-----------æ”¶åˆ°æ¶ˆæ¯:&#34;</span>+msg+<span style="color:#0ff;font-weight:bold">&#34;,å½“å‰æ—¶é—´ï¼š&#34;</span>+<span style="color:#fff;font-weight:bold">new</span> Date());
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å‘é€æ¶ˆæ¯</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@RestController
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TestContoller {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	@Autowired
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">private</span> AmqpTemplate amqpTemplate;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	@GetMapping(value = <span style="color:#0ff;font-weight:bold">&#34;/send/{exp}&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">public</span> String test(@PathVariable(<span style="color:#0ff;font-weight:bold">&#34;exp&#34;</span>) Integer exp) {
</span></span><span style="display:flex;"><span>		String msg = <span style="color:#0ff;font-weight:bold">&#34;å‘é€æ—¶é—´ï¼š&#34;</span>+<span style="color:#fff;font-weight:bold">new</span> Date();
</span></span><span style="display:flex;"><span>		amqpTemplate.<span style="color:#007f7f">convertAndSend</span>(MQConstants.<span style="color:#007f7f">DELAY_EXCHANGE</span>,MQConstants.<span style="color:#007f7f">THEATRE_DELAY_KEY</span>,msg,message -&gt; {
</span></span><span style="display:flex;"><span>			message.<span style="color:#007f7f">getMessageProperties</span>().<span style="color:#007f7f">setDelay</span>(exp);<span style="color:#007f7f">// å•ä½ æ¯«ç§’
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>			<span style="color:#fff;font-weight:bold">return</span> message;
</span></span><span style="display:flex;"><span>			});
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;---------sendTime:&#34;</span>+<span style="color:#fff;font-weight:bold">new</span> Date();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åå¯åŠ¨é¡¹ç›®ï¼Œå¯ä»¥çœ‹åˆ°rabbitMQæ§åˆ¶å°æ˜¾ç¤ºå‡ºäº†å®šä¹‰çš„exchangeï¼Œæ³¨æ„typeæ˜¾ç¤ºä¸ºx-delayed-message</p>
<p><img loading="lazy" src="https://z3.ax1x.com/2021/11/21/IXxqVs.png" alt=""  />
</p>
<p><strong>æ³¨</strong>ï¼šæ³¨æ„æ’ä»¶ç‰ˆçš„æ­»ä¿¡é˜Ÿåˆ—Featureså­—æ®µä¸ä¼šæ˜¾ç¤ºDLX</p>
<p>è°ƒç”¨æ¥å£ï¼Œå®šä¹‰10ç§’çš„å»¶è¿Ÿ</p>
<p><img loading="lazy" src="https://z3.ax1x.com/2021/11/21/IXzEPx.png" alt=""  />
</p>
<h1 id="è¿æ¥å¤šä¸ªrabbitmqçš„æœåŠ¡æˆ–virtual-host">è¿æ¥å¤šä¸ªRabbitMqçš„æœåŠ¡æˆ–Virtual-Host<a hidden class="anchor" aria-hidden="true" href="#è¿æ¥å¤šä¸ªrabbitmqçš„æœåŠ¡æˆ–virtual-host">#</a></h1>
<p><code>æ³¨ï¼šä»¥ä¸‹ä¸ºspringbootæ–¹å¼</code></p>
<h2 id="è‡ªå®šä¹‰é…ç½®æ–‡ä»¶å†…å®¹">è‡ªå®šä¹‰é…ç½®æ–‡ä»¶å†…å®¹<a hidden class="anchor" aria-hidden="true" href="#è‡ªå®šä¹‰é…ç½®æ–‡ä»¶å†…å®¹">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="font-weight:bold">custom</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">rabbitmq</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">primary</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">host</span>: <span style="color:#ff0;font-weight:bold">192.168.1.101</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">3381</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">username</span>: admin <span style="color:#007f7f">#ç”¨æˆ·å</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">password</span>: rabbit_3381 <span style="color:#007f7f">#å¯†ç </span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">virtual-host</span>: rabbitMq_1    <span style="color:#007f7f">#è™šæ‹Ÿæœºåç§°</span>
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f">#æ¶ˆæ¯ç¡®è®¤é…ç½®é¡¹</span>
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f">#ç¡®è®¤æ¶ˆæ¯å·²å‘é€åˆ°äº¤æ¢æœº(Exchange)</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">publisher-confirm-type</span>: correlated
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f">#ç¡®è®¤æ¶ˆæ¯å·²å‘é€åˆ°é˜Ÿåˆ—(Queue)</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">publisher-returns</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">secondary</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">host</span>: <span style="color:#ff0;font-weight:bold">192.168.1.102</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">3381</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">username</span>: admin <span style="color:#007f7f">#ç”¨æˆ·å</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">password</span>: rabbit_3381 <span style="color:#007f7f">#å¯†ç </span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">virtual-host</span>: rabbitMq_2    <span style="color:#007f7f">#è™šæ‹Ÿæœºåç§°</span>
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f">#æ¶ˆæ¯ç¡®è®¤é…ç½®é¡¹</span>
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f">#ç¡®è®¤æ¶ˆæ¯å·²å‘é€åˆ°äº¤æ¢æœº(Exchange)</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">publisher-confirm-type</span>: correlated
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f">#ç¡®è®¤æ¶ˆæ¯å·²å‘é€åˆ°é˜Ÿåˆ—(Queue)</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">publisher-returns</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span></code></pre></div><h2 id="åˆ›å»ºå¯¹åº”çš„propertieså±æ€§ç±»">åˆ›å»ºå¯¹åº”çš„Propertieså±æ€§ç±»<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºå¯¹åº”çš„propertieså±æ€§ç±»">#</a></h2>
<blockquote>
<p>è®°å¾—åŠ ä¸Š@EnableConfigurationProperties({CustomRabbitProperties.class})</p>
</blockquote>
<p><strong>ä¸»è¦å†…å®¹å¦‚ä¸‹ï¼š</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> lombok.Data;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> lombok.ToString;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.boot.autoconfigure.amqp.RabbitProperties;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.boot.context.properties.ConfigurationProperties;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author ShaoYi
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description è‡ªå®šä¹‰Rabbitmqå±æ€§
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @createDate 2022å¹´08æœˆ05æ—¥ 16:35
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span>@Data
</span></span><span style="display:flex;"><span>@ToString
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span>@ConfigurationProperties(prefix = <span style="color:#0ff;font-weight:bold">&#34;custom.rabbitmq&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> CustomRabbitProperties {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">private</span> RabbitProperties primary;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">private</span> RabbitProperties secondary;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="rabbitmqé…ç½®ç±»">Rabbitmqé…ç½®ç±»<a hidden class="anchor" aria-hidden="true" href="#rabbitmqé…ç½®ç±»">#</a></h2>
<p><strong>ä¸»è¦å†…å®¹å¦‚ä¸‹ï¼š</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> lombok.extern.slf4j.Slf4j;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.annotation.EnableRabbit;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.config.SimpleRabbitListenerContainerFactory;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.connection.CachingConnectionFactory;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.connection.ConnectionFactory;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.beans.factory.annotation.Qualifier;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.boot.autoconfigure.amqp.SimpleRabbitListenerContainerFactoryConfigurer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Bean;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Configuration;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.context.annotation.Primary;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author ShaoYi
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description rabbitmqé…ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @createDate 2022å¹´08æœˆ05æ—¥ 17:48
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span>@Slf4j
</span></span><span style="display:flex;"><span>@EnableRabbit
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> RabbitmqConfiguration {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 * rabbitmqè¿æ¥å·¥å‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 * @param customRabbitProperties
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 * @return
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 */</span>
</span></span><span style="display:flex;"><span>	@Bean(name = <span style="color:#0ff;font-weight:bold">&#34;primaryConnectionFactory&#34;</span>)
</span></span><span style="display:flex;"><span>	@Primary
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">public</span> ConnectionFactory createPrimaryConnectionFactory(CustomRabbitProperties customRabbitProperties) {
</span></span><span style="display:flex;"><span>		CachingConnectionFactory primaryConnectionFactory = <span style="color:#fff;font-weight:bold">new</span> CachingConnectionFactory();
</span></span><span style="display:flex;"><span>		primaryConnectionFactory.<span style="color:#007f7f">setHost</span>(customRabbitProperties.<span style="color:#007f7f">getPrimary</span>().<span style="color:#007f7f">getHost</span>());
</span></span><span style="display:flex;"><span>		primaryConnectionFactory.<span style="color:#007f7f">setPort</span>(customRabbitProperties.<span style="color:#007f7f">getPrimary</span>().<span style="color:#007f7f">getPort</span>());
</span></span><span style="display:flex;"><span>		primaryConnectionFactory.<span style="color:#007f7f">setUsername</span>(customRabbitProperties.<span style="color:#007f7f">getPrimary</span>().<span style="color:#007f7f">getUsername</span>());
</span></span><span style="display:flex;"><span>		primaryConnectionFactory.<span style="color:#007f7f">setPassword</span>(customRabbitProperties.<span style="color:#007f7f">getPrimary</span>().<span style="color:#007f7f">getPassword</span>());
</span></span><span style="display:flex;"><span>		primaryConnectionFactory.<span style="color:#007f7f">setVirtualHost</span>(customRabbitProperties.<span style="color:#007f7f">getPrimary</span>().<span style="color:#007f7f">getVirtualHost</span>());
</span></span><span style="display:flex;"><span>		primaryConnectionFactory.<span style="color:#007f7f">setPublisherConfirmType</span>(customRabbitProperties.<span style="color:#007f7f">getPrimary</span>().<span style="color:#007f7f">getPublisherConfirmType</span>());
</span></span><span style="display:flex;"><span>		primaryConnectionFactory.<span style="color:#007f7f">setPublisherReturns</span>(customRabbitProperties.<span style="color:#007f7f">getPrimary</span>().<span style="color:#007f7f">isPublisherReturns</span>());
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> primaryConnectionFactory;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 * rabbitmqè¿æ¥å·¥å‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 * @param customRabbitProperties
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 * @return
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 */</span>
</span></span><span style="display:flex;"><span>	@Bean(name = <span style="color:#0ff;font-weight:bold">&#34;secondaryConnectionFactory&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">public</span> ConnectionFactory createSecondaryConnectionFactory(CustomRabbitProperties customRabbitProperties) {
</span></span><span style="display:flex;"><span>		CachingConnectionFactory secondaryConnectionFactory = <span style="color:#fff;font-weight:bold">new</span> CachingConnectionFactory();
</span></span><span style="display:flex;"><span>		secondaryConnectionFactory.<span style="color:#007f7f">setHost</span>(customRabbitProperties.<span style="color:#007f7f">getSecondary</span>().<span style="color:#007f7f">getHost</span>());
</span></span><span style="display:flex;"><span>		secondaryConnectionFactory.<span style="color:#007f7f">setPort</span>(customRabbitProperties.<span style="color:#007f7f">getSecondary</span>().<span style="color:#007f7f">getPort</span>());
</span></span><span style="display:flex;"><span>		secondaryConnectionFactory.<span style="color:#007f7f">setUsername</span>(customRabbitProperties.<span style="color:#007f7f">getSecondary</span>().<span style="color:#007f7f">getUsername</span>());
</span></span><span style="display:flex;"><span>		secondaryConnectionFactory.<span style="color:#007f7f">setPassword</span>(customRabbitProperties.<span style="color:#007f7f">getSecondary</span>().<span style="color:#007f7f">getPassword</span>());
</span></span><span style="display:flex;"><span>		secondaryConnectionFactory.<span style="color:#007f7f">setVirtualHost</span>(customRabbitProperties.<span style="color:#007f7f">getSecondary</span>().<span style="color:#007f7f">getVirtualHost</span>());
</span></span><span style="display:flex;"><span>		secondaryConnectionFactory.<span style="color:#007f7f">setPublisherConfirmType</span>(customRabbitProperties.<span style="color:#007f7f">getSecondary</span>().<span style="color:#007f7f">getPublisherConfirmType</span>());
</span></span><span style="display:flex;"><span>		secondaryConnectionFactory.<span style="color:#007f7f">setPublisherReturns</span>(customRabbitProperties.<span style="color:#007f7f">getSecondary</span>().<span style="color:#007f7f">isPublisherReturns</span>());
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> secondaryConnectionFactory;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 * primaryç”Ÿäº§è€…
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 */</span>
</span></span><span style="display:flex;"><span>	@Bean(name = <span style="color:#0ff;font-weight:bold">&#34;primaryRabbitTemplate&#34;</span>)
</span></span><span style="display:flex;"><span>	@Primary
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">public</span> RabbitTemplate primaryRabbitTemplate(@Qualifier(<span style="color:#0ff;font-weight:bold">&#34;primaryConnectionFactory&#34;</span>) ConnectionFactory connectionFactory) {
</span></span><span style="display:flex;"><span>		RabbitTemplate rabbitTemplate = <span style="color:#fff;font-weight:bold">new</span> RabbitTemplate();
</span></span><span style="display:flex;"><span>		rabbitTemplate.<span style="color:#007f7f">setConnectionFactory</span>(connectionFactory);
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">		 * ä»æ¶ˆè´¹è€…(Producer) åˆ° äº¤æ¢æœº(exchange) åˆ™ä¼šè¢«è°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">		 */</span>
</span></span><span style="display:flex;"><span>		rabbitTemplate.<span style="color:#007f7f">setConfirmCallback</span>((correlationData, ack, cause) -&gt; {
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;[primaryTemplate]ConfirmCallback ç›¸å…³æ•°æ®: &#34;</span>+correlationData);
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;[primaryTemplate]ConfirmCallback ç¡®è®¤æƒ…å†µ: &#34;</span>+ack);
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;[primaryTemplate]ConfirmCallback åŸå› : &#34;</span>+cause);
</span></span><span style="display:flex;"><span>		});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//è®¾ç½®å¼€å¯Mandatory,æ‰èƒ½è§¦å‘å›è°ƒå‡½æ•°,æ— è®ºæ¶ˆæ¯æ¨é€ç»“æœæ€ä¹ˆæ ·éƒ½å¼ºåˆ¶è°ƒç”¨å›è°ƒå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		rabbitTemplate.<span style="color:#007f7f">setMandatory</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">		 * ä»äº¤æ¢æœº(exchange)åˆ° é˜Ÿåˆ—(queue) åˆ™ä¼šè¢«è°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">		 */</span>
</span></span><span style="display:flex;"><span>		rabbitTemplate.<span style="color:#007f7f">setReturnCallback</span>((message, replyCode, replyText, exchange, routingKey) -&gt; {
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;[primaryTemplate]ReturnCallback æ¶ˆæ¯å†…å®¹: &#34;</span>+message);
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;[primaryTemplate]ReturnCallback å›åº”ç : &#34;</span>+replyCode);
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;[primaryTemplate]ReturnCallback å›åº”æ¶ˆæ¯: &#34;</span>+replyText);
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;[primaryTemplate]ReturnCallback äº¤æ¢æœº: &#34;</span>+exchange);
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;[primaryTemplate]ReturnCallback è·¯ç”±keyå€¼: &#34;</span>+routingKey);
</span></span><span style="display:flex;"><span>		});
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> rabbitTemplate;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 *   secondaryç”Ÿäº§è€…
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 */</span>
</span></span><span style="display:flex;"><span>	@Bean(name = <span style="color:#0ff;font-weight:bold">&#34;secondaryRabbitTemplate&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">public</span> RabbitTemplate secondaryRabbitTemplate(@Qualifier(<span style="color:#0ff;font-weight:bold">&#34;secondaryConnectionFactory&#34;</span>) ConnectionFactory connectionFactory) {
</span></span><span style="display:flex;"><span>		RabbitTemplate rabbitTemplate = <span style="color:#fff;font-weight:bold">new</span> RabbitTemplate();
</span></span><span style="display:flex;"><span>		rabbitTemplate.<span style="color:#007f7f">setConnectionFactory</span>(connectionFactory);
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">		 * ä»æ¶ˆè´¹è€…(Producer) åˆ° äº¤æ¢æœº(exchange) åˆ™ä¼šè¢«è°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">		 */</span>
</span></span><span style="display:flex;"><span>		rabbitTemplate.<span style="color:#007f7f">setConfirmCallback</span>((correlationData, ack, cause) -&gt; {
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;[secondaryTemplate]ConfirmCallback ç›¸å…³æ•°æ®: &#34;</span>+correlationData);
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;[secondaryTemplate]ConfirmCallback ç¡®è®¤æƒ…å†µ: &#34;</span>+ack);
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;[secondaryTemplate]ConfirmCallback åŸå› : &#34;</span>+cause);
</span></span><span style="display:flex;"><span>		});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//è®¾ç½®å¼€å¯Mandatory,æ‰èƒ½è§¦å‘å›è°ƒå‡½æ•°,æ— è®ºæ¶ˆæ¯æ¨é€ç»“æœæ€ä¹ˆæ ·éƒ½å¼ºåˆ¶è°ƒç”¨å›è°ƒå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		rabbitTemplate.<span style="color:#007f7f">setMandatory</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">		 * ä»äº¤æ¢æœº(exchange)åˆ° é˜Ÿåˆ—(queue) åˆ™ä¼šè¢«è°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">		 */</span>
</span></span><span style="display:flex;"><span>		rabbitTemplate.<span style="color:#007f7f">setReturnCallback</span>((message, replyCode, replyText, exchange, routingKey) -&gt; {
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;[secondaryTemplate]ReturnCallback æ¶ˆæ¯å†…å®¹: &#34;</span>+message);
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;[secondaryTemplate]ReturnCallback å›åº”ç : &#34;</span>+replyCode);
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;[secondaryTemplate]ReturnCallback å›åº”æ¶ˆæ¯: &#34;</span>+replyText);
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;[secondaryTemplate]ReturnCallback äº¤æ¢æœº: &#34;</span>+exchange);
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;[secondaryTemplate]ReturnCallback è·¯ç”±keyå€¼: &#34;</span>+routingKey);
</span></span><span style="display:flex;"><span>		});
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> rabbitTemplate;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 * primary æ¶ˆè´¹è€…
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 */</span>
</span></span><span style="display:flex;"><span>	@Bean(name = <span style="color:#0ff;font-weight:bold">&#34;primaryListenerFactory&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">public</span> SimpleRabbitListenerContainerFactory primaryListenerFactory(SimpleRabbitListenerContainerFactoryConfigurer configurer
</span></span><span style="display:flex;"><span>		, @Qualifier(<span style="color:#0ff;font-weight:bold">&#34;primaryConnectionFactory&#34;</span>) ConnectionFactory connectionFactory) {
</span></span><span style="display:flex;"><span>		SimpleRabbitListenerContainerFactory factory = <span style="color:#fff;font-weight:bold">new</span> SimpleRabbitListenerContainerFactory();
</span></span><span style="display:flex;"><span>		configurer.<span style="color:#007f7f">configure</span>(factory, connectionFactory);
</span></span><span style="display:flex;"><span>		factory.<span style="color:#007f7f">setConnectionFactory</span>(connectionFactory);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ¶ˆæ¯åºåˆ—åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		factory.<span style="color:#007f7f">setMessageConverter</span>(<span style="color:#fff;font-weight:bold">new</span> Jackson2JsonMessageConverter());
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> factory;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 * secondary æ¶ˆè´¹è€…
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">	 */</span>
</span></span><span style="display:flex;"><span>	@Bean(name = <span style="color:#0ff;font-weight:bold">&#34;secondaryListenerFactory&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">public</span> SimpleRabbitListenerContainerFactory secondaryListenerFactory(SimpleRabbitListenerContainerFactoryConfigurer configurer
</span></span><span style="display:flex;"><span>		, @Qualifier(<span style="color:#0ff;font-weight:bold">&#34;secondaryConnectionFactory&#34;</span>) ConnectionFactory connectionFactory) {
</span></span><span style="display:flex;"><span>		SimpleRabbitListenerContainerFactory factory = <span style="color:#fff;font-weight:bold">new</span> SimpleRabbitListenerContainerFactory();
</span></span><span style="display:flex;"><span>		configurer.<span style="color:#007f7f">configure</span>(factory, connectionFactory);
</span></span><span style="display:flex;"><span>		factory.<span style="color:#007f7f">setConnectionFactory</span>(connectionFactory);
</span></span><span style="display:flex;"><span>         <span style="color:#007f7f">//æ¶ˆæ¯åºåˆ—åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		factory.<span style="color:#007f7f">setMessageConverter</span>(<span style="color:#fff;font-weight:bold">new</span> Jackson2JsonMessageConverter());
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> factory;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="å‘é€æ¶ˆæ¯">å‘é€æ¶ˆæ¯<a hidden class="anchor" aria-hidden="true" href="#å‘é€æ¶ˆæ¯">#</a></h2>
<blockquote>
<p>æ ¹æ®é…ç½®å†…å®¹ï¼Œ@Qualifier æŒ‡å®šå‘é€å¯¹è±¡</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Autowired
</span></span><span style="display:flex;"><span>@Qualifier(<span style="color:#0ff;font-weight:bold">&#34;primaryRabbitTemplate&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span>  RabbitTemplate primaryRabbitTemplate;
</span></span></code></pre></div><h2 id="æ¥å—æ¶ˆæ¯">æ¥å—æ¶ˆæ¯<a hidden class="anchor" aria-hidden="true" href="#æ¥å—æ¶ˆæ¯">#</a></h2>
<blockquote>
<p>æ ¹æ®é…ç½®å†…å®¹ï¼ŒæŒ‡å®šç›‘å¬å™¨å·¥å‚ containerFactory = &ldquo;primaryListenerFactory&rdquo;</p>
<p>@RabbitHandlerï¼šå¦‚æœ@RabbitListeneræ³¨è§£åœ¨ç±»ä¸Šï¼Œå¯é€šè¿‡@RabbitHandleråœ¨ä¸åŒæ–¹æ³•ä¸Šï¼Œæ¥å—ä¸åŒå¯¹è±¡ç±»å‹æ¶ˆæ¯</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">  * æ¥å—æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">  * @param msg ä¸ºè‡ªå®šä¹‰çš„æ¶ˆæ¯å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">  */</span>
</span></span><span style="display:flex;"><span>@RabbitListener(containerFactory = <span style="color:#0ff;font-weight:bold">&#34;primaryListenerFactory&#34;</span>,
</span></span><span style="display:flex;"><span>	bindings= @QueueBinding(value = @Queue(value = prefix + <span style="color:#0ff;font-weight:bold">&#34;delay.queue&#34;</span>, durable = <span style="color:#0ff;font-weight:bold">&#34;true&#34;</span>),
</span></span><span style="display:flex;"><span>	exchange = @Exchange(value = prefix + <span style="color:#0ff;font-weight:bold">&#34;delay.exchange&#34;</span>,type= ExchangeTypes.<span style="color:#007f7f">DIRECT</span>,
</span></span><span style="display:flex;"><span>	arguments=@Argument(name=<span style="color:#0ff;font-weight:bold">&#34;x-delayed-type&#34;</span>,value=<span style="color:#0ff;font-weight:bold">&#34;direct&#34;</span>),delayed=Exchange.<span style="color:#007f7f">TRUE</span>),
</span></span><span style="display:flex;"><span>	key = prefix + <span style="color:#0ff;font-weight:bold">&#34;delay.key&#34;</span>))
</span></span><span style="display:flex;"><span>@RabbitHandler
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> receiveMessage (Message  msg) {
</span></span><span style="display:flex;"><span>    log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;æ¥å—çš„æ¶ˆæ¯ä¸º: {}&#34;</span>, msg);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://shaoyi.cc/tags/rabbitmq/">RabbitMQ</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://shaoyi.cc/posts/blog/docker/docker/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Docker å®¹å™¨</span>
  </a>
  <a class="next" href="http://shaoyi.cc/posts/blog/mq/activemq/activemq/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>æ¶ˆæ¯ä¸­é—´ä»¶ä¹‹ActiveMQ</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="http://shaoyi.cc/">ååä¹™çš„åšå®¢</a></span>
    <span>All Rights Reserved</span>
    <span>
        
        
        <a href="https://beian.miit.gov.cn/" rel="noopener noreferrer" target="_blank">é„‚ICPå¤‡2022008682å·-1</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script></body>

</html>
